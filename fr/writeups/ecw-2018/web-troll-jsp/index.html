<!DOCTYPE html>
<html lang="">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.80.0" />

    
    
    

<title>ECW 2018 - Web - Troll.JSP • Haax - Personal Blog</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ECW 2018 - Web - Troll.JSP"/>
<meta name="twitter:description" content="L’ECW 2018 est un challenge Jeopardy français organisé par le Pôle d’Excellence Cyber en partenariat avec la Région Bretagne, Airbus et Thales. &ldquo;Troll.JSP&rdquo; est un challenge basé sur l&rsquo;exploitation de la CVE-2017-5638 (Apache Struts) afin de changer la valeur d&rsquo;une variable de session."/>

<meta property="og:title" content="ECW 2018 - Web - Troll.JSP" />
<meta property="og:description" content="L’ECW 2018 est un challenge Jeopardy français organisé par le Pôle d’Excellence Cyber en partenariat avec la Région Bretagne, Airbus et Thales. &ldquo;Troll.JSP&rdquo; est un challenge basé sur l&rsquo;exploitation de la CVE-2017-5638 (Apache Struts) afin de changer la valeur d&rsquo;une variable de session." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://haax9.github.io/fr/writeups/ecw-2018/web-troll-jsp/" />
<meta property="article:published_time" content="2018-10-21T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-10-21T00:00:00+00:00" /><meta property="og:site_name" content="Haax - Personal Blog" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">




<link rel="stylesheet" href="/css/hyde-hyde.css">
<link rel="stylesheet" href="/css/custom.css">
<link rel="stylesheet" href="/css/print.min.css" media="print">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'G-GB7QC0EDF8', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GB7QC0EDF8', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    

</head>


    <body >
        
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      
      
          <a href="https://haax9.github.io">
          
          
          
          <div class="author-image">
            <img src="/img/icons/haax_logo.png" alt="Author Image" class="img--circle img--headshot element--center">
          </div>
          
          </a>
        
      <p class="site__description">
        <a href="https://haax9.github.io">
         Infosec articles &amp; CTF Writeups 
      </a>
      </p>
    </div>
    <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/fr/articles/">
						<span>Articles</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/fr/walkthroughs/">
						<span>Walkthroughs</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/fr/writeups/">
						<span>Write-Ups</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/fr/about/">
						<span>À Propos</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/fr/conferences/">
						<span>Conférences</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://cheatsheet.haax.fr">
						<span>Cheatsheet</span>
					</a>
				</li>
			 
		
		</li>
	</ul>
</div>

    <p>
      <section class="social">
	
	<a href="https://twitter.com/Haax9_" target="blank"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	&nbsp;<a href="https://github.com/Haax9" target="blank"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	&nbsp;<a href="https://gitlab.com/Haax" target="blank"><i class="fab fa-gitlab fa-lg" aria-hidden="true"></i></a>
	
	
	
  &nbsp;<a href="https://www.root-me.org/Haax" target="blank" class="linklogo"><div class="rootme_logo logohover"></div></a>
  
	
  &nbsp;<a href="http://www.aperikube.fr" target="blank" class="linklogo"><div class="aperikube_logo logohover"></div></a>
  
	
	&nbsp;<a href="mailto:haax@mdamail.ch" target="blank"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a>
	
	
	
	&nbsp;<a href="https://haax.fr/fr/index.xml" target="blank"><i class="fas fa-rss fa-lg" aria-hidden="true"></i></a>
	</section>

    </p>
    <div class="langSection">
      
      
      <a rel="alternate" href="/en/writeups/ecw-2018/web-troll-jsp/" hreflang="en" lang="en" class="langLink">English</a>
      <a rel="alternate" href="/en/writeups/ecw-2018/web-troll-jsp/" hreflang="en" lang="en"><img src="/img/icons/logo_drapeau_angleterre.png" alt="logo_angleterre" class="logoFlag"/></a>
      </div>
    <p class="copyright">
      &copy; 2023 Haax.
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Some Rights Reserved</a>.
      <br/>Built with
      <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
      
    </p>
  </div>
  <div>
  </div>
</div>

        <div class="content container">
            
    <article>
  <header>
    <h1>ECW 2018 - Web - Troll.JSP</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Oct 21, 2018
    
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 4 min read
</div>


  </header>
  <div class="post">
    <p>L’ECW 2018 est un challenge Jeopardy français organisé par le Pôle d’Excellence Cyber en partenariat avec la Région Bretagne, Airbus et Thales. &ldquo;Troll.JSP&rdquo; est un challenge basé sur l&rsquo;exploitation de la CVE-2017-5638 (Apache Struts) afin de changer la valeur d&rsquo;une variable de session.</p>
<p>Du 06/10 au 21/10 2018, il sert de pré-sélection pour l’épreuve finale de type Capture The Flag qui débutera le 21 novembre 2018 lors de la conférence de <!-- raw HTML omitted -->l’European Cyber Week<!-- raw HTML omitted --> à Rennes.</p>
<h2 id="découverte">Découverte</h2>
<p>Pas vraiment d&rsquo;énoncé pour ce challenge, puisque l&rsquo;image suivante était affichée en guide d&rsquo;énoncé. D&rsquo;un côté, pas étonnant vu le nom du challenge.</p>
<!-- raw HTML omitted -->
<p>On arrive donc sur une page, très épurée, ne contenant quasiment pas d&rsquo;informations.</p>
<!-- raw HTML omitted -->
<h2 id="recherche-dinformations-et-identification-de-la-vulnérabilité">Recherche d&rsquo;informations et identification de la vulnérabilité</h2>
<p>Première chose, on file dans les sources de la page. On y trouve le fichier &ldquo;debug.jsp&rdquo;.</p>
<pre><code>https://web125-trolljsp.challenge-ecw.fr/debug.jsp
</code></pre><!-- raw HTML omitted -->
<p>L&rsquo;accès à cette page offre plus de fonctionnalités. On y trouve notamment un onglet &ldquo;flag&rdquo;, avec un cadeau&hellip;</p>
<!-- raw HTML omitted -->
<p>Inutile de préciser que connaissant l&rsquo;essence de ce challenge, ce &ldquo;flag&rdquo; est un troll. Néanmoins, il permet d&rsquo;avancer dans le challenge puisqu&rsquo;une fois le hash MD5 cassé, on obtient l&rsquo;information suivante : <!-- raw HTML omitted -->&ldquo;swp&rdquo;<!-- raw HTML omitted -->.
Quelques recherches sur les extensions &ldquo;.swp&rdquo; nous amènent à penser qu&rsquo;un fichier swap important pour le challenge est disponible. Il n&rsquo;est pas rare que ces fichiers soient des fichiers cachés.
Quelques tests sont donc réalisés et assez rapidement on trouve le fichier <!-- raw HTML omitted -->&quot;.flag.jsp.swp&quot;<!-- raw HTML omitted -->.</p>
<pre><code>https://web125-trolljsp.challenge-ecw.fr/.flag.jsp.swp
</code></pre><!-- raw HTML omitted -->
<p>Trois points intéressants ici :</p>
<ul>
<li>le commentaire &ldquo;TODO change the flag&rdquo; ;</li>
<li>Un nouveau hash MD5 ;</li>
<li>Une variable de session, &ldquo;flag&rdquo; est affichée.</li>
</ul>
<p>Premièrement, le hash MD5. S&rsquo;il s&rsquo;agit du même fonctionnement que pour le premier, il pourrait également nous donner des informations&hellip; Et en effet, une fois décodé, on obtient la chaine <!-- raw HTML omitted -->&ldquo;equifax&rdquo;<!-- raw HTML omitted -->.
Quelques recherches au sujet de ce terme nous amènent à découvrir une histoire au sujet de l&rsquo;entreprise Equifax qui s&rsquo;est fait piraté en 2017. La cause ? Une vulnérabilité dans le framework <!-- raw HTML omitted -->Apache Struts (CVE-2017-5638)<!-- raw HTML omitted -->. Il semble donc que nous sachions par quel biais nous allons résoudre ce challenge&hellip;
Avant de partir dans l&rsquo;exploitation, un rapide point sur les deux autres éléments.</p>
<p>Il semble que la page affiche la valeur de la variable <!-- raw HTML omitted -->&ldquo;flag&rdquo;<!-- raw HTML omitted --> si la valeur de <!-- raw HTML omitted -->session.flag<!-- raw HTML omitted --> n&rsquo;est pas nulle. Sinon, on reçoit l&rsquo;affichage de trollFlag, qu&rsquo;on connaît déjà.
Qui plus est, dans la mesure où ce fichier est un fichier swap et qu&rsquo;il y a un commentaire &ldquo;TODO change the flag&rdquo; on peut supposer que dans le vrai fichier, le flag a été changé par le flag réel.
Ainsi, on a une ligne directrice ! Il faut trouver un moyen de modifier la valeur de <!-- raw HTML omitted -->session.flag<!-- raw HTML omitted -->.</p>
<h2 id="exploication---cve-2017-5638">Exploication - CVE-2017-5638</h2>
<p>Quelques recherches autour de cette vulnérabilité nous amènent sur les deux articles suivants, détaillant très bien l&rsquo;ensemble :</p>
<ul>
<li><a href="https://www.immun.io/blog/will-it-pwn-cve-2017-5638-remote-code-execution-in-apache-struts-2">https://www.immun.io/blog/will-it-pwn-cve-2017-5638-remote-code-execution-in-apache-struts-2</a></li>
<li><a href="https://blog.xmco.fr/12-questions-pour-mieux-comprendre-la-derniere-faille-struts/">https://blog.xmco.fr/12-questions-pour-mieux-comprendre-la-derniere-faille-struts/</a></li>
</ul>
<p>Très brièvement, l&rsquo;exploitation de cette dernière passe par l&rsquo;utilisation du header <!-- raw HTML omitted -->&ldquo;Content-Type&rdquo;<!-- raw HTML omitted --> des requêtes HTTP.</p>
<ul>
<li>Une requête HTTP de type &ldquo;multipart&rdquo; va être détectée par Struts ;</li>
<li>Celle ci sera envoyée au parseur Jakarta ;</li>
<li>Si une erreur survient lors du traitement (par exemple, un Content-Type invalide) le message d&rsquo;erreur généré contiendra l&rsquo;élément invalide ;</li>
<li>Afin d&rsquo;afficher l&rsquo;erreur à l&rsquo;utilisateur, une fonction non sécurisée, findText() est utilisée. Cette dernière va évaluer la chaine qui lui est passée. Ainsi, si une charge malveillante est placée à cet endroit, elle sera exécutée.</li>
</ul>
<p>Cette vulnérabilité permet en théorie de réaliser de l&rsquo;exécution de commande directement le serveur.
La charge malveillante utilisée dans beaucoup d&rsquo;exemples sur Internet est la suivante :</p>
<pre><code>Content-Type: %{(#_='multipart/form-data').(#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(@java.lang.Runtime@getRuntime().exec('curl localhost:8000'))}
</code></pre><p>Quelques tests ont permis de mettre en évidence le fait que ce type de charge ne fonctionnait pas sur le serveur. En effet, il semble que nous soyons face à un <!-- raw HTML omitted -->WAF (Web Application Firewall)<!-- raw HTML omitted --> qui va empêcher la requête de passer s&rsquo;il détecte certains éléments (des parenthèses ou des points, par exemple). Ainsi, il faudra se passer de ces éléments.</p>
<p>Qui plus, dans notre cas, nous cherchons à modifier la valeur d&rsquo;une variable de session. Pas besoin d&rsquo;exécuter du code via <code>@java.lang.Runtime@getRuntime()</code>.</p>
<p>On remarque que dans le payload, la première expression <code>(#_='multipart/form-data')</code> sert uniquement à passer la condition nécessaire au déclenchement de la vulnérabilité. Il s&rsquo;agit de l&rsquo;affectation d&rsquo;une chaine à une variable. N&rsquo;est ce pas exactement ce dont nous avons besoin ?</p>
<p>Quelques recherches et tests supplémentaires permettent de construire une charge utile de ce type :</p>
<pre><code>Content-Type: %{#session[&quot;flag&quot;]=&quot;multipart/form-data&quot;}
</code></pre><p>De cette façon, on satisfait la condition côté serveur, indiquant que la chaine &ldquo;multipart/form-data&rdquo; doit être présente  et on satisfait la condition côté application disant que la valeur de session.flag ne doit pas être nulle. De plus, aucun caractère interdit n&rsquo;est utilisé, le pare-feu n&rsquo;est donc pas déclenché.</p>
<h2 id="récupération-du-flag">Récupération du flag</h2>
<p>Afin de faire passer notre exploit, on intercepte une requête classique vers la page <!-- raw HTML omitted -->/flag.jsp<!-- raw HTML omitted --> à l&rsquo;aide de Burp, à laquelle on ajoute notre header malveillant.</p>
<!-- raw HTML omitted -->
<p>On observe que la requête est passée et que le flag retourné est différent&hellip; Challenge réussi ! ;)</p>
<h2 id="références">Références</h2>
<ul>
<li><!-- raw HTML omitted -->Will it pwn CVE-2017-5638 RCE in Apache Struts 2<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->12 questions pour mieux comprendre la dernière faille Struts<!-- raw HTML omitted --></li>
</ul>
  </div>
  

<div class="post--navigation post--navigation-single">
    
    <a href="/fr/writeups/ecw-2018/web-sysia/" class="post--navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">ECW 2018 - Web - SysIA</span>
    </a>
    
    
    <a href="/fr/writeups/ecw-2018/web-intrusion/" class="post--navigation-next">
      <span class="navigation-tittle">ECW 2018 - Web - Intrusion (5 challenges)</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    


</article>


        </div>
        
    
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GB7QC0EDF8', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"
  integrity="sha384-4oV5EgaV02iISL2ban6c/RmotsABqE4yZxZLcYMAdG7FAPsyHYAPpywE9PJo+Khy"
  crossorigin="anonymous">
</script>


    
        
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        
        <script type="text/javascript">
            hljs.configure({languages: []});
            hljs.initHighlightingOnLoad();
        </script>
        
        



    



    </body>
</html>
