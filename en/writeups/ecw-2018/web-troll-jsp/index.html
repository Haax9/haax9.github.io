<!DOCTYPE html>
<html lang="">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.80.0" />

    
    
    

<title>ECW 2018 - Web - Troll.JSP • Haax - Personal Blog</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ECW 2018 - Web - Troll.JSP"/>
<meta name="twitter:description" content="ECW 2018 is a French Jeopardy challenge organized by the PEC (French Pôle d&rsquo;Excellence Cyber) in partnership with the Bretagne county, Airbus and Thales. &ldquo;Troll.JSP&rdquo; is challenge based on the CVE-2017-5638 exploitation, executing code to change a session variable and then display the flag."/>

<meta property="og:title" content="ECW 2018 - Web - Troll.JSP" />
<meta property="og:description" content="ECW 2018 is a French Jeopardy challenge organized by the PEC (French Pôle d&rsquo;Excellence Cyber) in partnership with the Bretagne county, Airbus and Thales. &ldquo;Troll.JSP&rdquo; is challenge based on the CVE-2017-5638 exploitation, executing code to change a session variable and then display the flag." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://haax9.github.io/en/writeups/ecw-2018/web-troll-jsp/" />
<meta property="article:published_time" content="2018-10-21T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-10-21T00:00:00+00:00" /><meta property="og:site_name" content="Haax - Personal Blog" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">




<link rel="stylesheet" href="/css/hyde-hyde.css">
<link rel="stylesheet" href="/css/custom.css">
<link rel="stylesheet" href="/css/print.min.css" media="print">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'G-GB7QC0EDF8', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GB7QC0EDF8', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    

</head>


    <body >
        
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      
      
          <a href="https://haax9.github.io/en">
          
          
          
          <div class="author-image">
            <img src="/img/icons/haax_logo.png" alt="Author Image" class="img--circle img--headshot element--center">
          </div>
          
          </a>
        
      <p class="site__description">
        <a href="https://haax9.github.io">
         Infosec articles &amp; CTF Writeups 
      </a>
      </p>
    </div>
    <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/en/articles/">
						<span>Articles</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/en/walkthroughs/">
						<span>Walkthroughs</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/en/writeups/">
						<span>Write-Ups</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/en/about/">
						<span>About</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/en/conferences/">
						<span>Conferences</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://cheatsheet.haax.fr">
						<span>Cheatsheet</span>
					</a>
				</li>
			 
		
		</li>
	</ul>
</div>

    <p>
      <section class="social">
	
	<a href="https://twitter.com/Haax9_" target="blank"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	&nbsp;<a href="https://github.com/Haax9" target="blank"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	&nbsp;<a href="https://gitlab.com/Haax" target="blank"><i class="fab fa-gitlab fa-lg" aria-hidden="true"></i></a>
	
	
	
  &nbsp;<a href="https://www.root-me.org/Haax" target="blank" class="linklogo"><div class="rootme_logo logohover"></div></a>
  
	
  &nbsp;<a href="http://www.aperikube.fr" target="blank" class="linklogo"><div class="aperikube_logo logohover"></div></a>
  
	
	&nbsp;<a href="mailto:haax@mdamail.ch" target="blank"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a>
	
	
	
	&nbsp;<a href="https://haax.fr/en/index.xml" target="blank"><i class="fas fa-rss fa-lg" aria-hidden="true"></i></a>
	</section>

    </p>
    <div class="langSection">
      
      
      <a rel="alternate" href="/fr/writeups/ecw-2018/web-troll-jsp/" hreflang="fr" lang="fr" class="langLink">Français</a>
      <a rel="alternate" href="/fr/writeups/ecw-2018/web-troll-jsp/" hreflang="fr" lang="fr"><img src="/img/icons/logo_drapeau_france.png" alt="logo_fracne" class="logoFlag"/></a>
      </div>
    <p class="copyright">
      &copy; 2023 Haax.
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Some Rights Reserved</a>.
      <br/>Built with
      <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
      
    </p>
  </div>
  <div>
  </div>
</div>

        <div class="content container">
            
    <article>
  <header>
    <h1>ECW 2018 - Web - Troll.JSP</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Oct 21, 2018
    
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 4 min read
</div>


  </header>
  <div class="post">
    <p>ECW 2018 is a French Jeopardy challenge organized by the PEC (French Pôle d&rsquo;Excellence Cyber) in partnership with the Bretagne county, Airbus and Thales. &ldquo;Troll.JSP&rdquo; is challenge based on the CVE-2017-5638 exploitation, executing code to change a session variable and then display the flag.</p>
<p>From 06/10 to 21/10 2018, it will be used as a pre-selection for the final Capture The Flag event, which will start on 21 November 2018 at the <!-- raw HTML omitted -->European Cyber Week<!-- raw HTML omitted --> conference in Rennes.</p>
<h2 id="discovery">Discovery</h2>
<p>No statement for this challenge, since the following image was displayed as a statement guide. But no worries, look at the name of the challenge&hellip;</p>
<!-- raw HTML omitted -->
<p>We land on a page, very clear, containing almost no information.</p>
<!-- raw HTML omitted -->
<h2 id="information-gatherig-and-vulnerability-identification">Information gatherig and vulnerability identification</h2>
<p>First thing, we just go chek sources and we can see a &ldquo;debug.jsp&rdquo; file.</p>
<p>​<code>https://web125-trolljsp.challenge-ecw.fr/debug.jsp ​</code></p>
<!-- raw HTML omitted -->
<p>Accessing this page offer more features. There is a &ldquo;flag&rdquo; tab, with a gift&hellip;</p>
<!-- raw HTML omitted -->
<p>Needless to say, knowing the goal of this challenge, that this &ldquo;flag&rdquo; is a troll. Nevertheless, it allows us go ahead in the challenge because the MD5 gives us the following information : <!-- raw HTML omitted -->&ldquo;swp&rdquo;<!-- raw HTML omitted -->.
Some research on &ldquo;.swp&rdquo; extensions lead us to believe that an important swap file for the challenge is available.
Some tests are therefore performed and quite quickly we find the file <!-- raw HTML omitted -->&quot;.flag.jsp.swp&quot;<!-- raw HTML omitted -->.</p>
<p>​<code>https://web125-trolljsp.challenge-ecw.fr/.flag.jsp.swp ​</code></p>
<!-- raw HTML omitted -->
<p>Three interesting points here:</p>
<ul>
<li>the comment &ldquo;TODO change the flag&rdquo; ;</li>
<li>A new MD5 hash ;</li>
<li>A session variable, &ldquo;flag&rdquo; is displayed.</li>
</ul>
<p>First, the MD5 hash. If it is the same as the first one, it could also give us information&hellip;. And indeed, once broken, we obtain the string <!-- raw HTML omitted -->&ldquo;equifax&rdquo;<!-- raw HTML omitted -->.
Some research about this term lead us to discover a story about Equifax, a company that was hacked in 2017. The cause? A vulnerability in the <!-- raw HTML omitted -->Apache Struts (CVE-2017-5638) framework<!-- raw HTML omitted -->. So it seems that we know how we will solve this challenge&hellip;.
Before going to exploitation, a quick word on the two other elements.</p>
<p>It seems that the page displays the value of the variable <!-- raw HTML omitted -->&ldquo;flag&rdquo;<!-- raw HTML omitted --> if the value of <!-- raw HTML omitted -->session.flag<!-- raw HTML omitted --> is not null. Otherwise, we receive the display of trollFlag, which we already know.
Moreover, since this file is a swap file and there is a comment &ldquo;TODO change the flag&rdquo;, we can assume that in the real file, the flag has been changed by the real flag.
So we have a guideline ! A way must be found to modify the value of <!-- raw HTML omitted -->session.flag<!-- raw HTML omitted -->.</p>
<h2 id="exploication---cve-2017-5638">Exploication - CVE-2017-5638</h2>
<p>Some research around this vulnerability leads us to the following two articles, detailing very well the vulnerability :</p>
<ul>
<li><a href="https://www.immun.io/blog/will-it-pwn-cve-2017-5638-remote-code-execution-in-apache-struts-2">https://www.immun.io/blog/will-it-pwn-cve-2017-5638-remote-code-execution-in-apache-struts-2</a></li>
<li><a href="https://blog.xmco.fr/12-questions-pour-mieux-comprendre-la-derniere-faille-struts/">https://blog.xmco.fr/12-questions-pour-mieux-comprendre-la-derniere-faille-struts/</a></li>
</ul>
<p>Very quickly, the exploitation involves the use of the header <!-- raw HTML omitted -->&ldquo;Content-Type&rdquo;<!-- raw HTML omitted --> of HTTP requests.</p>
<ul>
<li>A &ldquo;multipart&rdquo; type HTTP request will be detected by Struts ;</li>
<li>This one will be sent to the Jakarta parser ;</li>
<li>If an error occurs during processing (for example, an invalid Content-Type) the error message generated will contain the invalid element ;</li>
<li>In order to display the error to the user, an unsafe function, findText() is used. This one will evaluate the string generated. Thus, if a malicious payload is ut there, it will be executed.</li>
</ul>
<p>This vulnerability allows in theory to execute commands directly on the server.
The malicious payload used in many examples on the Internet is :</p>
<p>​<code>Content-Type: %{(#_='multipart/form-data').(#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(@java.lang.Runtime@getRuntime().exec('curl localhost:8000'))} ​</code></p>
<p>Some tests have shown that this type of payload does not work on the server. Indeed, it seems that we are facing a <!-- raw HTML omitted -->WAF (Web Application Firewall)<!-- raw HTML omitted --> that will prevent the request from being processed if it detects special elements (parentheses or dots, for example).</p>
<p>Moreover, in our case, we are trying to modify the value of a session variable. No need to execute code with <code>@java.lang.Runtime@getRuntime()</code>.</p>
<p>Note that in the payload, the first expression <code>(#_='multipart/form-data')</code> is only used to pass the condition necessary to trigger the vulnerability. This is the assignment of a string to a variable. Isn&rsquo;t that exactly what we need?</p>
<p>Some additional research and tests allow us to build this payload :</p>
<p>​<code>Content-Type: %{#session[&quot;flag&quot;]=&quot;multipart/form-data&quot;} ​</code></p>
<p>In this way, we satisfy the server side condition, indicating that the &ldquo;multipart/form-data&rdquo; string must be present and we satisfy the application side condition saying that the session.flag value must not be null. In addition, no prohibited characters are used, so the firewall is not triggered.</p>
<h2 id="getting-the-flag">Getting the flag</h2>
<p>In order to pass our exploit, we intercept a classic request to the page <!-- raw HTML omitted -->/flag.jsp<!-- raw HTML omitted --> using Burp, to which we add our malicious header.</p>
<!-- raw HTML omitted -->
<p>We see that the request has been processed and that the returned flag is different&hellip; Solved challenge ;)</p>
<h2 id="references">References</h2>
<ul>
<li><!-- raw HTML omitted -->Will it pwn CVE-2017-5638 RCE in Apache Struts 2<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->12 questions pour mieux comprendre la dernière faille Struts<!-- raw HTML omitted --></li>
</ul>
<pre><code>
</code></pre>
  </div>
  

<div class="post--navigation post--navigation-single">
    
    <a href="/en/writeups/ecw-2018/web-sysia/" class="post--navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">ECW 2018 - Web - SysIA</span>
    </a>
    
    
    <a href="/en/writeups/ecw-2018/web-intrusion/" class="post--navigation-next">
      <span class="navigation-tittle">ECW 2018 - Web - Intrusion (5 challenges)</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    


</article>


        </div>
        
    
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GB7QC0EDF8', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"
  integrity="sha384-4oV5EgaV02iISL2ban6c/RmotsABqE4yZxZLcYMAdG7FAPsyHYAPpywE9PJo+Khy"
  crossorigin="anonymous">
</script>


    
        
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        
        <script type="text/javascript">
            hljs.configure({languages: []});
            hljs.initHighlightingOnLoad();
        </script>
        
        



    



    </body>
</html>
